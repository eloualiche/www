<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.361">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Erik Loualiche (eloualic@umn.edu)">
<meta name="dcterms.date" content="2023-06-22">

<title>Tips for using DataFrames.jl from R data.table</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>

      .quarto-title-block .quarto-title-banner h1,
      .quarto-title-block .quarto-title-banner h2,
      .quarto-title-block .quarto-title-banner h3,
      .quarto-title-block .quarto-title-banner h4,
      .quarto-title-block .quarto-title-banner h5,
      .quarto-title-block .quarto-title-banner h6
      {
        color: white;
      }

      .quarto-title-block .quarto-title-banner {
        color: white;
background: #014421;
      }
</style>


<link rel="stylesheet" href="style_jupyter.css">
</head>

<body class="floating">

<div id="quarto-search-results"></div>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title">Tips for using DataFrames.jl from R data.table</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
                      </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Erik Loualiche (eloualic@umn.edu) </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">June 22, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="99">
    <h2 id="toc-title">DataFrames.jl Cheatsheet</h2>
   
  <ul class="collapse">
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#installation" id="toc-installation" class="nav-link" data-scroll-target="#installation">Installation</a></li>
  <li><a href="#file-io" id="toc-file-io" class="nav-link" data-scroll-target="#file-io">File I/O</a>
  <ul class="collapse">
  <li><a href="#reading-data" id="toc-reading-data" class="nav-link" data-scroll-target="#reading-data">Reading Data</a></li>
  <li><a href="#writing-data" id="toc-writing-data" class="nav-link" data-scroll-target="#writing-data">Writing Data</a></li>
  <li><a href="#benchmarks" id="toc-benchmarks" class="nav-link" data-scroll-target="#benchmarks">(Benchmarks)</a></li>
  </ul></li>
  <li><a href="#inspecting-the-dataset" id="toc-inspecting-the-dataset" class="nav-link" data-scroll-target="#inspecting-the-dataset">Inspecting the dataset</a>
  <ul class="collapse">
  <li><a href="#sorting" id="toc-sorting" class="nav-link" data-scroll-target="#sorting">Sorting</a></li>
  <li><a href="#renaming" id="toc-renaming" class="nav-link" data-scroll-target="#renaming">Renaming</a></li>
  <li><a href="#summary-statistics" id="toc-summary-statistics" class="nav-link" data-scroll-target="#summary-statistics">Summary Statistics</a></li>
  <li><a href="#tabulations" id="toc-tabulations" class="nav-link" data-scroll-target="#tabulations">Tabulations</a></li>
  </ul></li>
  <li><a href="#filtering" id="toc-filtering" class="nav-link" data-scroll-target="#filtering">Filtering</a>
  <ul class="collapse">
  <li><a href="#subsetting-rows" id="toc-subsetting-rows" class="nav-link" data-scroll-target="#subsetting-rows">Subsetting rows</a></li>
  <li><a href="#dropping-duplicate-or-missing-values" id="toc-dropping-duplicate-or-missing-values" class="nav-link" data-scroll-target="#dropping-duplicate-or-missing-values">Dropping duplicate or missing values</a></li>
  <li><a href="#selecting-columns" id="toc-selecting-columns" class="nav-link" data-scroll-target="#selecting-columns">Selecting columns</a></li>
  <li><a href="#rows-and-columns" id="toc-rows-and-columns" class="nav-link" data-scroll-target="#rows-and-columns">Rows and columns</a></li>
  </ul></li>
  <li><a href="#creatingmodifying-variables" id="toc-creatingmodifying-variables" class="nav-link" data-scroll-target="#creatingmodifying-variables">Creating/modifying variables</a>
  <ul class="collapse">
  <li><a href="#basic-operations" id="toc-basic-operations" class="nav-link" data-scroll-target="#basic-operations">Basic operations</a></li>
  <li><a href="#grouped-operations" id="toc-grouped-operations" class="nav-link" data-scroll-target="#grouped-operations">Grouped operations</a></li>
  <li><a href="#leads-and-lags" id="toc-leads-and-lags" class="nav-link" data-scroll-target="#leads-and-lags">Leads and lags</a></li>
  <li><a href="#advanced-examples" id="toc-advanced-examples" class="nav-link" data-scroll-target="#advanced-examples">Advanced examples</a></li>
  </ul></li>
  <li><a href="#aggregating" id="toc-aggregating" class="nav-link" data-scroll-target="#aggregating">Aggregating</a></li>
  <li><a href="#reshape" id="toc-reshape" class="nav-link" data-scroll-target="#reshape">Reshape</a></li>
  <li><a href="#merge" id="toc-merge" class="nav-link" data-scroll-target="#merge">Merge</a>
  <ul class="collapse">
  <li><a href="#basic-merge" id="toc-basic-merge" class="nav-link" data-scroll-target="#basic-merge">Basic merge</a></li>
  <li><a href="#advanced-merging" id="toc-advanced-merging" class="nav-link" data-scroll-target="#advanced-merging">Advanced merging</a></li>
  </ul></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<section id="introduction" class="level1">
<h1>Introduction</h1>
<section id="resources" class="level4">
<h4 class="anchored" data-anchor-id="resources">Resources</h4>
<ul>
<li>I will mostly follow the excellent <a href="https://stata2r.github.io/data.table/#installation"><code>stata2r</code></a> as a template.</li>
<li>You can also have a look at some of the mappings in the <code>DataFrames.jl</code> <a href="https://dataframes.juliadata.org/stable/man/comparisons/">documentation</a></li>
<li>I have found this <a href="http://brooksandrew.github.io/simpleblog/articles/advanced-data-table/">guide</a> of data.table by Andrew Brooks very useful.</li>
</ul>
</section>
<section id="warnings" class="level4">
<h4 class="anchored" data-anchor-id="warnings">Warnings</h4>
<ul>
<li><strong>Missing Data.</strong> Dealing with missing data in julia requires to be explicit as most functions will return a <code>missing</code> value if an array includes a missing element. Some functions will error. I will try to point out the equivalence with the <code>R</code> code but be aware that the equivalence might not be always be strictly the same if you implement it. I show some of the examples on the <em>Freedman</em> dataset from the <code>car</code> package in R.</li>
<li><strong>Need improvement.</strong>
<ul>
<li>This is a first draft and there might be a few mistakes throughout the document. I am not a professional and I probably picked up bad habits here and there. Send me an email at <a href="mailto:eloualic@umn.edu">eloualic@umn.edu</a></li>
<li>A few specific sections could use some user inputs as the julia solutions were less than ideal: <a href="http://localhost:5005/#leads-and-lags"><em>Leads and lags</em></a>; <em>Dates</em>; <em>Complex merges</em></li>
</ul></li>
</ul>
<!-- ----------------------------------------------------------------------------------- -->
</section>
</section>
<section id="installation" class="level1">
<h1>Installation</h1>
<div class="grid">
<div class="g-col-6">
<p>Installation can sometime be challenging. This should not be an issue in <code>julia</code> here. We will mostly use the base <code>DataFrames</code> package and the convenient macros in the <code>DataFramesMeta</code> package. To read in data we will use the <code>CSV</code> package while julia supports many different file formats (see <a href="https://github.com/JuliaIO/FileIO.jl"><code>FileIO.jl</code></a>)</p>
</div>
<div class="g-col-6">
<p>Installation for <code>data.table</code> can be tricky especially if you want to benefit from the multicore features. I recommend that you look at the <a href="https://github.com/Rdatatable/data.table/wiki/Installation">installation wiki</a> for more details.</p>
</div>
</div>
<div class="grid">
<div class="g-col-6">
<div class="sourceCode" id="cb1"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb1-1"><a href="#cb1-1"></a><span class="im">import</span> <span class="bu">Pkg</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="bu">Pkg</span>.<span class="fu">add</span>(<span class="st">"DataFrames"</span>)</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="bu">Pkg</span>.<span class="fu">add</span>(<span class="st">"DataFramesMeta"</span>)</span>
<span id="cb1-4"><a href="#cb1-4"></a></span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="co"># Load the packages</span></span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="im">using</span> <span class="bu">DataFrames</span></span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="im">using</span> <span class="bu">DataFramesMeta</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="g-col-6">
<div class="sourceCode" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="fu">install.packages</span>(<span class="st">"data.table"</span>)</span>
<span id="cb2-2"><a href="#cb2-2"></a></span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="co"># latest development version that has passed all tests:</span></span>
<span id="cb2-4"><a href="#cb2-4"></a>data.table<span class="sc">::</span><span class="fu">update_dev_pkg</span>()</span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="co"># load the package</span></span>
<span id="cb2-6"><a href="#cb2-6"></a><span class="fu">library</span>(data.table)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>We will also use other packages to load auxiliary datasets, download data etc. I use the pipe macro in julia and the magrittr package in R to compose commands (though both packages have some amount of chaining built-in)</p>
<div class="grid">
<div class="g-col-6">
<div class="sourceCode" id="cb3"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb3-1"><a href="#cb3-1"></a><span class="bu">Pkg</span>.<span class="fu">add</span>(<span class="st">"CSV"</span>)</span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="bu">Pkg</span>.<span class="fu">add</span>(<span class="st">"ShiftedArrays"</span>) <span class="co"># lead/lag operators</span></span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="bu">Pkg</span>.<span class="fu">add</span>(<span class="st">"HTTP"</span>) <span class="co"># download utilities</span></span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="bu">Pkg</span>.<span class="fu">add</span>(<span class="st">"RDatasets"</span>) </span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="bu">Pkg</span>.<span class="fu">add</span>(<span class="st">"Pipe"</span>) <span class="co"># pipes</span></span>
<span id="cb3-6"><a href="#cb3-6"></a></span>
<span id="cb3-7"><a href="#cb3-7"></a><span class="co"># Load the packages</span></span>
<span id="cb3-8"><a href="#cb3-8"></a><span class="im">using</span> <span class="bu">HTTP</span></span>
<span id="cb3-9"><a href="#cb3-9"></a><span class="im">using</span> <span class="bu">CSV</span></span>
<span id="cb3-10"><a href="#cb3-10"></a><span class="im">using</span> <span class="bu">RDatasets</span></span>
<span id="cb3-11"><a href="#cb3-11"></a><span class="im">using</span> <span class="bu">Pipe</span></span>
<span id="cb3-12"><a href="#cb3-12"></a><span class="im">using</span> <span class="bu">ShiftedArrays</span></span>
<span id="cb3-13"><a href="#cb3-13"></a><span class="im">using</span> <span class="bu">Dates</span></span>
<span id="cb3-14"><a href="#cb3-14"></a></span>
<span id="cb3-15"><a href="#cb3-15"></a><span class="co"># We will need some statistical function from the Base package</span></span>
<span id="cb3-16"><a href="#cb3-16"></a><span class="im">import</span> <span class="bu">Statistics</span>: mean </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="g-col-6">
<div class="sourceCode" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="fu">install.packages</span>(<span class="st">"car"</span>)       <span class="co"># RDataset</span></span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="fu">install.packages</span>(<span class="st">"magrittr"</span>)  <span class="co"># pipes</span></span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="fu">install.packages</span>(<span class="st">"statar"</span>)    <span class="co"># stata-style data utilities</span></span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="fu">install.packages</span>(<span class="st">"lubridate"</span>) <span class="co"># date utilities</span></span>
<span id="cb4-5"><a href="#cb4-5"></a></span>
<span id="cb4-6"><a href="#cb4-6"></a><span class="co"># Load the package</span></span>
<span id="cb4-7"><a href="#cb4-7"></a><span class="fu">library</span>(car)</span>
<span id="cb4-8"><a href="#cb4-8"></a><span class="fu">library</span>(magrittr)</span>
<span id="cb4-9"><a href="#cb4-9"></a><span class="fu">library</span>(statar)</span>
<span id="cb4-10"><a href="#cb4-10"></a><span class="fu">library</span>(lubridate)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<!-- ----------------------------------------------------------------------------------- -->
<!-- ----------------------------------------------------------------------------------- -->
</section>
<section id="file-io" class="level1">
<h1>File I/O</h1>
<section id="reading-data" class="level2">
<h2 class="anchored" data-anchor-id="reading-data">Reading Data</h2>
<p>I am using the flight dataset to run most of the examples. This assumes your data is in a <code>csv</code> format.</p>
<p>There are options in both languages to read from more efficient formats like parquet. I have found that csv is both fast and idioproof and lends itself to quick manipulation on the shell if I need to do something quickly.</p>
<div class="grid">
<div class="g-col-6">
<p>In julia, the <code>CSV.jl</code> package does not allow to read directly from a url but we can use the <code>HTTP.jl</code> package to download the file.</p>
</div>
<div class="g-col-6">
<p>In R, you can directly read the dataset from an <code>url</code> using <code>fread</code> in <code>data.table</code>.</p>
</div>
</div>
<div class="grid">
<div class="g-col-6">
<div class="sourceCode" id="cb5"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb5-1"><a href="#cb5-1"></a><span class="co"># Flights data</span></span>
<span id="cb5-2"><a href="#cb5-2"></a>url_flights <span class="op">=</span> <span class="st">"https://raw.githubusercontent.com/Rdatatable/data.table/master/vignettes/flights14.csv"</span></span>
<span id="cb5-3"><a href="#cb5-3"></a>url_get <span class="op">=</span> HTTP.<span class="fu">get</span>(url_flights);</span>
<span id="cb5-4"><a href="#cb5-4"></a>dat <span class="op">=</span> CSV.<span class="fu">read</span>(url_get.body, DataFrame)</span>
<span id="cb5-5"><a href="#cb5-5"></a></span>
<span id="cb5-6"><a href="#cb5-6"></a><span class="co"># Freedman data</span></span>
<span id="cb5-7"><a href="#cb5-7"></a>dat_missing <span class="op">=</span> RDatasets.<span class="fu">dataset</span>(<span class="st">"car"</span>, <span class="st">"Freedman"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="g-col-6">
<div class="sourceCode" id="cb6"><pre class="sourceCode numberSource r code-overflow-scroll number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a><span class="co"># Flights data</span></span>
<span id="cb6-2"><a href="#cb6-2"></a>url_flights <span class="ot">=</span> <span class="st">"https://raw.githubusercontent.com/Rdatatable/data.table/master/vignettes/flights14.csv"</span></span>
<span id="cb6-3"><a href="#cb6-3"></a></span>
<span id="cb6-4"><a href="#cb6-4"></a>dat <span class="ot">=</span> <span class="fu">fread</span>(url_flights)</span>
<span id="cb6-5"><a href="#cb6-5"></a></span>
<span id="cb6-6"><a href="#cb6-6"></a><span class="co"># Freedman data</span></span>
<span id="cb6-7"><a href="#cb6-7"></a>dat_missing <span class="ot">=</span> <span class="fu">data.table</span>(Freedman) <span class="co"># load and convert to data.table</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="writing-data" class="level2">
<h2 class="anchored" data-anchor-id="writing-data">Writing Data</h2>
<div class="grid">
<div class="g-col-6">
<p>To write the file we use a similar function. It is also possible to save the file with compression</p>
</div>
<div class="g-col-6">
<p>Similarly <code>data.table</code> provides a write function with optional compression</p>
</div>
</div>
<div class="grid">
<div class="g-col-6">
<div class="sourceCode" id="cb7"><pre class="sourceCode numberSource julia code-overflow-scroll number-lines code-with-copy"><code class="sourceCode julia"><span id="cb7-1"><a href="#cb7-1"></a>CSV.<span class="fu">write</span>(<span class="st">"./data.csv"</span>, dat)</span>
<span id="cb7-2"><a href="#cb7-2"></a>CSV.<span class="fu">write</span>(<span class="st">"./data.csv.gz"</span>, dat; compress<span class="op">=</span><span class="cn">true</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If you want to set up a different compression algorithm (faster or more efficient) use <a href="https://github.com/JuliaIO/TranscodingStreams.jl"><code>TranscodingStreams.jl</code></a> with the appropriate codec. For example if you want to use zst you would do</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode numberSource julia code-overflow-scroll number-lines code-with-copy"><code class="sourceCode julia"><span id="cb8-1"><a href="#cb8-1"></a><span class="bu">Pkg</span>.<span class="fu">add</span>(<span class="st">"CodecZstd"</span>)</span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="im">using</span> <span class="bu">CodecZstd</span></span>
<span id="cb8-3"><a href="#cb8-3"></a><span class="fu">open</span>(ZstdCompressorStream, <span class="st">"./data.csv.zst"</span>, <span class="st">"w"</span>) <span class="cf">do</span> stream</span>
<span id="cb8-4"><a href="#cb8-4"></a>    CSV.<span class="fu">write</span>(stream, dat)</span>
<span id="cb8-5"><a href="#cb8-5"></a><span class="cf">end</span></span>
<span id="cb8-6"><a href="#cb8-6"></a></span>
<span id="cb8-7"><a href="#cb8-7"></a><span class="co"># similarly to read it back</span></span>
<span id="cb8-8"><a href="#cb8-8"></a>dat <span class="op">=</span> <span class="fu">open</span>(ZstdDecompressorStream, <span class="st">"./data.csv.zst"</span>, <span class="st">"r"</span>) <span class="cf">do</span> stream</span>
<span id="cb8-9"><a href="#cb8-9"></a>    CSV.<span class="fu">read</span>(stream, DataFrame)</span>
<span id="cb8-10"><a href="#cb8-10"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="g-col-6">
<div class="sourceCode" id="cb9"><pre class="sourceCode numberSource r code-overflow-scroll number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a><span class="fu">fwrite</span>(dat, <span class="st">"./data.csv"</span>)</span>
<span id="cb9-2"><a href="#cb9-2"></a><span class="fu">fwrite</span>(dat, <span class="st">"./data.csv.gz"</span>, <span class="at">compress=</span><span class="st">"gzip"</span>) <span class="co"># with compression</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="benchmarks" class="level2">
<h2 class="anchored" data-anchor-id="benchmarks">(Benchmarks)</h2>
<p>I would like to include a benchmark for one large file and compare csv intake to parquet.</p>
<!-- ----------------------------------------------------------------------------------- -->
<!-- ----------------------------------------------------------------------------------- -->
</section>
</section>
<section id="inspecting-the-dataset" class="level1">
<h1>Inspecting the dataset</h1>
<p>This is before we start filtering, collapsing, or merging the data.</p>
<section id="sorting" class="level2">
<h2 class="anchored" data-anchor-id="sorting">Sorting</h2>
<p>It is important to be able to sort rows. What are the most delayed flights, what about the most delayed flight on a specific day?</p>
<p><em>Note that the code changes the order “in-place” as it changes the dataset itself.</em></p>
<div class="grid">
<div class="g-col-6">
<p>The most basic task is to sort some columns with respect to a specific variable</p>
</div>
<div class="g-col-6">
<p>Similarly <code>data.table</code> provides a write function with optional compression</p>
</div>
</div>
<div class="grid">
<div class="g-col-6">
<div class="sourceCode" id="cb10"><pre class="sourceCode numberSource julia code-overflow-scroll number-lines code-with-copy"><code class="sourceCode julia"><span id="cb10-1"><a href="#cb10-1"></a><span class="fu">sort!</span>(dat, <span class="op">:</span>air_time)</span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="fu">sort!</span>(dat, [<span class="op">:</span>air_time, <span class="op">:</span>dest])</span>
<span id="cb10-3"><a href="#cb10-3"></a><span class="fu">sort!</span>(dat, <span class="op">:</span>air_time; rev<span class="op">=</span><span class="cn">true</span>)</span>
<span id="cb10-4"><a href="#cb10-4"></a><span class="fu">sort!</span>(dat, [<span class="fu">order</span>(<span class="op">:</span>air_time, rev<span class="op">=</span><span class="cn">true</span>), <span class="op">:</span>dest])</span>
<span id="cb10-5"><a href="#cb10-5"></a></span>
<span id="cb10-6"><a href="#cb10-6"></a><span class="co"># if you do not want to change the dataset in place</span></span>
<span id="cb10-7"><a href="#cb10-7"></a><span class="fu">sort</span>(dat, <span class="op">:</span>air_time)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="g-col-6">
<div class="sourceCode" id="cb11"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a><span class="fu">setorder</span>(dat, air_time) </span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="fu">setorder</span>(dat, air_time, dest) </span>
<span id="cb11-3"><a href="#cb11-3"></a><span class="fu">setorder</span>(dat, <span class="sc">-</span>air_time)</span>
<span id="cb11-4"><a href="#cb11-4"></a><span class="fu">setorder</span>(dat, <span class="sc">-</span>air_time, dest)</span>
<span id="cb11-5"><a href="#cb11-5"></a></span>
<span id="cb11-6"><a href="#cb11-6"></a><span class="co"># if you do not want to change the dataset in place</span></span>
<span id="cb11-7"><a href="#cb11-7"></a>dat[ <span class="fu">order</span>(air_time)] <span class="co"># etc.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>To reorder a dataset programmatically use the <code>setorderv</code> function</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a>col <span class="ot">=</span> <span class="st">"air_time"</span></span>
<span id="cb12-2"><a href="#cb12-2"></a><span class="fu">setorderv</span>(dat, col)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>If we want to reorder <strong>columns</strong></p>
<div class="grid">
<div class="g-col-6">
<div class="sourceCode" id="cb13"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb13-1"><a href="#cb13-1"></a><span class="fu">select!</span>(dat, [<span class="op">:</span>month, <span class="op">:</span>day], <span class="fu">Not</span>([<span class="op">:</span>month, <span class="op">:</span>day]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="g-col-6">
<div class="sourceCode" id="cb14"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a><span class="fu">setcolorder</span>(dat, <span class="fu">c</span>(<span class="st">"month"</span>, <span class="st">"day"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="renaming" class="level2">
<h2 class="anchored" data-anchor-id="renaming">Renaming</h2>
<p>Renaming does modify the dataset but it does not alter its data so we include it here.</p>
<div class="grid">
<div class="g-col-6">
<p>This is where I start leaning on the macros from <code>DataFramesMeta.jl</code></p>
</div>
<div class="g-col-6">
<p>Similarly <code>data.table</code> provides a write function with optional compression</p>
</div>
</div>
<div class="grid">
<div class="g-col-6">
<div class="sourceCode" id="cb15"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb15-1"><a href="#cb15-1"></a><span class="pp">@rename</span>!(dat, <span class="op">:</span>new_arr_delay <span class="op">=</span> <span class="op">:</span>arr_delay)</span>
<span id="cb15-2"><a href="#cb15-2"></a><span class="pp">@rename</span>!(dat, <span class="op">:</span>new_carrier <span class="op">=</span> <span class="op">:</span>carrier, <span class="op">:</span>new_origin  <span class="op">=</span> <span class="op">$</span><span class="st">"origin"</span>) </span>
<span id="cb15-3"><a href="#cb15-3"></a><span class="pp">@rename</span>(dat, <span class="op">:</span>new_arr_delay <span class="op">=</span> <span class="op">:</span>arr_delay) <span class="co"># not in place</span></span>
<span id="cb15-4"><a href="#cb15-4"></a></span>
<span id="cb15-5"><a href="#cb15-5"></a><span class="fu">rename!</span>(x <span class="op">-&gt;</span> <span class="fu">replace</span>(x, <span class="st">"arr_"</span> <span class="op">=&gt;</span> <span class="st">"arrival_"</span>), dat) <span class="co"># use the base DataFrames.jl function here</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="g-col-6">
<div class="sourceCode" id="cb16"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a><span class="fu">setnames</span>(dat, <span class="st">"new_arr_delay"</span>, <span class="st">"arrival_delay"</span>) </span>
<span id="cb16-2"><a href="#cb16-2"></a><span class="fu">setnames</span>(dat, <span class="fu">c</span>(<span class="st">"carrier"</span>,<span class="st">"origin"</span>), <span class="fu">c</span>(<span class="st">"new_carrier"</span>,<span class="st">"new_origin"</span>)) </span>
<span id="cb16-3"><a href="#cb16-3"></a></span>
<span id="cb16-4"><a href="#cb16-4"></a></span>
<span id="cb16-5"><a href="#cb16-5"></a><span class="fu">setnames</span>(dat, <span class="fu">gsub</span>(<span class="st">"arr_"</span>, <span class="st">"arrival_"</span>, <span class="fu">names</span>(dat)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="summary-statistics" class="level2">
<h2 class="anchored" data-anchor-id="summary-statistics">Summary Statistics</h2>
<div class="grid">
<div class="g-col-6">
<div class="sourceCode" id="cb17"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb17-1"><a href="#cb17-1"></a><span class="fu">describe</span>(dat)</span>
<span id="cb17-2"><a href="#cb17-2"></a><span class="fu">describe</span>(dat, <span class="op">:</span>arr_delay)</span>
<span id="cb17-3"><a href="#cb17-3"></a><span class="fu">describe</span>(dat, <span class="op">:</span>min, <span class="op">:</span>detailed, cols<span class="op">=:</span>arr_delay) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="g-col-6">
<div class="sourceCode" id="cb18"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a><span class="fu">sum_up</span>(dat) <span class="co"># from statar package</span></span>
<span id="cb18-2"><a href="#cb18-2"></a><span class="fu">sum_up</span>(dat, arr_delay)</span>
<span id="cb18-3"><a href="#cb18-3"></a><span class="fu">sum_up</span>(dat, arr_delay, <span class="at">d =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="tabulations" class="level2">
<h2 class="anchored" data-anchor-id="tabulations">Tabulations</h2>
<div class="grid">
<div class="g-col-6">
<div class="sourceCode" id="cb19"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb19-1"><a href="#cb19-1"></a>summary_var <span class="op">=</span> <span class="op">:</span>carrier <span class="co"># or [:carrier, :origin]</span></span>
<span id="cb19-2"><a href="#cb19-2"></a><span class="pp">@pipe</span> dat <span class="op">|&gt;</span> <span class="fu">groupby</span>(_, summary_var) <span class="op">|&gt;</span></span>
<span id="cb19-3"><a href="#cb19-3"></a>    <span class="fu">combine</span>(_, nrow <span class="op">=&gt;</span> <span class="op">:</span>Freq, proprow <span class="op">=&gt;</span> <span class="op">:</span>Percent) <span class="op">|&gt;</span></span>
<span id="cb19-4"><a href="#cb19-4"></a>    <span class="pp">@transform</span>(_, <span class="op">:</span>Cum <span class="op">=</span> <span class="fu">cumsum</span>(<span class="op">:</span>Percent))</span>
<span id="cb19-5"><a href="#cb19-5"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="g-col-6">
<div class="sourceCode" id="cb20"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a><span class="fu">tab</span>(dat, carrier) <span class="co"># from statar package</span></span>
<span id="cb20-2"><a href="#cb20-2"></a><span class="fu">tab</span>(dat, carrier, origin)</span>
<span id="cb20-3"><a href="#cb20-3"></a><span class="co"># data.table version</span></span>
<span id="cb20-4"><a href="#cb20-4"></a>dat[, .N, by <span class="ot">=</span> .(carrier, origin)][,</span>
<span id="cb20-5"><a href="#cb20-5"></a>    <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(<span class="at">Percent=</span><span class="dv">100</span><span class="sc">*</span>N<span class="sc">/</span><span class="fu">nrow</span>(dat), <span class="at">Cum=</span><span class="dv">100</span><span class="sc">*</span><span class="fu">cumsum</span>(N)<span class="sc">/</span><span class="fu">nrow</span>(dat)) ][]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<!-- ----------------------------------------------------------------------------------- -->
<!-- ----------------------------------------------------------------------------------- -->
</section>
</section>
<section id="filtering" class="level1">
<h1>Filtering</h1>
<section id="subsetting-rows" class="level2">
<h2 class="anchored" data-anchor-id="subsetting-rows">Subsetting rows</h2>
<section id="on-the-flights-data" class="level4">
<h4 class="anchored" data-anchor-id="on-the-flights-data">On the flights data</h4>
<div class="grid">
<div class="g-col-6">
<p>There are multiple options for filteringhis is where I start leaning on the macros from <code>DataFramesMeta.jl</code></p>
</div>
<div class="g-col-6">
<p>In <code>data.table</code> filtering is not in place and you will need to assign the dataset (to itself) for the changes to propagate.</p>
</div>
</div>
<div class="grid">
<div class="g-col-6">
<div class="sourceCode" id="cb21"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb21-1"><a href="#cb21-1"></a>dat[<span class="fl">1</span><span class="op">:</span><span class="fl">200</span>, <span class="op">:</span>]</span>
<span id="cb21-2"><a href="#cb21-2"></a><span class="fu">subset</span>(dat, <span class="op">:</span>day <span class="op">=&gt;</span> x <span class="op">-&gt;</span> x <span class="op">.&gt;</span> <span class="fl">5</span> <span class="op">.&amp;</span> x <span class="op">.&lt;</span> <span class="fl">10</span>) <span class="co"># from dataframes base</span></span>
<span id="cb21-3"><a href="#cb21-3"></a><span class="pp">@subset</span>(dat, <span class="op">:</span>day <span class="op">.&gt;</span> <span class="fl">5</span> <span class="op">.&amp;</span> <span class="op">:</span>day <span class="op">.&lt;</span> <span class="fl">10</span>) <span class="co"># note the `.` for broadcasting</span></span>
<span id="cb21-4"><a href="#cb21-4"></a><span class="pp">@rsubset</span>(dat, <span class="op">:</span>day <span class="op">&gt;</span> <span class="fl">5</span> <span class="op">&amp;</span> <span class="op">:</span>day <span class="op">&lt;</span> <span class="fl">10</span>)  <span class="co"># note the `r` for change by row</span></span>
<span id="cb21-5"><a href="#cb21-5"></a><span class="pp">@rsubset</span>!(dat, <span class="op">:</span>day <span class="op">&gt;</span> <span class="fl">5</span> <span class="op">&amp;</span> <span class="op">:</span>day <span class="op">&lt;</span> <span class="fl">10</span>) <span class="co"># change in place</span></span>
<span id="cb21-6"><a href="#cb21-6"></a><span class="pp">@rsubset</span>(dat, <span class="op">:</span>origin <span class="op">==</span> <span class="st">"LGA"</span>)</span>
<span id="cb21-7"><a href="#cb21-7"></a><span class="pp">@rsubset</span>(dat, <span class="fu">occursin</span>(<span class="st">r"^LG"</span>, <span class="op">:</span>origin))</span>
<span id="cb21-8"><a href="#cb21-8"></a><span class="pp">@rsubset</span>(dat, <span class="op">:</span>month <span class="op">∈</span> [<span class="fl">3</span>, <span class="fl">4</span>, <span class="fl">11</span>, <span class="fl">12</span>])</span>
<span id="cb21-9"><a href="#cb21-9"></a><span class="pp">@rsubset</span>(dat, <span class="op">:</span>origin <span class="op">∈</span> [<span class="st">"JFK"</span>, <span class="st">"LGA"</span>])</span>
<span id="cb21-10"><a href="#cb21-10"></a><span class="pp">@rsubset</span>(dat, <span class="op">:</span>month <span class="op">!=</span> <span class="fl">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="g-col-6">
<div class="sourceCode" id="cb22"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a>dat[<span class="dv">1</span><span class="sc">:</span><span class="dv">200</span>] </span>
<span id="cb22-2"><a href="#cb22-2"></a>dat[day <span class="sc">&gt;</span> <span class="dv">5</span> <span class="sc">&amp;</span> day <span class="sc">&lt;</span> <span class="dv">10</span>]        <span class="co"># filtering only</span></span>
<span id="cb22-3"><a href="#cb22-3"></a></span>
<span id="cb22-4"><a href="#cb22-4"></a></span>
<span id="cb22-5"><a href="#cb22-5"></a>dat <span class="ot">=</span> dat[day <span class="sc">&gt;</span> <span class="dv">5</span> <span class="sc">&amp;</span> day <span class="sc">&lt;</span> <span class="dv">10</span>]  <span class="co"># filtering and reassigning</span></span>
<span id="cb22-6"><a href="#cb22-6"></a>dat[origin<span class="sc">==</span><span class="st">"LGA"</span>]</span>
<span id="cb22-7"><a href="#cb22-7"></a>dat[origin <span class="sc">%like%</span> <span class="st">"^LG"</span>] </span>
<span id="cb22-8"><a href="#cb22-8"></a>dat[month <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">11</span>,<span class="dv">12</span>)] </span>
<span id="cb22-9"><a href="#cb22-9"></a>dat[origin <span class="sc">%chin%</span> <span class="fu">c</span>(<span class="st">"JFK"</span>,<span class="st">"LGA"</span>)] <span class="co"># %chin% is a fast %in% for characters </span></span>
<span id="cb22-10"><a href="#cb22-10"></a>dat[month<span class="sc">!=</span><span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="on-the-freedman-data-with-missing-values" class="level4">
<h4 class="anchored" data-anchor-id="on-the-freedman-data-with-missing-values">On the Freedman data (with missing values)</h4>
<p>In this case we need to be careful on how we deal with missing data. Note that to find the missings julia uses the <code>isequal</code> function (because <code>missing===missing</code> returns missing).</p>
<div class="grid">
<div class="g-col-6">
<div class="sourceCode" id="cb23"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb23-1"><a href="#cb23-1"></a><span class="fu">subset</span>(dat_missing, <span class="op">:</span>Population <span class="op">=&gt;</span> x <span class="op">-&gt;</span> x <span class="op">.&lt;</span> <span class="fl">1000</span>; skipmissing<span class="op">=</span><span class="cn">true</span>)</span>
<span id="cb23-2"><a href="#cb23-2"></a><span class="pp">@rsubset</span>(dat_missing, <span class="op">:</span>Population <span class="op">.&lt;</span> <span class="fl">1000</span>) <span class="co"># treats missing values as false by default</span></span>
<span id="cb23-3"><a href="#cb23-3"></a><span class="pp">@rsubset</span>(dat_missing, <span class="fu">isequal</span>(<span class="op">:</span>Population, <span class="cn">missing</span>) )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="g-col-6">
<div class="sourceCode" id="cb24"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1"></a>dat_missing[ population <span class="sc">&lt;</span> <span class="dv">1000</span> ]</span>
<span id="cb24-2"><a href="#cb24-2"></a></span>
<span id="cb24-3"><a href="#cb24-3"></a>dat_missing[<span class="fu">is.na</span>(population)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
</section>
<section id="dropping-duplicate-or-missing-values" class="level2">
<h2 class="anchored" data-anchor-id="dropping-duplicate-or-missing-values">Dropping duplicate or missing values</h2>
<section id="drop-duplicate-values" class="level4">
<h4 class="anchored" data-anchor-id="drop-duplicate-values">Drop duplicate values</h4>
<div class="grid">
<div class="g-col-6">
<div class="sourceCode" id="cb25"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb25-1"><a href="#cb25-1"></a><span class="fu">unique</span>(dat; keep<span class="op">=:</span>first)  <span class="co"># default</span></span>
<span id="cb25-2"><a href="#cb25-2"></a><span class="fu">unique!</span>(dat; keep<span class="op">=:</span>first) <span class="co"># in place</span></span>
<span id="cb25-3"><a href="#cb25-3"></a><span class="fu">unique</span>(dat; keep<span class="op">=:</span>noduplicates) <span class="co"># :last also an option</span></span>
<span id="cb25-4"><a href="#cb25-4"></a><span class="fu">unique</span>(dat, [<span class="op">:</span>month, <span class="op">:</span>day, <span class="op">:</span>carrier])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="g-col-6">
<div class="sourceCode" id="cb26"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a><span class="fu">unique</span>(dat) </span>
<span id="cb26-2"><a href="#cb26-2"></a>dat <span class="ot">=</span> <span class="fu">unique</span>(dat) </span>
<span id="cb26-3"><a href="#cb26-3"></a></span>
<span id="cb26-4"><a href="#cb26-4"></a><span class="fu">unique</span>(dat, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"month"</span>, <span class="st">"day"</span>, <span class="st">"carrier"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="drop-missing-values" class="level4">
<h4 class="anchored" data-anchor-id="drop-missing-values">Drop missing values</h4>
<div class="grid">
<div class="g-col-6">
<div class="sourceCode" id="cb27"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb27-1"><a href="#cb27-1"></a><span class="fu">dropmissing</span>(dat_missing)</span>
<span id="cb27-2"><a href="#cb27-2"></a><span class="fu">dropmissing!</span>(dat_missing) <span class="co"># in place</span></span>
<span id="cb27-3"><a href="#cb27-3"></a><span class="fu">dropmissing</span>(dat_missing, <span class="op">:</span>Population)</span>
<span id="cb27-4"><a href="#cb27-4"></a><span class="fu">dropmissing</span>(dat_missing, [<span class="op">:</span>Population, <span class="op">:</span>Density])</span>
<span id="cb27-5"><a href="#cb27-5"></a></span>
<span id="cb27-6"><a href="#cb27-6"></a><span class="co"># if the column type still include missing values convert the array to non missing types</span></span>
<span id="cb27-7"><a href="#cb27-7"></a><span class="fu">disallowmissing</span>(dat_missing)</span>
<span id="cb27-8"><a href="#cb27-8"></a><span class="fu">disallowmissing</span>(dat_missing, <span class="op">:</span>Density)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="g-col-6">
<div class="sourceCode" id="cb28"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1"></a><span class="fu">na.omit</span>(dat_missing) </span>
<span id="cb28-2"><a href="#cb28-2"></a>dat_missing <span class="ot">=</span> <span class="fu">na.omit</span>(dat_missing) </span>
<span id="cb28-3"><a href="#cb28-3"></a></span>
<span id="cb28-4"><a href="#cb28-4"></a>dat_missing[<span class="sc">!</span><span class="fu">is.na</span>(population)]</span>
<span id="cb28-5"><a href="#cb28-5"></a>dat_missing[<span class="sc">!</span><span class="fu">is.na</span>(population) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(density)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
</section>
<section id="selecting-columns" class="level2">
<h2 class="anchored" data-anchor-id="selecting-columns">Selecting columns</h2>
<div class="grid">
<div class="g-col-6">
<div class="sourceCode" id="cb29"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb29-1"><a href="#cb29-1"></a><span class="co"># select columns</span></span>
<span id="cb29-2"><a href="#cb29-2"></a><span class="fu">select</span>(dat, <span class="op">:</span>month, <span class="op">:</span>day, <span class="op">:</span>carrier)</span>
<span id="cb29-3"><a href="#cb29-3"></a><span class="fu">select!</span>(dat, <span class="op">:</span>month, <span class="op">:</span>day, <span class="op">:</span>carrier)   <span class="co"># in place</span></span>
<span id="cb29-4"><a href="#cb29-4"></a><span class="fu">select</span>(dat, <span class="st">"month"</span>, <span class="st">"day"</span>, <span class="st">"carrier"</span>) <span class="co"># also works</span></span>
<span id="cb29-5"><a href="#cb29-5"></a><span class="fu">select</span>(dat, <span class="st">r"_delay"</span>)</span>
<span id="cb29-6"><a href="#cb29-6"></a><span class="fu">select</span>(dat, .!(<span class="fu">eltype</span>.(<span class="fu">eachcol</span>(dat)) <span class="op">.&lt;:</span> <span class="dt">AbstractString</span>) )</span>
<span id="cb29-7"><a href="#cb29-7"></a><span class="fu">select</span>(dat_missing, (<span class="fu">eltype</span>.(<span class="fu">eachcol</span>(dat_missing)) <span class="op">.&lt;:</span> <span class="dt">Union</span>{<span class="dt">Missing</span>, <span class="dt">Int</span>}) ) <span class="co"># if some columns include missing</span></span>
<span id="cb29-8"><a href="#cb29-8"></a></span>
<span id="cb29-9"><a href="#cb29-9"></a><span class="co"># removing select columns</span></span>
<span id="cb29-10"><a href="#cb29-10"></a><span class="fu">select</span>(dat, <span class="fu">Not</span>([<span class="op">:</span>origin, <span class="op">:</span>dest]))</span>
<span id="cb29-11"><a href="#cb29-11"></a><span class="fu">select!</span>(dat, <span class="fu">Not</span>([<span class="op">:</span>origin, <span class="op">:</span>dest])) <span class="co"># in place</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="g-col-6">
<div class="sourceCode" id="cb30"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1"></a><span class="co"># select columns</span></span>
<span id="cb30-2"><a href="#cb30-2"></a>dat[, .(month, day, carrier)] </span>
<span id="cb30-3"><a href="#cb30-3"></a>dat <span class="ot">=</span> dat[, .(month, day, carrier)] <span class="co"># "in place"</span></span>
<span id="cb30-4"><a href="#cb30-4"></a>dat[, <span class="fu">c</span>(<span class="st">"month"</span>, <span class="st">"day"</span>, <span class="st">"carrier"</span>)] <span class="co"># same but programmatic</span></span>
<span id="cb30-5"><a href="#cb30-5"></a>dat[, .SD, .SDcols<span class="ot">=</span><span class="fu">patterns</span>(<span class="st">"*_delay"</span>)] <span class="co"># keep columns by matching</span></span>
<span id="cb30-6"><a href="#cb30-6"></a>dat[, .SD, .SDcols<span class="ot">=</span><span class="sc">!</span>is.character]       <span class="co"># keep columns by type</span></span>
<span id="cb30-7"><a href="#cb30-7"></a></span>
<span id="cb30-8"><a href="#cb30-8"></a></span>
<span id="cb30-9"><a href="#cb30-9"></a><span class="co"># removing select columns</span></span>
<span id="cb30-10"><a href="#cb30-10"></a>dat[, <span class="sc">-</span><span class="fu">c</span>(<span class="st">"origin"</span>, <span class="st">"dest"</span>)]</span>
<span id="cb30-11"><a href="#cb30-11"></a>dat[, <span class="fu">c</span>(<span class="st">"origin"</span>, <span class="st">"dest"</span>) <span class="sc">:</span><span class="er">=</span> <span class="cn">NULL</span>] <span class="co"># same, but in-place </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="rows-and-columns" class="level2">
<h2 class="anchored" data-anchor-id="rows-and-columns">Rows and columns</h2>
<div class="grid">
<div class="g-col-6">
<div class="sourceCode" id="cb31"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb31-1"><a href="#cb31-1"></a><span class="pp">@select</span>(<span class="pp">@rsubset</span>(dat, <span class="op">:</span>origin<span class="op">==</span><span class="st">"LGA"</span>), </span>
<span id="cb31-2"><a href="#cb31-2"></a>    <span class="op">:</span>month, <span class="op">:</span>day, <span class="op">:</span>carrier)</span>
<span id="cb31-3"><a href="#cb31-3"></a><span class="pp">@pipe</span> dat <span class="op">|&gt;</span> <span class="pp">@rsubset</span>(_, <span class="op">:</span>origin<span class="op">==</span><span class="st">"LGA"</span>) <span class="op">|&gt;</span> </span>
<span id="cb31-4"><a href="#cb31-4"></a>    <span class="pp">@select</span>(_, <span class="op">:</span>month, <span class="op">:</span>day, <span class="op">:</span>carrier)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="g-col-6">
<div class="sourceCode" id="cb32"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1"></a>dat[origin<span class="sc">==</span><span class="st">"LGA"</span>, .(month, day, carrier)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<!-- ----------------------------------------------------------------------------------- -->
</section>
</section>
<section id="creatingmodifying-variables" class="level1">
<h1>Creating/modifying variables</h1>
<section id="basic-operations" class="level2">
<h2 class="anchored" data-anchor-id="basic-operations">Basic operations</h2>
<div class="grid">
<div class="g-col-6">
<div class="sourceCode" id="cb33"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb33-1"><a href="#cb33-1"></a><span class="pp">@transform</span>!(dat, <span class="op">:</span>tot_delay <span class="op">=</span> <span class="op">:</span>dep_delay <span class="op">+</span> <span class="op">:</span>arr_delay)</span>
<span id="cb33-2"><a href="#cb33-2"></a><span class="pp">@rtransform</span>!(dat, <span class="op">:</span>segment <span class="op">=</span> <span class="op">:</span>origin <span class="op">*</span> <span class="op">:</span>dest) <span class="co"># rowwise operation</span></span>
<span id="cb33-3"><a href="#cb33-3"></a></span>
<span id="cb33-4"><a href="#cb33-4"></a><span class="co"># Programmatic version</span></span>
<span id="cb33-5"><a href="#cb33-5"></a>x <span class="op">=</span> <span class="st">"dep_delay"</span>; y <span class="op">=</span> <span class="st">"arr_delay"</span>; z <span class="op">=</span> <span class="st">"tot_delay"</span>;</span>
<span id="cb33-6"><a href="#cb33-6"></a><span class="pp">@transform</span>!(dat, <span class="op">$</span>z <span class="op">=</span> <span class="op">$</span>x <span class="op">+</span> <span class="op">$</span>y)</span>
<span id="cb33-7"><a href="#cb33-7"></a></span>
<span id="cb33-8"><a href="#cb33-8"></a><span class="co"># Conditional modification </span></span>
<span id="cb33-9"><a href="#cb33-9"></a>dat[dat.month<span class="op">.==</span><span class="fl">9</span>, <span class="op">:</span>distance] <span class="op">=</span> dat[dat.month<span class="op">.==</span><span class="fl">9</span>, <span class="op">:</span>distance] <span class="op">.+</span> <span class="fl">1</span>;</span>
<span id="cb33-10"><a href="#cb33-10"></a>dat[<span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="op">:</span>air_time] <span class="op">.=</span> <span class="fl">0</span>;</span>
<span id="cb33-11"><a href="#cb33-11"></a><span class="co"># Or with missing values</span></span>
<span id="cb33-12"><a href="#cb33-12"></a>dat_missing[<span class="fu">isequal</span>.(dat_missing.Population, <span class="cn">missing</span>), <span class="op">:</span>City] <span class="op">.=</span> <span class="st">"NOPOP"</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="g-col-6">
<div class="sourceCode" id="cb34"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1"></a>dat[, tot_delay <span class="sc">:</span><span class="er">=</span> dep_delay <span class="sc">+</span> arr_delay] </span>
<span id="cb34-2"><a href="#cb34-2"></a>dat[, segment <span class="sc">:</span><span class="er">=</span> <span class="fu">paste0</span>(origin, dest) ]</span>
<span id="cb34-3"><a href="#cb34-3"></a></span>
<span id="cb34-4"><a href="#cb34-4"></a><span class="co"># Programmatic version</span></span>
<span id="cb34-5"><a href="#cb34-5"></a>x <span class="ot">=</span> <span class="st">"dep_delay"</span>; y <span class="ot">=</span> <span class="st">"arr_delay"</span>; z <span class="ot">=</span> <span class="st">"tot_delay"</span></span>
<span id="cb34-6"><a href="#cb34-6"></a>dat[, <span class="fu">c</span>(z) <span class="sc">:</span><span class="er">=</span> <span class="fu">get</span>(x) <span class="sc">+</span> <span class="fu">get</span>(y) ]</span>
<span id="cb34-7"><a href="#cb34-7"></a></span>
<span id="cb34-8"><a href="#cb34-8"></a><span class="co"># Conditional modification </span></span>
<span id="cb34-9"><a href="#cb34-9"></a>dat[month<span class="sc">==</span><span class="dv">9</span>, distance <span class="sc">:</span><span class="er">=</span> distance <span class="sc">+</span> <span class="dv">1</span>]</span>
<span id="cb34-10"><a href="#cb34-10"></a>dat[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, origin <span class="sc">:</span><span class="er">=</span> <span class="st">"OBS"</span>]</span>
<span id="cb34-11"><a href="#cb34-11"></a><span class="co"># Or with missing values</span></span>
<span id="cb34-12"><a href="#cb34-12"></a>dat_missing[<span class="fu">is.na</span>(population), City <span class="sc">:</span><span class="er">=</span> <span class="st">"NOPOP"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="grouped-operations" class="level2">
<h2 class="anchored" data-anchor-id="grouped-operations">Grouped operations</h2>
<div class="grid">
<div class="g-col-6">
<div class="sourceCode" id="cb35"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb35-1"><a href="#cb35-1"></a><span class="pp">@pipe</span> dat <span class="op">|&gt;</span> <span class="fu">groupby</span>(_, <span class="op">:</span>carrier) <span class="op">|&gt;</span> </span>
<span id="cb35-2"><a href="#cb35-2"></a>    <span class="pp">@transform</span>!(_, <span class="op">:</span>avg_arr_delay <span class="op">=</span> <span class="fu">mean</span>(<span class="op">:</span>arr_delay)) <span class="co"># in place</span></span>
<span id="cb35-3"><a href="#cb35-3"></a><span class="pp">@pipe</span> dat <span class="op">|&gt;</span> <span class="fu">groupby</span>(_, <span class="op">:</span>carrier) <span class="op">|&gt;</span> </span>
<span id="cb35-4"><a href="#cb35-4"></a>    <span class="pp">@combine</span>(_, <span class="op">:</span>avg_arr_delay <span class="op">=</span> <span class="fu">mean</span>(<span class="op">:</span>arr_delay))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="g-col-6">
<div class="sourceCode" id="cb36"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1"></a>dat[, avg_arr_delay <span class="sc">:</span><span class="er">=</span> <span class="fu">mean</span>(arr_delay), by<span class="ot">=</span>carrier] </span>
<span id="cb36-2"><a href="#cb36-2"></a></span>
<span id="cb36-3"><a href="#cb36-3"></a>dat[, .(<span class="at">avg_arr_delay =</span> <span class="fu">mean</span>(arr_delay, <span class="at">na.rm=</span>T)), by<span class="ot">=</span>carrier]  <span class="co"># collapse see aggregation section below</span></span>
<span id="cb36-4"><a href="#cb36-4"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="leads-and-lags" class="level2">
<h2 class="anchored" data-anchor-id="leads-and-lags">Leads and lags</h2>
<section id="standard-leads-and-lags" class="level4">
<h4 class="anchored" data-anchor-id="standard-leads-and-lags">Standard leads and lags</h4>
<p>I work with shifts on dates here but the dataset is a full panel with consecutive dates so there is nothing special about the dates variable per-se. <em>It is easier to see this on a smaller dataset. So I aggregate the data to get the total monthly flights out of each origin airport (see last section).</em></p>
<div class="grid">
<div class="g-col-6">
<p>For leads and lags on arrays, I use the <code>ShiftedArrays</code> package which works fine for standard operations (read: as long as you are not dealing with dates).</p>
</div>
<div class="g-col-6">
<p>For standard leads and lags, it is faster to use the built-in <code>shift</code> function from data.table.</p>
</div>
</div>
<div class="grid">
<div class="g-col-6">
<div class="sourceCode" id="cb37"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb37-1"><a href="#cb37-1"></a>dat_shift <span class="op">=</span> <span class="fu">combine</span>(</span>
<span id="cb37-2"><a href="#cb37-2"></a>    <span class="fu">groupby</span>(dat, [<span class="op">:</span>origin, <span class="op">:</span>month]), </span>
<span id="cb37-3"><a href="#cb37-3"></a>    nrow <span class="op">=&gt;</span> <span class="op">:</span>N)</span>
<span id="cb37-4"><a href="#cb37-4"></a><span class="fu">sort!</span>(dat_shift, [<span class="op">:</span>origin, <span class="op">:</span>month])    </span>
<span id="cb37-5"><a href="#cb37-5"></a></span>
<span id="cb37-6"><a href="#cb37-6"></a><span class="pp">@transform</span>!(<span class="fu">groupby</span>(dat_shift, <span class="op">:</span>origin), </span>
<span id="cb37-7"><a href="#cb37-7"></a>    <span class="op">:</span>growth <span class="op">=</span> <span class="op">:</span>N <span class="op">./</span> ShiftedArrays.<span class="fu">lag</span>(<span class="op">:</span>N, <span class="fl">1</span>))</span>
<span id="cb37-8"><a href="#cb37-8"></a><span class="pp">@transform</span>!(<span class="fu">groupby</span>(dat_shift, <span class="op">:</span>origin), </span>
<span id="cb37-9"><a href="#cb37-9"></a>    <span class="op">:</span>growth_since_first <span class="op">=</span> <span class="op">:</span>N <span class="op">./</span> <span class="op">:</span>N[<span class="fl">1</span>] )</span>
<span id="cb37-10"><a href="#cb37-10"></a></span>
<span id="cb37-11"><a href="#cb37-11"></a><span class="co"># The following is probably not optimal; here are two versions</span></span>
<span id="cb37-12"><a href="#cb37-12"></a><span class="pp">@pipe</span> dat_shift <span class="op">|&gt;</span> </span>
<span id="cb37-13"><a href="#cb37-13"></a>    <span class="fu">groupby</span>(_, <span class="op">:</span>origin) <span class="op">|&gt;</span> <span class="pp">@subset</span>(_, <span class="fl">5</span> <span class="op">∈</span> <span class="op">:</span>month) <span class="op">|&gt;</span>  <span class="co"># this errors if month 5 is missing in a group</span></span>
<span id="cb37-14"><a href="#cb37-14"></a>    <span class="fu">groupby</span>(_, <span class="op">:</span>origin) <span class="op">|&gt;</span> <span class="pp">@transform</span>(_, <span class="op">:</span>growth_since_may <span class="op">=</span> <span class="op">:</span>N <span class="op">./</span> <span class="op">:</span>N[<span class="op">:</span>month<span class="op">.==</span><span class="fl">5</span>])</span>
<span id="cb37-15"><a href="#cb37-15"></a><span class="cf">for</span> subdf <span class="kw">in</span> <span class="fu">groupby</span>(dat_shift, <span class="op">:</span>origin)    </span>
<span id="cb37-16"><a href="#cb37-16"></a>    <span class="cf">if</span> <span class="fl">5</span> <span class="op">∈</span> subdf.month</span>
<span id="cb37-17"><a href="#cb37-17"></a>        <span class="pp">@transform</span>!(subdf, <span class="op">:</span>growth_since_may <span class="op">=</span> <span class="op">:</span>N <span class="op">./</span> <span class="op">:</span>N[<span class="op">:</span>month<span class="op">.==</span><span class="fl">5</span>])</span>
<span id="cb37-18"><a href="#cb37-18"></a>    <span class="cf">end</span></span>
<span id="cb37-19"><a href="#cb37-19"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="g-col-6">
<div class="sourceCode" id="cb38"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1"></a>dat_shift <span class="ot">=</span> dat[, .N, by <span class="ot">=</span> .(origin, month)]</span>
<span id="cb38-2"><a href="#cb38-2"></a><span class="fu">setorder</span>(dat_shift, origin, month)</span>
<span id="cb38-3"><a href="#cb38-3"></a></span>
<span id="cb38-4"><a href="#cb38-4"></a></span>
<span id="cb38-5"><a href="#cb38-5"></a></span>
<span id="cb38-6"><a href="#cb38-6"></a>dat_shift[, growth <span class="sc">:</span><span class="er">=</span> N<span class="sc">/</span><span class="fu">shift</span>(N, <span class="dv">1</span>), by <span class="ot">=</span> origin]</span>
<span id="cb38-7"><a href="#cb38-7"></a></span>
<span id="cb38-8"><a href="#cb38-8"></a>dat_shift[, growth_since_first <span class="sc">:</span><span class="er">=</span> N<span class="sc">/</span>N[<span class="dv">1</span>], by <span class="ot">=</span> origin] </span>
<span id="cb38-9"><a href="#cb38-9"></a></span>
<span id="cb38-10"><a href="#cb38-10"></a>dat_shift[, growth_since_may <span class="sc">:</span><span class="er">=</span> N<span class="sc">/</span>N[month<span class="sc">==</span><span class="dv">5</span>], by <span class="ot">=</span> origin]</span>
<span id="cb38-11"><a href="#cb38-11"></a>dat_shift[, growth_since_may <span class="sc">:</span><span class="er">=</span> .SD[[<span class="st">"N"</span>]]<span class="sc">/</span>.SD[month<span class="sc">==</span><span class="dv">5</span>][[<span class="st">"N"</span>]], </span>
<span id="cb38-12"><a href="#cb38-12"></a>    .SDcols <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"N"</span>, <span class="st">"month"</span>), by <span class="ot">=</span> origin]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="the-case-of-dates" class="level4">
<h4 class="anchored" data-anchor-id="the-case-of-dates">The case of dates</h4>
<p>Dates are messy (imho). Lagging a variable by three months in a monthly panel does not necessarily translate into shifting the data by 3 indices (if the panel is unbalanced for example). The correct date function should check that “shifting” by three months in April corresponds to January and not December (if January is missing).</p>
<div class="grid">
<div class="g-col-6">
<div class="sourceCode" id="cb39"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb39-1"><a href="#cb39-1"></a><span class="pp">@rtransform</span>!(dat, <span class="op">:</span>date <span class="op">=</span> <span class="fu">Date</span>(<span class="op">:</span>year, <span class="op">:</span>month, <span class="op">:</span>day) )</span>
<span id="cb39-2"><a href="#cb39-2"></a></span>
<span id="cb39-3"><a href="#cb39-3"></a></span>
<span id="cb39-4"><a href="#cb39-4"></a><span class="co"># Including time</span></span>
<span id="cb39-5"><a href="#cb39-5"></a><span class="pp">@rtransform</span>!(dat, <span class="op">:</span>date_time <span class="op">=</span> <span class="fu">DateTime</span>(<span class="op">:</span>year, <span class="op">:</span>month, <span class="op">:</span>day, <span class="op">:</span>hour) )</span>
<span id="cb39-6"><a href="#cb39-6"></a></span>
<span id="cb39-7"><a href="#cb39-7"></a><span class="pp">@rtransform</span>!(dat, <span class="op">:</span>date_y <span class="op">=</span> <span class="fu">year</span>(<span class="op">:</span>date))</span>
<span id="cb39-8"><a href="#cb39-8"></a><span class="pp">@rtransform</span>!(dat, <span class="op">:</span>f7d_date <span class="op">=</span> <span class="op">:</span>date <span class="op">+</span> <span class="bu">Dates</span>.<span class="fu">Day</span>(<span class="fl">7</span>))</span>
<span id="cb39-9"><a href="#cb39-9"></a><span class="pp">@rtransform</span>!(dat, <span class="op">:</span>l3m_date <span class="op">=</span> <span class="op">:</span>date <span class="op">-</span> <span class="bu">Dates</span>.<span class="fu">Month</span>(<span class="fl">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="g-col-6">
<div class="sourceCode" id="cb40"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1"></a><span class="co"># Make a date variable using data.table built-in IDate</span></span>
<span id="cb40-2"><a href="#cb40-2"></a>dat[, date <span class="sc">:</span><span class="er">=</span> <span class="fu">as.IDate</span>(<span class="fu">paste</span>(year, month, day, <span class="at">sep=</span><span class="st">'-'</span>))] </span>
<span id="cb40-3"><a href="#cb40-3"></a><span class="co"># It is usually faster to use lubridate parser </span></span>
<span id="cb40-4"><a href="#cb40-4"></a>dat[, date <span class="sc">:</span><span class="er">=</span> <span class="fu">parse_date_time2</span>(<span class="fu">paste</span>(year, month, day, <span class="at">sep=</span><span class="st">'-'</span>), <span class="st">"Y-m-d"</span>)]</span>
<span id="cb40-5"><a href="#cb40-5"></a>dat[, date_time <span class="sc">:</span><span class="er">=</span> <span class="fu">parse_date_time2</span>(<span class="fu">paste</span>(year, month, day, hour, <span class="at">sep=</span><span class="st">'-'</span>), <span class="st">"Y-m-d-H"</span>)]</span>
<span id="cb40-6"><a href="#cb40-6"></a></span>
<span id="cb40-7"><a href="#cb40-7"></a>dat[, date_y <span class="sc">:</span><span class="er">=</span> <span class="fu">year</span>(date)] <span class="co"># extract year</span></span>
<span id="cb40-8"><a href="#cb40-8"></a>dat[, f7d_date <span class="sc">:</span><span class="er">=</span> date <span class="sc">+</span> <span class="fu">days</span>(<span class="dv">7</span>) ]   <span class="co"># date in 7 days</span></span>
<span id="cb40-9"><a href="#cb40-9"></a>dat[, l3m_date <span class="sc">:</span><span class="er">=</span> date <span class="sc">-</span> <span class="fu">months</span>(<span class="dv">3</span>) ] <span class="co"># date three months ago</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Once we know how to lag dates, we would like to answer questions such as: <em>what was the average flight delay for each origin airport three months ago compared to today?</em> We will work with the aggregate delays by origins.</p>
<div class="grid">
<div class="g-col-6">
<p>In julia, the <code>ShiftedArrays</code> package does not support dates (See this post on <a href="https://discourse.julialang.org/t/ann-shiftedarrays-and-support-for-shiftedarrays-in-groupederrors/9162/2?u=piever">discourse</a> and this <a href="https://github.com/JuliaArrays/ShiftedArrays.jl/pull/37#issuecomment-623647440">issue</a>)</p>
<p>This is one of the most <em>annoying</em> thing when working with dates and panel data in julia. I have found that <code>PanelShift.jl</code> solves the problem but it is still in version <code>0.1.1</code> and it is unclear how many updates it is receiving. What is nice with julia is that you can simply loop over the data and do exactly what you want to do.</p>
</div>
<div class="g-col-6">
<p>In R, I use the utility <code>tlag</code> and <code>tlead</code> from <code>statar</code> which lags based on date intervals.</p>
</div>
</div>
<div class="grid">
<div class="g-col-6">
<div class="sourceCode" id="cb41"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb41-1"><a href="#cb41-1"></a><span class="pp">@rtransform</span>!(dat, <span class="op">:</span>date <span class="op">=</span> <span class="fu">Date</span>(<span class="op">:</span>year, <span class="op">:</span>month, <span class="op">:</span>day) )</span>
<span id="cb41-2"><a href="#cb41-2"></a>dat_shift <span class="op">=</span> <span class="pp">@combine</span>(<span class="fu">groupby</span>(dat, [<span class="op">:</span>origin, <span class="op">:</span>date]), <span class="op">:</span>arr_delay <span class="op">=</span> <span class="fu">mean</span>(<span class="op">:</span>arr_delay) )</span>
<span id="cb41-3"><a href="#cb41-3"></a></span>
<span id="cb41-4"><a href="#cb41-4"></a><span class="co"># I could not find a built-in function, but julia is amenable to loops</span></span>
<span id="cb41-5"><a href="#cb41-5"></a>dat_shift.l3m_arr_delay <span class="op">=</span> <span class="fu">Array</span><span class="dt">{Union{Missing,Float64}}</span>(<span class="cn">undef</span>, <span class="fu">nrow</span>(dat_shift));</span>
<span id="cb41-6"><a href="#cb41-6"></a><span class="cf">for</span> subdf <span class="kw">in</span> <span class="fu">groupby</span>(dat_shift, <span class="op">:</span>origin)    </span>
<span id="cb41-7"><a href="#cb41-7"></a>    <span class="cf">for</span> date_iter <span class="kw">in</span> subdf.date</span>
<span id="cb41-8"><a href="#cb41-8"></a>           idx <span class="op">=</span> <span class="fu">isequal</span>.(subdf.date, date_iter <span class="op">-</span> <span class="bu">Dates</span>.<span class="fu">Month</span>(<span class="fl">3</span>))</span>
<span id="cb41-9"><a href="#cb41-9"></a>        <span class="cf">if</span> (<span class="fu">sum</span>(idx)<span class="op">==</span><span class="fl">1</span>)</span>
<span id="cb41-10"><a href="#cb41-10"></a>            subdf[ subdf.date <span class="op">.==</span> date_iter, <span class="op">:</span>l3m_arr_delay] <span class="op">.=</span> subdf[idx, <span class="op">:</span>arr_delay]</span>
<span id="cb41-11"><a href="#cb41-11"></a>        <span class="cf">end</span></span>
<span id="cb41-12"><a href="#cb41-12"></a>    <span class="cf">end</span></span>
<span id="cb41-13"><a href="#cb41-13"></a><span class="cf">end</span></span>
<span id="cb41-14"><a href="#cb41-14"></a><span class="co"># sort(dat_shift, [:origin, :date])</span></span>
<span id="cb41-15"><a href="#cb41-15"></a></span>
<span id="cb41-16"><a href="#cb41-16"></a><span class="co"># using PanelShift</span></span>
<span id="cb41-17"><a href="#cb41-17"></a><span class="pp">@transform</span>!(<span class="fu">groupby</span>(dat_shift, <span class="op">:</span>origin),</span>
<span id="cb41-18"><a href="#cb41-18"></a>    <span class="op">:</span>l3m_arr_delay <span class="op">=</span> <span class="fu">tlag</span>(<span class="op">:</span>date, <span class="op">:</span>arr_delay, <span class="fu">Month</span>(<span class="fl">3</span>) ) )</span>
<span id="cb41-19"><a href="#cb41-19"></a><span class="fu">panellag!</span>(dat_shift, <span class="op">:</span>origin, <span class="op">:</span>date, </span>
<span id="cb41-20"><a href="#cb41-20"></a>    <span class="op">:</span>arr_delay, <span class="op">:</span>l3m_arr_delay, <span class="fu">Month</span>(<span class="fl">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="g-col-6">
<div class="sourceCode" id="cb42"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1"></a>dat_shift <span class="ot">=</span> dat[, .(<span class="at">arr_delay =</span> <span class="fu">mean</span>(arr_delay, <span class="at">na.rm=</span>T)), </span>
<span id="cb42-2"><a href="#cb42-2"></a>    by <span class="ot">=</span> .(origin, <span class="at">date=</span><span class="fu">parse_date_time2</span>(<span class="fu">paste</span>(year, month, day, <span class="at">sep=</span><span class="st">"-""), "</span>Y<span class="sc">-</span>m<span class="sc">-</span>d<span class="st">"))]</span></span>
<span id="cb42-3"><a href="#cb42-3"></a></span>
<span id="cb42-4"><a href="#cb42-4"></a><span class="st">dat_shift[, l3m_arr_delay := tlag(arr_delay, n=months(3), time=date), by = .(origin) ]</span></span>
<span id="cb42-5"><a href="#cb42-5"></a><span class="st"># setorder(dat_shift, origin, date)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
</section>
<section id="advanced-examples" class="level2">
<h2 class="anchored" data-anchor-id="advanced-examples">Advanced examples</h2>
<section id="applying-functions-to-multiple-variables" class="level4">
<h4 class="anchored" data-anchor-id="applying-functions-to-multiple-variables">Applying functions to multiple variables</h4>
<div class="grid">
<div class="g-col-6">

</div>
<div class="g-col-6">
<ul>
<li>Loops: if you have to use loops for convenience, data.table provides <code>set</code> which allows to change values withouth the overhead of data.table. The syntax is of the form <code>set(dat, i, j,value)</code>, where <code>i</code> is the row index, and <code>j</code> the column index (or name).</li>
</ul>
</div>
</div>
<div class="grid">
<div class="g-col-6">
<div class="sourceCode" id="cb43"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb43-1"><a href="#cb43-1"></a><span class="co"># Loops</span></span>
<span id="cb43-2"><a href="#cb43-2"></a><span class="cf">for</span> col <span class="kw">in</span> (<span class="op">:</span>tot_delay, <span class="op">:</span>dep_delay) </span>
<span id="cb43-3"><a href="#cb43-3"></a>    dat[<span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, col] <span class="op">=</span> <span class="op">-</span> dat[<span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, col]</span>
<span id="cb43-4"><a href="#cb43-4"></a><span class="cf">end</span></span>
<span id="cb43-5"><a href="#cb43-5"></a></span>
<span id="cb43-6"><a href="#cb43-6"></a><span class="co"># Control flows </span></span>
<span id="cb43-7"><a href="#cb43-7"></a><span class="pp">@rtransform</span>!(dat, <span class="op">:</span>arr_delay_penaly <span class="op">=</span> <span class="fu">ifelse</span>(<span class="op">:</span>arr_delay<span class="op">&gt;</span><span class="fl">12</span>, <span class="fl">1</span>, <span class="op">-</span><span class="fl">1</span>) )</span>
<span id="cb43-8"><a href="#cb43-8"></a><span class="pp">@rtransform</span>!(dat, <span class="op">:</span>arr_delay_penaly <span class="op">=</span> <span class="fu">ifelse</span>( <span class="co"># no case function in julia</span></span>
<span id="cb43-9"><a href="#cb43-9"></a>    <span class="op">:</span>arr_delay<span class="op">&gt;=</span><span class="fl">15</span>, <span class="fl">3</span>, </span>
<span id="cb43-10"><a href="#cb43-10"></a>    <span class="fu">ifelse</span>(<span class="op">:</span>arr_delay<span class="op">&gt;=</span><span class="fl">6</span>, <span class="fl">2</span>, </span>
<span id="cb43-11"><a href="#cb43-11"></a>    <span class="fu">ifelse</span>(<span class="op">:</span>arr_delay<span class="op">&gt;=</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span>) ) ) )     </span>
<span id="cb43-12"><a href="#cb43-12"></a></span>
<span id="cb43-13"><a href="#cb43-13"></a><span class="co"># Modify multiple variables at the same time (same function)</span></span>
<span id="cb43-14"><a href="#cb43-14"></a>cols <span class="op">=</span> [<span class="op">:</span>origin, <span class="op">:</span>dest]</span>
<span id="cb43-15"><a href="#cb43-15"></a><span class="fu">transform!</span>(dat, cols <span class="op">.=&gt;</span> (x <span class="op">-&gt;</span> x <span class="op">.*</span> <span class="st">"Airport"</span>) <span class="op">.=&gt;</span> cols)</span>
<span id="cb43-16"><a href="#cb43-16"></a></span>
<span id="cb43-17"><a href="#cb43-17"></a></span>
<span id="cb43-18"><a href="#cb43-18"></a><span class="co"># Function of multiple variables (by rows)</span></span>
<span id="cb43-19"><a href="#cb43-19"></a><span class="fu">ratio_airtime</span>(x<span class="op">::</span><span class="dt">NamedTuple</span>) <span class="op">=</span> (x[<span class="fl">1</span>] <span class="op">/</span>(x[<span class="fl">1</span>]<span class="op">+</span>x[<span class="fl">2</span>]))</span>
<span id="cb43-20"><a href="#cb43-20"></a><span class="pp">@rtransform</span>! dat <span class="op">:</span>frac_air <span class="op">=</span> <span class="fu">ratio_airtime</span>(<span class="fu">AsTable</span>([<span class="op">:</span>air_time, <span class="op">:</span>tot_delay]))</span>
<span id="cb43-21"><a href="#cb43-21"></a><span class="fu">ratio_airtime</span>(x, y) <span class="op">=</span> (x <span class="op">/</span>(x<span class="op">+</span>y))</span>
<span id="cb43-22"><a href="#cb43-22"></a><span class="fu">transform</span>(dat, [<span class="op">:</span>air_time, <span class="op">:</span>tot_delay] <span class="op">=&gt;</span> <span class="fu">ByRow</span>((ratio_airtime)) <span class="op">=&gt;</span> <span class="op">:</span>frac_air)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="g-col-6">
<div class="sourceCode" id="cb44"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1"></a><span class="co"># Loops</span></span>
<span id="cb44-2"><a href="#cb44-2"></a><span class="cf">for</span> (j <span class="cf">in</span> <span class="fu">c</span>(<span class="st">"tot_delay"</span>, <span class="st">"dep_delay"</span>)){ <span class="co"># (faster) loops </span></span>
<span id="cb44-3"><a href="#cb44-3"></a>    <span class="fu">set</span>(dat, <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="at">j=</span>j, <span class="at">value=</span><span class="sc">-</span>dat[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>][[j]])</span>
<span id="cb44-4"><a href="#cb44-4"></a>}</span>
<span id="cb44-5"><a href="#cb44-5"></a></span>
<span id="cb44-6"><a href="#cb44-6"></a><span class="co"># Control flows </span></span>
<span id="cb44-7"><a href="#cb44-7"></a>dat[, arr_delay_penaly <span class="sc">:</span><span class="er">=</span> <span class="fu">fifelse</span>(arr_delay<span class="sc">&gt;</span><span class="dv">12</span>, <span class="dv">1</span>, <span class="sc">-</span><span class="dv">1</span>) ]</span>
<span id="cb44-8"><a href="#cb44-8"></a>dat[, arr_delay_penaly <span class="sc">:</span><span class="er">=</span> <span class="fu">fcase</span>(arr_delay<span class="sc">&gt;=</span><span class="dv">15</span>, <span class="dv">3</span>, </span>
<span id="cb44-9"><a href="#cb44-9"></a>                                arr_delay<span class="sc">&gt;=</span><span class="dv">6</span>,  <span class="dv">2</span>,</span>
<span id="cb44-10"><a href="#cb44-10"></a>                                arr_delay<span class="sc">&gt;=</span><span class="dv">0</span>,  <span class="dv">1</span>,</span>
<span id="cb44-11"><a href="#cb44-11"></a>                                <span class="at">default =</span> <span class="dv">0</span>) ]</span>
<span id="cb44-12"><a href="#cb44-12"></a></span>
<span id="cb44-13"><a href="#cb44-13"></a><span class="co"># Modify multiple variables at the same time</span></span>
<span id="cb44-14"><a href="#cb44-14"></a>cols <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"origin"</span>, <span class="st">"dest"</span>)</span>
<span id="cb44-15"><a href="#cb44-15"></a>dat[, (cols) <span class="sc">:</span><span class="er">=</span> <span class="fu">lapply</span>(.SD, \(x) <span class="fu">paste</span>(x,<span class="st">"Airport"</span>)), </span>
<span id="cb44-16"><a href="#cb44-16"></a>    .SDcols <span class="ot">=</span> cols]   </span>
<span id="cb44-17"><a href="#cb44-17"></a></span>
<span id="cb44-18"><a href="#cb44-18"></a><span class="co"># Function of multiple variables </span></span>
<span id="cb44-19"><a href="#cb44-19"></a>dat[, tot_delay <span class="sc">:</span><span class="er">=</span> <span class="fu">rowSums</span>(.SD), .SDcols<span class="ot">=</span><span class="fu">patterns</span>(<span class="st">'*_delay'</span>)]</span>
<span id="cb44-20"><a href="#cb44-20"></a>ratio_airtime <span class="ot">=</span> <span class="cf">function</span>(air, tot)  (air <span class="sc">/</span>(air<span class="sc">+</span>tot))</span>
<span id="cb44-21"><a href="#cb44-21"></a><span class="co"># dat[, frac_air := ratio_airtime(air_time, tot_delay) ]</span></span>
<span id="cb44-22"><a href="#cb44-22"></a>dat[, frac_air <span class="sc">:</span><span class="er">=</span> <span class="fu">ratio_airtime</span>(air_time, tot_delay), by<span class="ot">=</span>.I] <span class="co"># row-wise operation</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="applying-complex-functions" class="level4">
<h4 class="anchored" data-anchor-id="applying-complex-functions">Applying complex functions</h4>
<div class="grid">
<div class="g-col-6">
<div class="sourceCode" id="cb45"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb45-1"><a href="#cb45-1"></a><span class="co"># Regressions by groups</span></span>
<span id="cb45-2"><a href="#cb45-2"></a><span class="co"># using FixedEffectModels</span></span>
<span id="cb45-3"><a href="#cb45-3"></a><span class="cf">for</span> subdf <span class="kw">in</span> <span class="fu">groupby</span>(dat, [<span class="op">:</span>year, <span class="op">:</span>month])</span>
<span id="cb45-4"><a href="#cb45-4"></a>    reg_res <span class="op">=</span> <span class="fu">reg</span>(subdf, <span class="pp">@formula</span>(tot_delay <span class="op">~</span> air_time))</span>
<span id="cb45-5"><a href="#cb45-5"></a>    subdf[<span class="op">:</span>, <span class="op">:</span>β] <span class="op">.=</span> <span class="fu">coef</span>(reg_res)[<span class="fl">2</span>]</span>
<span id="cb45-6"><a href="#cb45-6"></a>    subdf[<span class="op">:</span> , <span class="op">:</span>σ] <span class="op">.=</span> <span class="fu">sqrt</span>.(<span class="fu">vcov</span>(reg_res)[<span class="fl">2</span>,<span class="fl">2</span>])</span>
<span id="cb45-7"><a href="#cb45-7"></a><span class="cf">end</span></span>
<span id="cb45-8"><a href="#cb45-8"></a><span class="fu">select</span>(dat, [<span class="op">:</span>year, <span class="op">:</span>month, <span class="op">:</span>β, <span class="op">:</span>σ]) <span class="op">|&gt;</span> unique</span>
<span id="cb45-9"><a href="#cb45-9"></a></span>
<span id="cb45-10"><a href="#cb45-10"></a></span>
<span id="cb45-11"><a href="#cb45-11"></a></span>
<span id="cb45-12"><a href="#cb45-12"></a></span>
<span id="cb45-13"><a href="#cb45-13"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="g-col-6">
<div class="sourceCode" id="cb46"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1"></a><span class="co"># Regressions by groups</span></span>
<span id="cb46-2"><a href="#cb46-2"></a>dat_reg <span class="ot">=</span> dat[, .(</span>
<span id="cb46-3"><a href="#cb46-3"></a>    {</span>
<span id="cb46-4"><a href="#cb46-4"></a>        y <span class="ot">=</span> <span class="fu">as.matrix</span>(.SD[[<span class="st">"tot_delay"</span>]]) </span>
<span id="cb46-5"><a href="#cb46-5"></a>        x <span class="ot">=</span> <span class="fu">as.matrix</span>(<span class="fu">cbind</span>(<span class="dv">1</span>, .SD[[<span class="st">"air_time"</span>]]) )</span>
<span id="cb46-6"><a href="#cb46-6"></a>        reg_res <span class="ot">=</span> <span class="fu">lm.fit</span>(x, y)</span>
<span id="cb46-7"><a href="#cb46-7"></a>        b <span class="ot">=</span> <span class="fu">coefficients</span>(reg_res)[<span class="dv">2</span>]</span>
<span id="cb46-8"><a href="#cb46-8"></a>        se <span class="ot">=</span> <span class="fu">sqrt</span>(<span class="fu">sum</span>(reg_res[[<span class="st">"residuals"</span>]]<span class="sc">^</span><span class="dv">2</span>) <span class="sc">/</span> <span class="fu">var</span>(.SD[[<span class="st">"air_time"</span>]]) ) <span class="sc">/</span> .N</span>
<span id="cb46-9"><a href="#cb46-9"></a>        <span class="fu">c</span>(b,se)</span>
<span id="cb46-10"><a href="#cb46-10"></a>    }, </span>
<span id="cb46-11"><a href="#cb46-11"></a>    <span class="fu">seq</span>(<span class="dv">1</span>,<span class="dv">2</span>) ),</span>
<span id="cb46-12"><a href="#cb46-12"></a>    by <span class="ot">=</span> .(year, month) ]</span>
<span id="cb46-13"><a href="#cb46-13"></a><span class="fu">dcast</span>(dat_reg, year <span class="sc">+</span> month <span class="sc">~</span> V2, <span class="at">value.var=</span><span class="st">"V1"</span>) <span class="co"># anticipating on reshape section</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<!-- ----------------------------------------------------------------------------------- -->
<!-- ----------------------------------------------------------------------------------- -->
</section>
</section>
</section>
<section id="aggregating" class="level1">
<h1>Aggregating</h1>
<div class="grid">
<div class="g-col-6">
<div class="sourceCode" id="cb47"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb47-1"><a href="#cb47-1"></a><span class="pp">@combine</span>(dat, <span class="op">:</span>mean_dep_delay <span class="op">=</span> <span class="fu">mean</span>(<span class="op">:</span>dep_delay))</span>
<span id="cb47-2"><a href="#cb47-2"></a></span>
<span id="cb47-3"><a href="#cb47-3"></a><span class="pp">@combine</span>(dat, <span class="op">:</span>mean_dep_delay <span class="op">=</span> <span class="fu">mean</span>(<span class="op">:</span>dep_delay), <span class="op">:</span>mean_arr_delay <span class="op">=</span> <span class="fu">mean</span>(<span class="op">:</span>arr_delay))</span>
<span id="cb47-4"><a href="#cb47-4"></a><span class="fu">combine</span>(dat, [<span class="op">:</span>dep_delay, <span class="op">:</span>arr_delay] <span class="op">.=&gt;</span> mean <span class="op">.=&gt;</span> [<span class="op">:</span>mean_dep_delay, <span class="op">:</span>mean_arr_elay])</span>
<span id="cb47-5"><a href="#cb47-5"></a><span class="pp">@combine</span>(dat, <span class="op">$</span>AsTable <span class="op">=</span> <span class="fu">mean</span>.([<span class="op">:</span>dep_delay, <span class="op">:</span>arr_delay]))</span>
<span id="cb47-6"><a href="#cb47-6"></a><span class="pp">@combine</span>(dat, <span class="op">$</span>([<span class="op">:</span>dep_delay, <span class="op">:</span>arr_delay] <span class="op">.=&gt;</span> mean) )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="g-col-6">
<div class="sourceCode" id="cb48"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1"></a>dat[, <span class="fu">mean</span>(dep_delay)] <span class="co"># returns a scalar</span></span>
<span id="cb48-2"><a href="#cb48-2"></a>dat[, .(<span class="at">mean_ddel =</span> <span class="fu">mean</span>(dep_delay))] <span class="co"># returns a data.table</span></span>
<span id="cb48-3"><a href="#cb48-3"></a>dat[, .(<span class="at">mean_ddel=</span><span class="fu">mean</span>(dep_delay), <span class="at">mean_adel=</span><span class="fu">mean</span>(arr_delay))]</span>
<span id="cb48-4"><a href="#cb48-4"></a>dat[, <span class="fu">lapply</span>(.SD, mean), .SDcols<span class="ot">=</span><span class="fu">c</span>(<span class="st">'arr_delay'</span>,<span class="st">'dep_delay'</span>)] </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<!-- ----------------------------------------------------------------------------------- -->
<!-- ----------------------------------------------------------------------------------- -->
</section>
<section id="reshape" class="level1">
<h1>Reshape</h1>
<section id="wide-to-long" class="level4">
<h4 class="anchored" data-anchor-id="wide-to-long">Wide to long</h4>
<div class="grid">
<div class="g-col-6">
<p>Julia uses <code>stack</code> for going from wide to long.</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb49-1"><a href="#cb49-1"></a><span class="co"># It is easier if we give all the flights a unique identifier </span></span>
<span id="cb49-2"><a href="#cb49-2"></a><span class="pp">@transform</span>!(dat, <span class="op">:</span>uid <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu">nrow</span>(dat))</span>
<span id="cb49-3"><a href="#cb49-3"></a><span class="fu">stack</span>(dat, [<span class="op">:</span>dep_delay, <span class="op">:</span>arr_delay] )</span>
<span id="cb49-4"><a href="#cb49-4"></a><span class="fu">stack</span>(dat, <span class="st">r"_delay"</span>)</span>
<span id="cb49-5"><a href="#cb49-5"></a>dat_long <span class="op">=</span> <span class="fu">stack</span>(dat, </span>
<span id="cb49-6"><a href="#cb49-6"></a>    [<span class="op">:</span>dep_delay, <span class="op">:</span>arr_delay], </span>
<span id="cb49-7"><a href="#cb49-7"></a>    [<span class="op">:</span>uid, <span class="op">:</span>carrier, <span class="op">:</span>origin, <span class="op">:</span>dest])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="g-col-6">
<p>In data.table, we use the built-in tool <code>melt</code> for going from wide to long.</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1"></a><span class="co"># It is easier if we give all the flights a unique identifier </span></span>
<span id="cb50-2"><a href="#cb50-2"></a>dat[, uid <span class="sc">:</span><span class="er">=</span> <span class="fu">seq</span>(<span class="dv">1</span>, .N) ]</span>
<span id="cb50-3"><a href="#cb50-3"></a><span class="fu">melt</span>(dat, <span class="at">measure=</span><span class="fu">c</span>(<span class="st">"dep_delay"</span>, <span class="st">"arr_delay"</span>))</span>
<span id="cb50-4"><a href="#cb50-4"></a><span class="fu">melt</span>(dat, <span class="at">measure=</span><span class="fu">patterns</span>(<span class="st">'_delay'</span>))</span>
<span id="cb50-5"><a href="#cb50-5"></a>dat_long <span class="ot">=</span> <span class="fu">melt</span>(dat, </span>
<span id="cb50-6"><a href="#cb50-6"></a>    <span class="at">measure=</span><span class="fu">c</span>(<span class="st">"dep_delay"</span>, <span class="st">"arr_delay"</span>),</span>
<span id="cb50-7"><a href="#cb50-7"></a>    <span class="at">id.vars=</span><span class="fu">c</span>(<span class="st">"uid"</span>, <span class="st">"carrier"</span>, <span class="st">"origin"</span>, <span class="st">"dest"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="long-to-wide" class="level4">
<h4 class="anchored" data-anchor-id="long-to-wide">Long to wide</h4>
<div class="grid">
<div class="g-col-6">
<p>Julia uses <code>unstack</code> for going from long to wide.</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb51-1"><a href="#cb51-1"></a><span class="co"># We start with the long data from above</span></span>
<span id="cb51-2"><a href="#cb51-2"></a>dat_wide <span class="op">=</span> <span class="fu">unstack</span>(dat_long)</span>
<span id="cb51-3"><a href="#cb51-3"></a><span class="co"># If you only want to keep the id &amp; *_delay cols</span></span>
<span id="cb51-4"><a href="#cb51-4"></a><span class="fu">unstack</span>(dat_long, <span class="op">:</span>uid, <span class="op">:</span>variable, <span class="op">:</span>value)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="g-col-6">
<p>In data.table, we use the built-in tool <code>dcast</code> for going from long to wide.</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1"></a><span class="co"># We start with the long data from above</span></span>
<span id="cb52-2"><a href="#cb52-2"></a>dat_wide <span class="ot">=</span> <span class="fu">dcast</span>(dat_long, ... <span class="sc">~</span> variable)</span>
<span id="cb52-3"><a href="#cb52-3"></a><span class="co"># If you only want to keep the id &amp; *_delay cols</span></span>
<span id="cb52-4"><a href="#cb52-4"></a><span class="fu">dcast</span>(dat_long, uid <span class="sc">~</span> variable)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<!-- ----------------------------------------------------------------------------------- -->
<!-- ----------------------------------------------------------------------------------- -->
</section>
</section>
<section id="merge" class="level1">
<h1>Merge</h1>
<section id="basic-merge" class="level2">
<h2 class="anchored" data-anchor-id="basic-merge">Basic merge</h2>
<div class="grid">
<div class="g-col-6">
<div class="sourceCode" id="cb53"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb53-1"><a href="#cb53-1"></a><span class="co"># Load second dataset</span></span>
<span id="cb53-2"><a href="#cb53-2"></a>dat_airports <span class="op">=</span> CSV.<span class="fu">read</span>(</span>
<span id="cb53-3"><a href="#cb53-3"></a>    HTTP.<span class="fu">get</span>(<span class="st">"https://vincentarelbundock.github.io/Rdatasets/csv/nycflights13/airports.csv"</span>).body,</span>
<span id="cb53-4"><a href="#cb53-4"></a>    DataFrame) </span>
<span id="cb53-5"><a href="#cb53-5"></a></span>
<span id="cb53-6"><a href="#cb53-6"></a><span class="co"># Inner join</span></span>
<span id="cb53-7"><a href="#cb53-7"></a><span class="fu">innerjoin</span>(dat, dat_airports, on <span class="op">=</span> <span class="op">:</span>dest <span class="op">=&gt;</span> <span class="op">:</span>faa)</span>
<span id="cb53-8"><a href="#cb53-8"></a><span class="co"># if the datasets share a common name for the merge variable</span></span>
<span id="cb53-9"><a href="#cb53-9"></a><span class="pp">@rename</span>!(dat_airports, <span class="op">:</span>dest <span class="op">=</span> <span class="op">:</span>faa)</span>
<span id="cb53-10"><a href="#cb53-10"></a><span class="fu">innerjoin</span>(dat, dat_airports, on <span class="op">=</span> <span class="op">:</span>dest)</span>
<span id="cb53-11"><a href="#cb53-11"></a></span>
<span id="cb53-12"><a href="#cb53-12"></a><span class="co"># with missing values</span></span>
<span id="cb53-13"><a href="#cb53-13"></a><span class="fu">innerjoin</span>(dat, dat_airports, on <span class="op">=</span> <span class="op">:</span>dest; matchmissing<span class="op">=:</span>equal)</span>
<span id="cb53-14"><a href="#cb53-14"></a></span>
<span id="cb53-15"><a href="#cb53-15"></a><span class="co"># Other types of merge</span></span>
<span id="cb53-16"><a href="#cb53-16"></a><span class="co"># Left join</span></span>
<span id="cb53-17"><a href="#cb53-17"></a><span class="fu">leftjoin</span>(dat, dat_airports, on <span class="op">=</span> <span class="op">:</span>dest)</span>
<span id="cb53-18"><a href="#cb53-18"></a><span class="fu">leftjoin</span>(dat, dat_airports, on <span class="op">=</span> <span class="op">:</span>dest, source<span class="op">=</span><span class="st">"_merge"</span>) <span class="co"># stata style merge info</span></span>
<span id="cb53-19"><a href="#cb53-19"></a><span class="co"># Right join</span></span>
<span id="cb53-20"><a href="#cb53-20"></a><span class="fu">rightjoin</span>(dat, dat_airports, on <span class="op">=</span> <span class="op">:</span>dest)</span>
<span id="cb53-21"><a href="#cb53-21"></a><span class="co"># Outer join</span></span>
<span id="cb53-22"><a href="#cb53-22"></a><span class="fu">outerjoin</span>(dat, dat_airports, on <span class="op">=</span> <span class="op">:</span>dest)</span>
<span id="cb53-23"><a href="#cb53-23"></a><span class="co"># Semi join (filtering)</span></span>
<span id="cb53-24"><a href="#cb53-24"></a><span class="fu">semijoin</span>(dat, dat_airports, on <span class="op">=</span> <span class="op">:</span>dest)</span>
<span id="cb53-25"><a href="#cb53-25"></a><span class="co"># Anti join</span></span>
<span id="cb53-26"><a href="#cb53-26"></a><span class="fu">antijoin</span>(dat, dat_airports, on <span class="op">=</span> <span class="op">:</span>dest)</span>
<span id="cb53-27"><a href="#cb53-27"></a><span class="co"># Cross join</span></span>
<span id="cb53-28"><a href="#cb53-28"></a><span class="fu">crossjoin</span>(<span class="fu">unique</span>(<span class="fu">select</span>(dat, <span class="op">:</span>origin)), <span class="fu">unique</span>(<span class="fu">select</span>(dat, <span class="op">:</span>dest)) )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="g-col-6">
<div class="sourceCode" id="cb54"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1"></a><span class="co"># Load second dataset</span></span>
<span id="cb54-2"><a href="#cb54-2"></a>dat_airports <span class="ot">=</span> <span class="fu">fread</span>(</span>
<span id="cb54-3"><a href="#cb54-3"></a>    <span class="st">"https://vincentarelbundock.github.io/Rdatasets/csv/nycflights13/airports.csv"</span>) </span>
<span id="cb54-4"><a href="#cb54-4"></a></span>
<span id="cb54-5"><a href="#cb54-5"></a></span>
<span id="cb54-6"><a href="#cb54-6"></a><span class="co"># Inner join (default)</span></span>
<span id="cb54-7"><a href="#cb54-7"></a><span class="fu">merge</span>(dat, dat_airports, <span class="at">by.x =</span> <span class="fu">c</span>(<span class="st">"dest"</span>), <span class="at">by.y =</span> <span class="fu">c</span>(<span class="st">"faa"</span>))</span>
<span id="cb54-8"><a href="#cb54-8"></a><span class="co"># if the datasets share a common name for the merge variable</span></span>
<span id="cb54-9"><a href="#cb54-9"></a><span class="fu">setnames</span>(dat_airports, <span class="fu">c</span>(<span class="st">"faa"</span>), <span class="fu">c</span>(<span class="st">"dest"</span>))</span>
<span id="cb54-10"><a href="#cb54-10"></a><span class="fu">merge</span>(dat, dat_airports, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"dest"</span>))</span>
<span id="cb54-11"><a href="#cb54-11"></a></span>
<span id="cb54-12"><a href="#cb54-12"></a><span class="co"># with missing values</span></span>
<span id="cb54-13"><a href="#cb54-13"></a><span class="fu">merge</span>(dat, dat_airports, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"dest"</span>))</span>
<span id="cb54-14"><a href="#cb54-14"></a></span>
<span id="cb54-15"><a href="#cb54-15"></a><span class="co"># Other types of merge</span></span>
<span id="cb54-16"><a href="#cb54-16"></a><span class="co"># Left join</span></span>
<span id="cb54-17"><a href="#cb54-17"></a><span class="fu">merge</span>(dat, dat_airports, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"dest"</span>), <span class="at">all.x =</span> <span class="cn">TRUE</span>)</span>
<span id="cb54-18"><a href="#cb54-18"></a></span>
<span id="cb54-19"><a href="#cb54-19"></a><span class="co"># Right join</span></span>
<span id="cb54-20"><a href="#cb54-20"></a><span class="fu">merge</span>(dat, dat_airports, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"dest"</span>), <span class="at">all.y =</span> <span class="cn">TRUE</span>)</span>
<span id="cb54-21"><a href="#cb54-21"></a><span class="co"># Outer join</span></span>
<span id="cb54-22"><a href="#cb54-22"></a><span class="fu">merge</span>(dat, dat_airports, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"dest"</span>), <span class="at">all.x =</span> <span class="cn">TRUE</span>, <span class="at">all.y =</span> <span class="cn">TRUE</span>)</span>
<span id="cb54-23"><a href="#cb54-23"></a><span class="co"># Semi join (filtering)</span></span>
<span id="cb54-24"><a href="#cb54-24"></a><span class="fu">merge</span>(dat, dat_airports[, .(dest)], <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"dest"</span>))</span>
<span id="cb54-25"><a href="#cb54-25"></a><span class="co"># Anti join</span></span>
<span id="cb54-26"><a href="#cb54-26"></a>dat[<span class="fu">fsetdiff</span>(dat[, .(dest)], dat_airports[, .(dest)]), on <span class="ot">=</span> <span class="st">"dest"</span>]</span>
<span id="cb54-27"><a href="#cb54-27"></a><span class="co"># Cross join</span></span>
<span id="cb54-28"><a href="#cb54-28"></a><span class="fu">CJ</span>(<span class="fu">unique</span>(dat[[<span class="st">"origin"</span>]]), <span class="fu">unique</span>(dat[[<span class="st">"dest"</span>]])) <span class="co"># all combination of origin and destinations</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="advanced-merging" class="level2">
<h2 class="anchored" data-anchor-id="advanced-merging">Advanced merging</h2>
<section id="non-equi-joins" class="level4">
<h4 class="anchored" data-anchor-id="non-equi-joins">Non-equi joins</h4>
<div class="grid">
<div class="g-col-6">
<div class="sourceCode" id="cb55"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="g-col-6">
<div class="sourceCode" id="cb56"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1"></a>dat3 <span class="ot">=</span> <span class="fu">data.table</span>(<span class="at">carrier     =</span> <span class="fu">c</span>(<span class="st">'AA'</span>, <span class="st">'UA'</span>),</span>
<span id="cb56-2"><a href="#cb56-2"></a>                  <span class="at">start_month =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">4</span>),</span>
<span id="cb56-3"><a href="#cb56-3"></a>                  <span class="at">end_month   =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">6</span>)) </span>
<span id="cb56-4"><a href="#cb56-4"></a></span>
<span id="cb56-5"><a href="#cb56-5"></a><span class="co"># Rolling join that catches everything between the distinct</span></span>
<span id="cb56-6"><a href="#cb56-6"></a><span class="co"># start and end dates for each carrier.</span></span>
<span id="cb56-7"><a href="#cb56-7"></a>dat[dat3, on <span class="ot">=</span> .(carrier,</span>
<span id="cb56-8"><a href="#cb56-8"></a>                 month <span class="sc">&gt;=</span> start_month,</span>
<span id="cb56-9"><a href="#cb56-9"></a>                 month <span class="sc">&lt;=</span> end_month)] </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="rolling-joins" class="level4">
<h4 class="anchored" data-anchor-id="rolling-joins">Rolling joins</h4>
<div class="grid">
<div class="g-col-6">
<div class="sourceCode" id="cb57"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="g-col-6">
<div class="sourceCode" id="cb58"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1"></a></span>
<span id="cb58-2"><a href="#cb58-2"></a><span class="co"># Make sure we have a date variable</span></span>
<span id="cb58-3"><a href="#cb58-3"></a>dat[, date <span class="sc">:</span><span class="er">=</span> <span class="fu">as.IDate</span>(<span class="fu">paste</span>(year, month, day, <span class="at">sep=</span><span class="st">'-'</span>))] </span>
<span id="cb58-4"><a href="#cb58-4"></a></span>
<span id="cb58-5"><a href="#cb58-5"></a><span class="co"># New DT with the (random) target dates</span></span>
<span id="cb58-6"><a href="#cb58-6"></a>dat4 <span class="ot">=</span> <span class="fu">data.table</span>(<span class="at">carrier  =</span> <span class="fu">c</span>(<span class="st">'AA'</span>, <span class="st">'UA'</span>),</span>
<span id="cb58-7"><a href="#cb58-7"></a>                  <span class="at">new_date =</span> <span class="fu">as.IDate</span>(<span class="fu">c</span>(<span class="st">'2014-11-01'</span>, <span class="st">'2014-11-15'</span>))) </span>
<span id="cb58-8"><a href="#cb58-8"></a></span>
<span id="cb58-9"><a href="#cb58-9"></a><span class="co"># Join on these target dates, so they take the last known value </span></span>
<span id="cb58-10"><a href="#cb58-10"></a>dat[dat4, on <span class="ot">=</span> .(carrier, <span class="at">date=</span>new_date), roll<span class="ot">=</span><span class="st">'nearest'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="appending-data" class="level4">
<h4 class="anchored" data-anchor-id="appending-data">Appending data</h4>
<div class="grid">
<div class="g-col-6">
<div class="sourceCode" id="cb59"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb59-1"><a href="#cb59-1"></a><span class="fu">vcat</span>(dat, dat)</span>
<span id="cb59-2"><a href="#cb59-2"></a><span class="fu">vcat</span>(dat, dat, cols<span class="op">=:</span>union)</span>
<span id="cb59-3"><a href="#cb59-3"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="g-col-6">
<div class="sourceCode" id="cb60"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1"></a><span class="fu">rbindlist</span>(<span class="fu">list</span>(dat, dat)) <span class="co"># useful if working with list (purrr)</span></span>
<span id="cb60-2"><a href="#cb60-2"></a><span class="fu">rbindlist</span>(<span class="fu">list</span>(dat, dat), <span class="at">fill =</span> <span class="cn">TRUE</span>)</span>
<span id="cb60-3"><a href="#cb60-3"></a><span class="fu">rbind</span>(dat, dat, <span class="at">fill =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<!-- ----------------------------------------------------------------------------------- -->


<!-- -->

</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb61" data-shortcodes="false"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb61-1"><a href="#cb61-1"></a><span class="co">---</span></span>
<span id="cb61-2"><a href="#cb61-2"></a><span class="an">title:</span><span class="co"> "Tips for using DataFrames.jl from R data.table"</span></span>
<span id="cb61-3"><a href="#cb61-3"></a></span>
<span id="cb61-4"><a href="#cb61-4"></a><span class="an">author:</span><span class="co"> Erik Loualiche (eloualic@umn.edu)</span></span>
<span id="cb61-5"><a href="#cb61-5"></a><span class="an">date:</span><span class="co"> 2023-06-22</span></span>
<span id="cb61-6"><a href="#cb61-6"></a><span class="an">date-format:</span><span class="co"> long</span></span>
<span id="cb61-7"><a href="#cb61-7"></a><span class="an">format:</span></span>
<span id="cb61-8"><a href="#cb61-8"></a><span class="co">  html:</span></span>
<span id="cb61-9"><a href="#cb61-9"></a><span class="co">    code-fold: true</span></span>
<span id="cb61-10"><a href="#cb61-10"></a><span class="co">    code-tools: true</span></span>
<span id="cb61-11"><a href="#cb61-11"></a><span class="co">    code-block-bg: true</span></span>
<span id="cb61-12"><a href="#cb61-12"></a><span class="co">    code-block-border-left: "#F7F7F7"</span></span>
<span id="cb61-13"><a href="#cb61-13"></a><span class="co">    code-line-numbers: true</span></span>
<span id="cb61-14"><a href="#cb61-14"></a><span class="co">    highlight-style: github</span></span>
<span id="cb61-15"><a href="#cb61-15"></a><span class="co">    grid:</span></span>
<span id="cb61-16"><a href="#cb61-16"></a><span class="co">      body-width: 1400px</span></span>
<span id="cb61-17"><a href="#cb61-17"></a><span class="co">      gutter-width: 1.5rem</span></span>
<span id="cb61-18"><a href="#cb61-18"></a><span class="co">      sidebar-width: 250px</span></span>
<span id="cb61-19"><a href="#cb61-19"></a><span class="co">      margin-width: 0px</span></span>
<span id="cb61-20"><a href="#cb61-20"></a><span class="co">    css: style_jupyter.css</span></span>
<span id="cb61-21"><a href="#cb61-21"></a><span class="an">toc:</span><span class="co"> true</span></span>
<span id="cb61-22"><a href="#cb61-22"></a><span class="an">toc-location:</span><span class="co"> left      </span></span>
<span id="cb61-23"><a href="#cb61-23"></a><span class="an">toc-depth:</span><span class="co"> 2</span></span>
<span id="cb61-24"><a href="#cb61-24"></a><span class="an">toc-expand:</span><span class="co"> true</span></span>
<span id="cb61-25"><a href="#cb61-25"></a><span class="an">toc-title:</span><span class="co"> DataFrames.jl Cheatsheet</span></span>
<span id="cb61-26"><a href="#cb61-26"></a><span class="an">title-block-banner:</span><span class="co"> "#014421"</span></span>
<span id="cb61-27"><a href="#cb61-27"></a><span class="an">title-block-banner-color:</span><span class="co"> white</span></span>
<span id="cb61-28"><a href="#cb61-28"></a><span class="an">jupyter:</span><span class="co"> python3</span></span>
<span id="cb61-29"><a href="#cb61-29"></a><span class="co">---</span></span>
<span id="cb61-30"><a href="#cb61-30"></a></span>
<span id="cb61-31"><a href="#cb61-31"></a></span>
<span id="cb61-32"><a href="#cb61-32"></a><span class="fu"># Introduction</span></span>
<span id="cb61-33"><a href="#cb61-33"></a></span>
<span id="cb61-34"><a href="#cb61-34"></a><span class="fu">#### Resources</span></span>
<span id="cb61-35"><a href="#cb61-35"></a></span>
<span id="cb61-36"><a href="#cb61-36"></a><span class="ss">- </span>I will mostly follow the excellent <span class="co">[</span><span class="ot">`stata2r`</span><span class="co">](https://stata2r.github.io/data.table/#installation)</span> as a template.</span>
<span id="cb61-37"><a href="#cb61-37"></a><span class="ss">- </span>You can also have a look at some of the mappings in the <span class="in">`DataFrames.jl`</span> <span class="co">[</span><span class="ot">documentation</span><span class="co">](https://dataframes.juliadata.org/stable/man/comparisons/)</span></span>
<span id="cb61-38"><a href="#cb61-38"></a><span class="ss">- </span>I have found this <span class="co">[</span><span class="ot">guide</span><span class="co">](http://brooksandrew.github.io/simpleblog/articles/advanced-data-table/)</span> of data.table by Andrew Brooks  very useful.</span>
<span id="cb61-39"><a href="#cb61-39"></a></span>
<span id="cb61-40"><a href="#cb61-40"></a><span class="fu">#### Warnings</span></span>
<span id="cb61-41"><a href="#cb61-41"></a></span>
<span id="cb61-42"><a href="#cb61-42"></a><span class="ss">- </span>**Missing Data.** Dealing with missing data in julia requires to be explicit as most functions will return a <span class="in">`missing`</span> value if an array includes a missing element. Some functions will error. I will try to point out the equivalence with the <span class="in">`R`</span> code but be aware that the equivalence might not be always be strictly the same if you implement it. I show some of the examples on the *Freedman* dataset from the <span class="in">`car`</span> package in R.</span>
<span id="cb61-43"><a href="#cb61-43"></a><span class="ss">- </span>**Need improvement.** </span>
<span id="cb61-44"><a href="#cb61-44"></a><span class="ss">    + </span>This is a first draft and there might be a few mistakes throughout the document. I am not a professional and I probably picked up bad habits here and there. Send me an email at <span class="co">[</span><span class="ot">eloualic@umn.edu</span><span class="co">](mailto:eloualic@umn.edu)</span></span>
<span id="cb61-45"><a href="#cb61-45"></a><span class="ss">    +  </span>A few specific sections could use some user inputs as the julia solutions were less than ideal: <span class="co">[</span><span class="ot">*Leads and lags*</span><span class="co">](http://localhost:5005/#leads-and-lags)</span>; *Dates*; *Complex merges*</span>
<span id="cb61-46"><a href="#cb61-46"></a></span>
<span id="cb61-47"><a href="#cb61-47"></a></span>
<span id="cb61-48"><a href="#cb61-48"></a><span class="co">&lt;!-- ----------------------------------------------------------------------------------- --&gt;</span></span>
<span id="cb61-49"><a href="#cb61-49"></a><span class="fu"># Installation</span></span>
<span id="cb61-50"><a href="#cb61-50"></a></span>
<span id="cb61-51"><a href="#cb61-51"></a></span>
<span id="cb61-52"><a href="#cb61-52"></a>::: {.grid}</span>
<span id="cb61-53"><a href="#cb61-53"></a>::: {.g-col-6}</span>
<span id="cb61-54"><a href="#cb61-54"></a>Installation can sometime be challenging. </span>
<span id="cb61-55"><a href="#cb61-55"></a>This should not be an issue in <span class="in">`julia`</span> here. </span>
<span id="cb61-56"><a href="#cb61-56"></a>We will mostly use the base <span class="in">`DataFrames`</span> package and the convenient macros in the <span class="in">`DataFramesMeta`</span> package.</span>
<span id="cb61-57"><a href="#cb61-57"></a>To read in data  we will use the <span class="in">`CSV`</span> package while julia supports many different file formats (see <span class="co">[</span><span class="ot">`FileIO.jl`</span><span class="co">](https://github.com/JuliaIO/FileIO.jl)</span>)</span>
<span id="cb61-58"><a href="#cb61-58"></a>:::</span>
<span id="cb61-59"><a href="#cb61-59"></a></span>
<span id="cb61-60"><a href="#cb61-60"></a>::: {.g-col-6}</span>
<span id="cb61-61"><a href="#cb61-61"></a>Installation for <span class="in">`data.table`</span> can be tricky especially if you want to benefit from the multicore features. </span>
<span id="cb61-62"><a href="#cb61-62"></a>I recommend that you look at the <span class="co">[</span><span class="ot">installation wiki</span><span class="co">](https://github.com/Rdatatable/data.table/wiki/Installation)</span> for more details.</span>
<span id="cb61-63"><a href="#cb61-63"></a>:::</span>
<span id="cb61-64"><a href="#cb61-64"></a>:::</span>
<span id="cb61-65"><a href="#cb61-65"></a></span>
<span id="cb61-66"><a href="#cb61-66"></a></span>
<span id="cb61-67"><a href="#cb61-67"></a>::: {.grid}</span>
<span id="cb61-68"><a href="#cb61-68"></a>::: {.g-col-6}</span>
<span id="cb61-69"><a href="#cb61-69"></a><span class="in">```{.julia}</span></span>
<span id="cb61-70"><a href="#cb61-70"></a><span class="fu">import</span> Pkg</span>
<span id="cb61-71"><a href="#cb61-71"></a>Pkg.add(<span class="ot">"</span><span class="st">DataFrames</span><span class="ot">"</span>)</span>
<span id="cb61-72"><a href="#cb61-72"></a>Pkg.add(<span class="ot">"</span><span class="st">DataFramesMeta</span><span class="ot">"</span>)</span>
<span id="cb61-73"><a href="#cb61-73"></a></span>
<span id="cb61-74"><a href="#cb61-74"></a><span class="co"># Load the packages</span></span>
<span id="cb61-75"><a href="#cb61-75"></a>using DataFrames</span>
<span id="cb61-76"><a href="#cb61-76"></a>using DataFramesMeta</span>
<span id="cb61-77"><a href="#cb61-77"></a><span class="in">```</span></span>
<span id="cb61-78"><a href="#cb61-78"></a>:::</span>
<span id="cb61-79"><a href="#cb61-79"></a></span>
<span id="cb61-80"><a href="#cb61-80"></a>::: {.g-col-6}</span>
<span id="cb61-81"><a href="#cb61-81"></a><span class="in">```{.r}</span></span>
<span id="cb61-82"><a href="#cb61-82"></a><span class="fu">install.packages</span>(<span class="st">"data.table"</span>)</span>
<span id="cb61-83"><a href="#cb61-83"></a></span>
<span id="cb61-84"><a href="#cb61-84"></a><span class="co"># latest development version that has passed all tests:</span></span>
<span id="cb61-85"><a href="#cb61-85"></a>data.table<span class="sc">::</span><span class="fu">update_dev_pkg</span>()</span>
<span id="cb61-86"><a href="#cb61-86"></a><span class="co"># load the package</span></span>
<span id="cb61-87"><a href="#cb61-87"></a><span class="fu">library</span>(data.table)</span>
<span id="cb61-88"><a href="#cb61-88"></a><span class="in">```</span></span>
<span id="cb61-89"><a href="#cb61-89"></a>:::</span>
<span id="cb61-90"><a href="#cb61-90"></a>:::</span>
<span id="cb61-91"><a href="#cb61-91"></a></span>
<span id="cb61-92"><a href="#cb61-92"></a>We will also use other packages to load auxiliary datasets, download data etc.</span>
<span id="cb61-93"><a href="#cb61-93"></a>I use the pipe macro in julia and the magrittr package in R to compose commands (though both packages have some amount of chaining built-in)</span>
<span id="cb61-94"><a href="#cb61-94"></a></span>
<span id="cb61-95"><a href="#cb61-95"></a>::: {.grid}</span>
<span id="cb61-96"><a href="#cb61-96"></a>::: {.g-col-6}</span>
<span id="cb61-97"><a href="#cb61-97"></a><span class="in">```{.julia}</span></span>
<span id="cb61-98"><a href="#cb61-98"></a>Pkg.add(<span class="ot">"</span><span class="st">CSV</span><span class="ot">"</span>)</span>
<span id="cb61-99"><a href="#cb61-99"></a>Pkg.add(<span class="ot">"</span><span class="st">ShiftedArrays</span><span class="ot">"</span>) <span class="co"># lead/lag operators</span></span>
<span id="cb61-100"><a href="#cb61-100"></a>Pkg.add(<span class="ot">"</span><span class="st">HTTP</span><span class="ot">"</span>) <span class="co"># download utilities</span></span>
<span id="cb61-101"><a href="#cb61-101"></a>Pkg.add(<span class="ot">"</span><span class="st">RDatasets</span><span class="ot">"</span>) </span>
<span id="cb61-102"><a href="#cb61-102"></a>Pkg.add(<span class="ot">"</span><span class="st">Pipe</span><span class="ot">"</span>) <span class="co"># pipes</span></span>
<span id="cb61-103"><a href="#cb61-103"></a></span>
<span id="cb61-104"><a href="#cb61-104"></a><span class="co"># Load the packages</span></span>
<span id="cb61-105"><a href="#cb61-105"></a>using HTTP</span>
<span id="cb61-106"><a href="#cb61-106"></a>using CSV</span>
<span id="cb61-107"><a href="#cb61-107"></a>using RDatasets</span>
<span id="cb61-108"><a href="#cb61-108"></a>using Pipe</span>
<span id="cb61-109"><a href="#cb61-109"></a>using ShiftedArrays</span>
<span id="cb61-110"><a href="#cb61-110"></a>using Dates</span>
<span id="cb61-111"><a href="#cb61-111"></a></span>
<span id="cb61-112"><a href="#cb61-112"></a><span class="co"># We will need some statistical function from the Base package</span></span>
<span id="cb61-113"><a href="#cb61-113"></a><span class="fu">import</span> Statistics: mean </span>
<span id="cb61-114"><a href="#cb61-114"></a><span class="in">```</span></span>
<span id="cb61-115"><a href="#cb61-115"></a>:::</span>
<span id="cb61-116"><a href="#cb61-116"></a></span>
<span id="cb61-117"><a href="#cb61-117"></a>::: {.g-col-6}</span>
<span id="cb61-118"><a href="#cb61-118"></a><span class="in">```{.r}</span></span>
<span id="cb61-119"><a href="#cb61-119"></a><span class="fu">install.packages</span>(<span class="st">"car"</span>)       <span class="co"># RDataset</span></span>
<span id="cb61-120"><a href="#cb61-120"></a><span class="fu">install.packages</span>(<span class="st">"magrittr"</span>)  <span class="co"># pipes</span></span>
<span id="cb61-121"><a href="#cb61-121"></a><span class="fu">install.packages</span>(<span class="st">"statar"</span>)    <span class="co"># stata-style data utilities</span></span>
<span id="cb61-122"><a href="#cb61-122"></a><span class="fu">install.packages</span>(<span class="st">"lubridate"</span>) <span class="co"># date utilities</span></span>
<span id="cb61-123"><a href="#cb61-123"></a></span>
<span id="cb61-124"><a href="#cb61-124"></a><span class="co"># Load the package</span></span>
<span id="cb61-125"><a href="#cb61-125"></a><span class="fu">library</span>(car)</span>
<span id="cb61-126"><a href="#cb61-126"></a><span class="fu">library</span>(magrittr)</span>
<span id="cb61-127"><a href="#cb61-127"></a><span class="fu">library</span>(statar)</span>
<span id="cb61-128"><a href="#cb61-128"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb61-129"><a href="#cb61-129"></a><span class="in">```</span></span>
<span id="cb61-130"><a href="#cb61-130"></a>:::</span>
<span id="cb61-131"><a href="#cb61-131"></a>:::</span>
<span id="cb61-132"><a href="#cb61-132"></a><span class="co">&lt;!-- ----------------------------------------------------------------------------------- --&gt;</span></span>
<span id="cb61-133"><a href="#cb61-133"></a></span>
<span id="cb61-134"><a href="#cb61-134"></a></span>
<span id="cb61-135"><a href="#cb61-135"></a><span class="co">&lt;!-- ----------------------------------------------------------------------------------- --&gt;</span></span>
<span id="cb61-136"><a href="#cb61-136"></a><span class="fu"># File I/O</span></span>
<span id="cb61-137"><a href="#cb61-137"></a></span>
<span id="cb61-138"><a href="#cb61-138"></a><span class="fu">## Reading Data</span></span>
<span id="cb61-139"><a href="#cb61-139"></a></span>
<span id="cb61-140"><a href="#cb61-140"></a>I am using the flight dataset to run most of the examples. </span>
<span id="cb61-141"><a href="#cb61-141"></a>This assumes your data is in a <span class="in">`csv`</span> format. </span>
<span id="cb61-142"><a href="#cb61-142"></a></span>
<span id="cb61-143"><a href="#cb61-143"></a>There are options in both languages to read from more efficient formats like parquet. </span>
<span id="cb61-144"><a href="#cb61-144"></a>I have found that csv is both fast and idioproof and lends itself to quick manipulation on the shell if I need to do something quickly.</span>
<span id="cb61-145"><a href="#cb61-145"></a></span>
<span id="cb61-146"><a href="#cb61-146"></a>::: {.grid}</span>
<span id="cb61-147"><a href="#cb61-147"></a>::: {.g-col-6}</span>
<span id="cb61-148"><a href="#cb61-148"></a>In julia, the <span class="in">`CSV.jl`</span> package does not allow to read directly from a url but we can use the <span class="in">`HTTP.jl`</span> package to download the file.</span>
<span id="cb61-149"><a href="#cb61-149"></a>:::</span>
<span id="cb61-150"><a href="#cb61-150"></a></span>
<span id="cb61-151"><a href="#cb61-151"></a>::: {.g-col-6}</span>
<span id="cb61-152"><a href="#cb61-152"></a>In R, you can directly read the dataset from an <span class="in">`url`</span> using <span class="in">`fread`</span> in <span class="in">`data.table`</span>.</span>
<span id="cb61-153"><a href="#cb61-153"></a>:::</span>
<span id="cb61-154"><a href="#cb61-154"></a>:::</span>
<span id="cb61-155"><a href="#cb61-155"></a></span>
<span id="cb61-156"><a href="#cb61-156"></a></span>
<span id="cb61-157"><a href="#cb61-157"></a>::: {.grid}</span>
<span id="cb61-158"><a href="#cb61-158"></a>::: {.g-col-6}</span>
<span id="cb61-159"><a href="#cb61-159"></a><span class="in">```{.julia}</span></span>
<span id="cb61-160"><a href="#cb61-160"></a><span class="co"># Flights data</span></span>
<span id="cb61-161"><a href="#cb61-161"></a>url_flights = <span class="ot">"</span><span class="st">https://raw.githubusercontent.com/Rdatatable/data.table/master/vignettes/flights14.csv</span><span class="ot">"</span></span>
<span id="cb61-162"><a href="#cb61-162"></a>url_get = HTTP.get(url_flights);</span>
<span id="cb61-163"><a href="#cb61-163"></a>dat = CSV.<span class="fu">read</span>(url_get.body, DataFrame)</span>
<span id="cb61-164"><a href="#cb61-164"></a></span>
<span id="cb61-165"><a href="#cb61-165"></a><span class="co"># Freedman data</span></span>
<span id="cb61-166"><a href="#cb61-166"></a>dat_missing = RDatasets.dataset(<span class="ot">"</span><span class="st">car</span><span class="ot">"</span>, <span class="ot">"</span><span class="st">Freedman</span><span class="ot">"</span>)</span>
<span id="cb61-167"><a href="#cb61-167"></a><span class="in">```</span></span>
<span id="cb61-168"><a href="#cb61-168"></a>:::</span>
<span id="cb61-169"><a href="#cb61-169"></a></span>
<span id="cb61-170"><a href="#cb61-170"></a>::: {.g-col-6}</span>
<span id="cb61-171"><a href="#cb61-171"></a><span class="in">```{.r .code-overflow-scroll}</span></span>
<span id="cb61-172"><a href="#cb61-172"></a><span class="co"># Flights data</span></span>
<span id="cb61-173"><a href="#cb61-173"></a>url_flights <span class="ot">=</span> <span class="st">"https://raw.githubusercontent.com/Rdatatable/data.table/master/vignettes/flights14.csv"</span></span>
<span id="cb61-174"><a href="#cb61-174"></a></span>
<span id="cb61-175"><a href="#cb61-175"></a>dat <span class="ot">=</span> <span class="fu">fread</span>(url_flights)</span>
<span id="cb61-176"><a href="#cb61-176"></a></span>
<span id="cb61-177"><a href="#cb61-177"></a><span class="co"># Freedman data</span></span>
<span id="cb61-178"><a href="#cb61-178"></a>dat_missing <span class="ot">=</span> <span class="fu">data.table</span>(Freedman) <span class="co"># load and convert to data.table</span></span>
<span id="cb61-179"><a href="#cb61-179"></a><span class="in">```</span></span>
<span id="cb61-180"><a href="#cb61-180"></a>:::</span>
<span id="cb61-181"><a href="#cb61-181"></a>:::</span>
<span id="cb61-182"><a href="#cb61-182"></a></span>
<span id="cb61-183"><a href="#cb61-183"></a></span>
<span id="cb61-184"><a href="#cb61-184"></a><span class="fu">## Writing Data</span></span>
<span id="cb61-185"><a href="#cb61-185"></a></span>
<span id="cb61-186"><a href="#cb61-186"></a>::: {.grid}</span>
<span id="cb61-187"><a href="#cb61-187"></a>::: {.g-col-6}</span>
<span id="cb61-188"><a href="#cb61-188"></a>To write the file we use a similar function. It is also possible to save the file with compression</span>
<span id="cb61-189"><a href="#cb61-189"></a>:::</span>
<span id="cb61-190"><a href="#cb61-190"></a></span>
<span id="cb61-191"><a href="#cb61-191"></a>::: {.g-col-6}</span>
<span id="cb61-192"><a href="#cb61-192"></a>Similarly <span class="in">`data.table`</span> provides a write function with optional compression</span>
<span id="cb61-193"><a href="#cb61-193"></a>:::</span>
<span id="cb61-194"><a href="#cb61-194"></a>:::</span>
<span id="cb61-195"><a href="#cb61-195"></a></span>
<span id="cb61-196"><a href="#cb61-196"></a>::: {.grid}</span>
<span id="cb61-197"><a href="#cb61-197"></a>::: {.g-col-6}</span>
<span id="cb61-198"><a href="#cb61-198"></a><span class="in">```{.julia .code-overflow-scroll}</span></span>
<span id="cb61-199"><a href="#cb61-199"></a>CSV.<span class="fu">write</span>(<span class="ot">"</span><span class="st">./data.csv</span><span class="ot">"</span>, dat)</span>
<span id="cb61-200"><a href="#cb61-200"></a>CSV.<span class="fu">write</span>(<span class="ot">"</span><span class="st">./data.csv.gz</span><span class="ot">"</span>, dat; compress=true)</span>
<span id="cb61-201"><a href="#cb61-201"></a><span class="in">```</span></span>
<span id="cb61-202"><a href="#cb61-202"></a>If you want to set up a different compression algorithm (faster or more efficient) use <span class="co">[</span><span class="ot">`TranscodingStreams.jl`</span><span class="co">](https://github.com/JuliaIO/TranscodingStreams.jl)</span> with the appropriate codec.</span>
<span id="cb61-203"><a href="#cb61-203"></a>For example if you want to use zst you would do</span>
<span id="cb61-204"><a href="#cb61-204"></a><span class="in">```{.julia .code-overflow-scroll}</span></span>
<span id="cb61-205"><a href="#cb61-205"></a>Pkg.add(<span class="ot">"</span><span class="st">CodecZstd</span><span class="ot">"</span>)</span>
<span id="cb61-206"><a href="#cb61-206"></a>using CodecZstd</span>
<span id="cb61-207"><a href="#cb61-207"></a><span class="fu">open</span>(ZstdCompressorStream, <span class="ot">"</span><span class="st">./data.csv.zst</span><span class="ot">"</span>, <span class="ot">"</span><span class="st">w</span><span class="ot">"</span>) <span class="kw">do</span> stream</span>
<span id="cb61-208"><a href="#cb61-208"></a>    CSV.<span class="fu">write</span>(stream, dat)</span>
<span id="cb61-209"><a href="#cb61-209"></a>end</span>
<span id="cb61-210"><a href="#cb61-210"></a></span>
<span id="cb61-211"><a href="#cb61-211"></a><span class="co"># similarly to read it back</span></span>
<span id="cb61-212"><a href="#cb61-212"></a>dat = <span class="fu">open</span>(ZstdDecompressorStream, <span class="ot">"</span><span class="st">./data.csv.zst</span><span class="ot">"</span>, <span class="ot">"</span><span class="st">r</span><span class="ot">"</span>) <span class="kw">do</span> stream</span>
<span id="cb61-213"><a href="#cb61-213"></a>    CSV.<span class="fu">read</span>(stream, DataFrame)</span>
<span id="cb61-214"><a href="#cb61-214"></a>end</span>
<span id="cb61-215"><a href="#cb61-215"></a><span class="in">```</span></span>
<span id="cb61-216"><a href="#cb61-216"></a></span>
<span id="cb61-217"><a href="#cb61-217"></a>:::</span>
<span id="cb61-218"><a href="#cb61-218"></a></span>
<span id="cb61-219"><a href="#cb61-219"></a>::: {.g-col-6}</span>
<span id="cb61-220"><a href="#cb61-220"></a><span class="in">```{.r .code-overflow-scroll}</span></span>
<span id="cb61-221"><a href="#cb61-221"></a><span class="fu">fwrite</span>(dat, <span class="st">"./data.csv"</span>)</span>
<span id="cb61-222"><a href="#cb61-222"></a><span class="fu">fwrite</span>(dat, <span class="st">"./data.csv.gz"</span>, <span class="at">compress=</span><span class="st">"gzip"</span>) <span class="co"># with compression</span></span>
<span id="cb61-223"><a href="#cb61-223"></a><span class="in">```</span></span>
<span id="cb61-224"><a href="#cb61-224"></a>:::</span>
<span id="cb61-225"><a href="#cb61-225"></a>:::</span>
<span id="cb61-226"><a href="#cb61-226"></a></span>
<span id="cb61-227"><a href="#cb61-227"></a><span class="fu">## (Benchmarks)</span></span>
<span id="cb61-228"><a href="#cb61-228"></a></span>
<span id="cb61-229"><a href="#cb61-229"></a>I would like to include a benchmark for one large file and compare csv intake to parquet.</span>
<span id="cb61-230"><a href="#cb61-230"></a></span>
<span id="cb61-231"><a href="#cb61-231"></a><span class="co">&lt;!-- ----------------------------------------------------------------------------------- --&gt;</span></span>
<span id="cb61-232"><a href="#cb61-232"></a></span>
<span id="cb61-233"><a href="#cb61-233"></a></span>
<span id="cb61-234"><a href="#cb61-234"></a><span class="co">&lt;!-- ----------------------------------------------------------------------------------- --&gt;</span></span>
<span id="cb61-235"><a href="#cb61-235"></a><span class="fu"># Inspecting the dataset</span></span>
<span id="cb61-236"><a href="#cb61-236"></a></span>
<span id="cb61-237"><a href="#cb61-237"></a>This is before we start filtering, collapsing, or merging the data. </span>
<span id="cb61-238"><a href="#cb61-238"></a></span>
<span id="cb61-239"><a href="#cb61-239"></a><span class="fu">## Sorting</span></span>
<span id="cb61-240"><a href="#cb61-240"></a></span>
<span id="cb61-241"><a href="#cb61-241"></a>It is important to be able to sort rows. </span>
<span id="cb61-242"><a href="#cb61-242"></a>What are the most delayed flights, what about the most delayed flight on a specific day?</span>
<span id="cb61-243"><a href="#cb61-243"></a></span>
<span id="cb61-244"><a href="#cb61-244"></a>*Note that the code changes the order "in-place" as it changes the dataset itself.*</span>
<span id="cb61-245"><a href="#cb61-245"></a></span>
<span id="cb61-246"><a href="#cb61-246"></a>::: {.grid}</span>
<span id="cb61-247"><a href="#cb61-247"></a>::: {.g-col-6}</span>
<span id="cb61-248"><a href="#cb61-248"></a>The most basic task is to sort some columns with respect to a specific variable</span>
<span id="cb61-249"><a href="#cb61-249"></a>:::</span>
<span id="cb61-250"><a href="#cb61-250"></a></span>
<span id="cb61-251"><a href="#cb61-251"></a>::: {.g-col-6}</span>
<span id="cb61-252"><a href="#cb61-252"></a>Similarly <span class="in">`data.table`</span> provides a write function with optional compression</span>
<span id="cb61-253"><a href="#cb61-253"></a>:::</span>
<span id="cb61-254"><a href="#cb61-254"></a>:::</span>
<span id="cb61-255"><a href="#cb61-255"></a></span>
<span id="cb61-256"><a href="#cb61-256"></a>::: {.grid}</span>
<span id="cb61-257"><a href="#cb61-257"></a>::: {.g-col-6}</span>
<span id="cb61-258"><a href="#cb61-258"></a><span class="in">```{.julia .code-overflow-scroll}</span></span>
<span id="cb61-259"><a href="#cb61-259"></a><span class="fu">sort</span>!(dat, :air_time)</span>
<span id="cb61-260"><a href="#cb61-260"></a><span class="fu">sort</span>!(dat, [:air_time, :dest])</span>
<span id="cb61-261"><a href="#cb61-261"></a><span class="fu">sort</span>!(dat, :air_time; rev=true)</span>
<span id="cb61-262"><a href="#cb61-262"></a><span class="fu">sort</span>!(dat, [order(:air_time, rev=true), :dest])</span>
<span id="cb61-263"><a href="#cb61-263"></a></span>
<span id="cb61-264"><a href="#cb61-264"></a><span class="co"># if you do not want to change the dataset in place</span></span>
<span id="cb61-265"><a href="#cb61-265"></a><span class="fu">sort</span>(dat, :air_time)</span>
<span id="cb61-266"><a href="#cb61-266"></a><span class="in">```</span></span>
<span id="cb61-267"><a href="#cb61-267"></a>:::</span>
<span id="cb61-268"><a href="#cb61-268"></a></span>
<span id="cb61-269"><a href="#cb61-269"></a>::: {.g-col-6}</span>
<span id="cb61-270"><a href="#cb61-270"></a><span class="in">```{.r}</span></span>
<span id="cb61-271"><a href="#cb61-271"></a><span class="fu">setorder</span>(dat, air_time) </span>
<span id="cb61-272"><a href="#cb61-272"></a><span class="fu">setorder</span>(dat, air_time, dest) </span>
<span id="cb61-273"><a href="#cb61-273"></a><span class="fu">setorder</span>(dat, <span class="sc">-</span>air_time)</span>
<span id="cb61-274"><a href="#cb61-274"></a><span class="fu">setorder</span>(dat, <span class="sc">-</span>air_time, dest)</span>
<span id="cb61-275"><a href="#cb61-275"></a></span>
<span id="cb61-276"><a href="#cb61-276"></a><span class="co"># if you do not want to change the dataset in place</span></span>
<span id="cb61-277"><a href="#cb61-277"></a>dat[ <span class="fu">order</span>(air_time)] <span class="co"># etc.</span></span>
<span id="cb61-278"><a href="#cb61-278"></a><span class="in">```</span></span>
<span id="cb61-279"><a href="#cb61-279"></a>To reorder a dataset programmatically use the <span class="in">`setorderv`</span> function</span>
<span id="cb61-280"><a href="#cb61-280"></a><span class="in">```{.r}</span></span>
<span id="cb61-281"><a href="#cb61-281"></a>col <span class="ot">=</span> <span class="st">"air_time"</span></span>
<span id="cb61-282"><a href="#cb61-282"></a><span class="fu">setorderv</span>(dat, col)</span>
<span id="cb61-283"><a href="#cb61-283"></a><span class="in">```</span></span>
<span id="cb61-284"><a href="#cb61-284"></a>:::</span>
<span id="cb61-285"><a href="#cb61-285"></a>:::</span>
<span id="cb61-286"><a href="#cb61-286"></a></span>
<span id="cb61-287"><a href="#cb61-287"></a>If we want to reorder **columns**</span>
<span id="cb61-288"><a href="#cb61-288"></a></span>
<span id="cb61-289"><a href="#cb61-289"></a>::: {.grid}</span>
<span id="cb61-290"><a href="#cb61-290"></a>::: {.g-col-6}</span>
<span id="cb61-291"><a href="#cb61-291"></a><span class="in">```{.julia}</span></span>
<span id="cb61-292"><a href="#cb61-292"></a><span class="fu">select</span>!(dat, [:month, :day], Not([:month, :day]))</span>
<span id="cb61-293"><a href="#cb61-293"></a><span class="in">```</span></span>
<span id="cb61-294"><a href="#cb61-294"></a>:::</span>
<span id="cb61-295"><a href="#cb61-295"></a></span>
<span id="cb61-296"><a href="#cb61-296"></a>::: {.g-col-6}</span>
<span id="cb61-297"><a href="#cb61-297"></a><span class="in">```{.r}</span></span>
<span id="cb61-298"><a href="#cb61-298"></a><span class="fu">setcolorder</span>(dat, <span class="fu">c</span>(<span class="st">"month"</span>, <span class="st">"day"</span>))</span>
<span id="cb61-299"><a href="#cb61-299"></a><span class="in">```</span></span>
<span id="cb61-300"><a href="#cb61-300"></a>:::</span>
<span id="cb61-301"><a href="#cb61-301"></a>:::</span>
<span id="cb61-302"><a href="#cb61-302"></a></span>
<span id="cb61-303"><a href="#cb61-303"></a><span class="fu">## Renaming</span></span>
<span id="cb61-304"><a href="#cb61-304"></a></span>
<span id="cb61-305"><a href="#cb61-305"></a>Renaming does modify the dataset but it does not alter its data so we include it here. </span>
<span id="cb61-306"><a href="#cb61-306"></a></span>
<span id="cb61-307"><a href="#cb61-307"></a>::: {.grid}</span>
<span id="cb61-308"><a href="#cb61-308"></a>::: {.g-col-6}</span>
<span id="cb61-309"><a href="#cb61-309"></a>This is where I start leaning on the macros from <span class="in">`DataFramesMeta.jl`</span></span>
<span id="cb61-310"><a href="#cb61-310"></a>:::</span>
<span id="cb61-311"><a href="#cb61-311"></a></span>
<span id="cb61-312"><a href="#cb61-312"></a>::: {.g-col-6}</span>
<span id="cb61-313"><a href="#cb61-313"></a>Similarly <span class="in">`data.table`</span> provides a write function with optional compression</span>
<span id="cb61-314"><a href="#cb61-314"></a>:::</span>
<span id="cb61-315"><a href="#cb61-315"></a>:::</span>
<span id="cb61-316"><a href="#cb61-316"></a></span>
<span id="cb61-317"><a href="#cb61-317"></a>::: {.grid}</span>
<span id="cb61-318"><a href="#cb61-318"></a>::: {.g-col-6}</span>
<span id="cb61-319"><a href="#cb61-319"></a><span class="in">```{.julia}</span></span>
<span id="cb61-320"><a href="#cb61-320"></a><span class="dt">@rename</span>!(dat, :new_arr_delay = :arr_delay)</span>
<span id="cb61-321"><a href="#cb61-321"></a><span class="dt">@rename</span>!(dat, :new_carrier = :carrier, :new_origin  = <span class="wa">$"</span><span class="dt">origin</span><span class="ot">"</span><span class="st">) </span></span>
<span id="cb61-322"><a href="#cb61-322"></a><span class="dt">@rename</span><span class="st">(dat, :new_arr_delay = :arr_delay) # not in place</span></span>
<span id="cb61-323"><a href="#cb61-323"></a></span>
<span id="cb61-324"><a href="#cb61-324"></a><span class="st">rename!(x -&gt; replace(x, </span><span class="ot">"</span>arr_<span class="ot">"</span><span class="st"> =&gt; </span><span class="ot">"</span>arrival_<span class="ot">"</span><span class="st">), dat) # use the base DataFrames.jl function here</span></span>
<span id="cb61-325"><a href="#cb61-325"></a><span class="st">```</span></span>
<span id="cb61-326"><a href="#cb61-326"></a><span class="st">:::</span></span>
<span id="cb61-327"><a href="#cb61-327"></a></span>
<span id="cb61-328"><a href="#cb61-328"></a><span class="st">::: {.g-col-6}</span></span>
<span id="cb61-329"><a href="#cb61-329"></a><span class="st">```{.r}</span></span>
<span id="cb61-330"><a href="#cb61-330"></a><span class="st">setnames(dat, </span><span class="ot">"</span>new_arr_delay<span class="ot">"</span><span class="st">, </span><span class="ot">"</span>arrival_delay<span class="ot">"</span><span class="st">) </span></span>
<span id="cb61-331"><a href="#cb61-331"></a><span class="st">setnames(dat, c(</span><span class="ot">"</span>carrier<span class="ot">"</span><span class="st">,</span><span class="ot">"</span>origin<span class="ot">"</span><span class="st">), c(</span><span class="ot">"</span>new_carrier<span class="ot">"</span><span class="st">,</span><span class="ot">"</span>new_origin<span class="ot">"</span><span class="st">)) </span></span>
<span id="cb61-332"><a href="#cb61-332"></a></span>
<span id="cb61-333"><a href="#cb61-333"></a></span>
<span id="cb61-334"><a href="#cb61-334"></a><span class="st">setnames(dat, gsub(</span><span class="ot">"</span>arr_<span class="ot">"</span><span class="st">, </span><span class="ot">"</span>arrival_<span class="ot">"</span><span class="st">, names(dat)))</span></span>
<span id="cb61-335"><a href="#cb61-335"></a><span class="st">```</span></span>
<span id="cb61-336"><a href="#cb61-336"></a><span class="st">:::</span></span>
<span id="cb61-337"><a href="#cb61-337"></a><span class="st">:::</span></span>
<span id="cb61-338"><a href="#cb61-338"></a></span>
<span id="cb61-339"><a href="#cb61-339"></a></span>
<span id="cb61-340"><a href="#cb61-340"></a><span class="st">## Summary Statistics</span></span>
<span id="cb61-341"><a href="#cb61-341"></a></span>
<span id="cb61-342"><a href="#cb61-342"></a><span class="st">::: {.grid}</span></span>
<span id="cb61-343"><a href="#cb61-343"></a><span class="st">::: {.g-col-6}</span></span>
<span id="cb61-344"><a href="#cb61-344"></a><span class="st">```{.julia}</span></span>
<span id="cb61-345"><a href="#cb61-345"></a><span class="st">describe(dat)</span></span>
<span id="cb61-346"><a href="#cb61-346"></a><span class="st">describe(dat, :arr_delay)</span></span>
<span id="cb61-347"><a href="#cb61-347"></a><span class="st">describe(dat, :min, :detailed, cols=:arr_delay) </span></span>
<span id="cb61-348"><a href="#cb61-348"></a><span class="st">```</span></span>
<span id="cb61-349"><a href="#cb61-349"></a><span class="st">:::</span></span>
<span id="cb61-350"><a href="#cb61-350"></a></span>
<span id="cb61-351"><a href="#cb61-351"></a><span class="st">::: {.g-col-6}</span></span>
<span id="cb61-352"><a href="#cb61-352"></a><span class="st">```{.r}</span></span>
<span id="cb61-353"><a href="#cb61-353"></a><span class="st">sum_up(dat) # from statar package</span></span>
<span id="cb61-354"><a href="#cb61-354"></a><span class="st">sum_up(dat, arr_delay)</span></span>
<span id="cb61-355"><a href="#cb61-355"></a><span class="st">sum_up(dat, arr_delay, d = TRUE)</span></span>
<span id="cb61-356"><a href="#cb61-356"></a><span class="st">```</span></span>
<span id="cb61-357"><a href="#cb61-357"></a><span class="st">:::</span></span>
<span id="cb61-358"><a href="#cb61-358"></a><span class="st">:::</span></span>
<span id="cb61-359"><a href="#cb61-359"></a></span>
<span id="cb61-360"><a href="#cb61-360"></a><span class="st">## Tabulations</span></span>
<span id="cb61-361"><a href="#cb61-361"></a></span>
<span id="cb61-362"><a href="#cb61-362"></a><span class="st">::: {.grid}</span></span>
<span id="cb61-363"><a href="#cb61-363"></a><span class="st">::: {.g-col-6}</span></span>
<span id="cb61-364"><a href="#cb61-364"></a><span class="st">```{.julia}</span></span>
<span id="cb61-365"><a href="#cb61-365"></a><span class="st">summary_var = :carrier # or [:carrier, :origin]</span></span>
<span id="cb61-366"><a href="#cb61-366"></a><span class="dt">@pipe</span><span class="st"> dat |&gt; groupby(_, summary_var) |&gt;</span></span>
<span id="cb61-367"><a href="#cb61-367"></a><span class="st">    combine(_, nrow =&gt; :Freq, proprow =&gt; :Percent) |&gt;</span></span>
<span id="cb61-368"><a href="#cb61-368"></a><span class="st">    </span><span class="dt">@transform</span><span class="st">(_, :Cum = cumsum(:Percent))</span></span>
<span id="cb61-369"><a href="#cb61-369"></a></span>
<span id="cb61-370"><a href="#cb61-370"></a></span>
<span id="cb61-371"><a href="#cb61-371"></a><span class="st">```</span></span>
<span id="cb61-372"><a href="#cb61-372"></a><span class="st">:::</span></span>
<span id="cb61-373"><a href="#cb61-373"></a></span>
<span id="cb61-374"><a href="#cb61-374"></a><span class="st">::: {.g-col-6}</span></span>
<span id="cb61-375"><a href="#cb61-375"></a><span class="st">```{.r}</span></span>
<span id="cb61-376"><a href="#cb61-376"></a><span class="st">tab(dat, carrier) # from statar package</span></span>
<span id="cb61-377"><a href="#cb61-377"></a><span class="st">tab(dat, carrier, origin)</span></span>
<span id="cb61-378"><a href="#cb61-378"></a><span class="st"># data.table version</span></span>
<span id="cb61-379"><a href="#cb61-379"></a><span class="st">dat[, .N, by = .(carrier, origin)][,</span></span>
<span id="cb61-380"><a href="#cb61-380"></a><span class="st">    `:=`(Percent=100*N/nrow(dat), Cum=100*cumsum(N)/nrow(dat)) ][]</span></span>
<span id="cb61-381"><a href="#cb61-381"></a></span>
<span id="cb61-382"><a href="#cb61-382"></a><span class="st">```</span></span>
<span id="cb61-383"><a href="#cb61-383"></a><span class="st">:::</span></span>
<span id="cb61-384"><a href="#cb61-384"></a><span class="st">:::</span></span>
<span id="cb61-385"><a href="#cb61-385"></a></span>
<span id="cb61-386"><a href="#cb61-386"></a></span>
<span id="cb61-387"><a href="#cb61-387"></a><span class="st">&lt;!-- ----------------------------------------------------------------------------------- --&gt;</span></span>
<span id="cb61-388"><a href="#cb61-388"></a></span>
<span id="cb61-389"><a href="#cb61-389"></a></span>
<span id="cb61-390"><a href="#cb61-390"></a><span class="st">&lt;!-- ----------------------------------------------------------------------------------- --&gt;</span></span>
<span id="cb61-391"><a href="#cb61-391"></a><span class="st"># Filtering</span></span>
<span id="cb61-392"><a href="#cb61-392"></a></span>
<span id="cb61-393"><a href="#cb61-393"></a><span class="st">## Subsetting rows</span></span>
<span id="cb61-394"><a href="#cb61-394"></a></span>
<span id="cb61-395"><a href="#cb61-395"></a><span class="st">#### On the flights data</span></span>
<span id="cb61-396"><a href="#cb61-396"></a><span class="st">::: {.grid}</span></span>
<span id="cb61-397"><a href="#cb61-397"></a><span class="st">::: {.g-col-6}</span></span>
<span id="cb61-398"><a href="#cb61-398"></a><span class="st">There are multiple options for filteringhis is where I start leaning on the macros from `DataFramesMeta.jl`</span></span>
<span id="cb61-399"><a href="#cb61-399"></a><span class="st">:::</span></span>
<span id="cb61-400"><a href="#cb61-400"></a></span>
<span id="cb61-401"><a href="#cb61-401"></a><span class="st">::: {.g-col-6}</span></span>
<span id="cb61-402"><a href="#cb61-402"></a><span class="st">In `data.table` filtering is not in place and you will need to assign the dataset (to itself) for the changes to propagate.</span></span>
<span id="cb61-403"><a href="#cb61-403"></a><span class="st">:::</span></span>
<span id="cb61-404"><a href="#cb61-404"></a><span class="st">:::</span></span>
<span id="cb61-405"><a href="#cb61-405"></a></span>
<span id="cb61-406"><a href="#cb61-406"></a><span class="st">::: {.grid}</span></span>
<span id="cb61-407"><a href="#cb61-407"></a><span class="st">::: {.g-col-6}</span></span>
<span id="cb61-408"><a href="#cb61-408"></a><span class="st">```{.julia}</span></span>
<span id="cb61-409"><a href="#cb61-409"></a><span class="st">dat[1:200, :]</span></span>
<span id="cb61-410"><a href="#cb61-410"></a><span class="st">subset(dat, :day =&gt; x -&gt; x .&gt; 5 .&amp; x .&lt; 10) # from dataframes base</span></span>
<span id="cb61-411"><a href="#cb61-411"></a><span class="dt">@subset</span><span class="st">(dat, :day .&gt; 5 .&amp; :day .&lt; 10) # note the `.` for broadcasting</span></span>
<span id="cb61-412"><a href="#cb61-412"></a><span class="dt">@rsubset</span><span class="st">(dat, :day &gt; 5 &amp; :day &lt; 10)  # note the `r` for change by row</span></span>
<span id="cb61-413"><a href="#cb61-413"></a><span class="dt">@rsubset</span><span class="st">!(dat, :day &gt; 5 &amp; :day &lt; 10) # change in place</span></span>
<span id="cb61-414"><a href="#cb61-414"></a><span class="dt">@rsubset</span><span class="st">(dat, :origin == </span><span class="ot">"</span>LGA<span class="ot">"</span><span class="st">)</span></span>
<span id="cb61-415"><a href="#cb61-415"></a><span class="dt">@rsubset</span><span class="st">(dat, occursin(r</span><span class="ot">"</span>^LG<span class="ot">"</span><span class="st">, :origin))</span></span>
<span id="cb61-416"><a href="#cb61-416"></a><span class="dt">@rsubset</span><span class="st">(dat, :month ∈ [3, 4, 11, 12])</span></span>
<span id="cb61-417"><a href="#cb61-417"></a><span class="dt">@rsubset</span><span class="st">(dat, :origin ∈ [</span><span class="ot">"</span>JFK<span class="ot">"</span><span class="st">, </span><span class="ot">"</span>LGA<span class="ot">"</span><span class="st">])</span></span>
<span id="cb61-418"><a href="#cb61-418"></a><span class="dt">@rsubset</span><span class="st">(dat, :month != 1)</span></span>
<span id="cb61-419"><a href="#cb61-419"></a><span class="st">```</span></span>
<span id="cb61-420"><a href="#cb61-420"></a><span class="st">:::</span></span>
<span id="cb61-421"><a href="#cb61-421"></a></span>
<span id="cb61-422"><a href="#cb61-422"></a><span class="st">::: {.g-col-6}</span></span>
<span id="cb61-423"><a href="#cb61-423"></a><span class="st">```{.r}</span></span>
<span id="cb61-424"><a href="#cb61-424"></a><span class="st">dat[1:200] </span></span>
<span id="cb61-425"><a href="#cb61-425"></a><span class="st">dat[day &gt; 5 &amp; day &lt; 10]        # filtering only</span></span>
<span id="cb61-426"><a href="#cb61-426"></a></span>
<span id="cb61-427"><a href="#cb61-427"></a></span>
<span id="cb61-428"><a href="#cb61-428"></a><span class="st">dat = dat[day &gt; 5 &amp; day &lt; 10]  # filtering and reassigning</span></span>
<span id="cb61-429"><a href="#cb61-429"></a><span class="st">dat[origin==</span><span class="ot">"</span>LGA<span class="ot">"</span><span class="st">]</span></span>
<span id="cb61-430"><a href="#cb61-430"></a><span class="st">dat[origin </span><span class="dt">%like</span><span class="st">% </span><span class="ot">"</span>^LG<span class="ot">"</span><span class="st">] </span></span>
<span id="cb61-431"><a href="#cb61-431"></a><span class="st">dat[month </span><span class="dt">%in</span><span class="st">% c(3,4,11,12)] </span></span>
<span id="cb61-432"><a href="#cb61-432"></a><span class="st">dat[origin </span><span class="dt">%chin</span><span class="st">% c(</span><span class="ot">"</span>JFK<span class="ot">"</span><span class="st">,</span><span class="ot">"</span>LGA<span class="ot">"</span><span class="st">)] # </span><span class="dt">%chin</span><span class="st">% is a fast </span><span class="dt">%in</span><span class="st">% for characters </span></span>
<span id="cb61-433"><a href="#cb61-433"></a><span class="st">dat[month!=1]</span></span>
<span id="cb61-434"><a href="#cb61-434"></a><span class="st">```</span></span>
<span id="cb61-435"><a href="#cb61-435"></a><span class="st">:::</span></span>
<span id="cb61-436"><a href="#cb61-436"></a><span class="st">:::</span></span>
<span id="cb61-437"><a href="#cb61-437"></a></span>
<span id="cb61-438"><a href="#cb61-438"></a><span class="st">#### On the Freedman data (with missing values)</span></span>
<span id="cb61-439"><a href="#cb61-439"></a></span>
<span id="cb61-440"><a href="#cb61-440"></a><span class="st">In this case we need to be careful on how we deal with missing data. </span></span>
<span id="cb61-441"><a href="#cb61-441"></a><span class="st">Note that to find the missings julia uses the `isequal` function (because `missing===missing` returns missing).</span></span>
<span id="cb61-442"><a href="#cb61-442"></a></span>
<span id="cb61-443"><a href="#cb61-443"></a><span class="st">::: {.grid}</span></span>
<span id="cb61-444"><a href="#cb61-444"></a><span class="st">::: {.g-col-6}</span></span>
<span id="cb61-445"><a href="#cb61-445"></a><span class="st">```{.julia}</span></span>
<span id="cb61-446"><a href="#cb61-446"></a><span class="st">subset(dat_missing, :Population =&gt; x -&gt; x .&lt; 1000; skipmissing=true)</span></span>
<span id="cb61-447"><a href="#cb61-447"></a><span class="dt">@rsubset</span><span class="st">(dat_missing, :Population .&lt; 1000) # treats missing values as false by default</span></span>
<span id="cb61-448"><a href="#cb61-448"></a><span class="dt">@rsubset</span><span class="st">(dat_missing, isequal(:Population, missing) )</span></span>
<span id="cb61-449"><a href="#cb61-449"></a><span class="st">```</span></span>
<span id="cb61-450"><a href="#cb61-450"></a><span class="st">:::</span></span>
<span id="cb61-451"><a href="#cb61-451"></a></span>
<span id="cb61-452"><a href="#cb61-452"></a><span class="st">::: {.g-col-6}</span></span>
<span id="cb61-453"><a href="#cb61-453"></a><span class="st">```{.r}</span></span>
<span id="cb61-454"><a href="#cb61-454"></a><span class="st">dat_missing[ population &lt; 1000 ]</span></span>
<span id="cb61-455"><a href="#cb61-455"></a></span>
<span id="cb61-456"><a href="#cb61-456"></a><span class="st">dat_missing[is.na(population)]</span></span>
<span id="cb61-457"><a href="#cb61-457"></a><span class="st">```</span></span>
<span id="cb61-458"><a href="#cb61-458"></a><span class="st">:::</span></span>
<span id="cb61-459"><a href="#cb61-459"></a><span class="st">:::</span></span>
<span id="cb61-460"><a href="#cb61-460"></a></span>
<span id="cb61-461"><a href="#cb61-461"></a><span class="st">## Dropping duplicate or missing values</span></span>
<span id="cb61-462"><a href="#cb61-462"></a></span>
<span id="cb61-463"><a href="#cb61-463"></a><span class="st">#### Drop duplicate values</span></span>
<span id="cb61-464"><a href="#cb61-464"></a><span class="st">::: {.grid}</span></span>
<span id="cb61-465"><a href="#cb61-465"></a><span class="st">::: {.g-col-6}</span></span>
<span id="cb61-466"><a href="#cb61-466"></a><span class="st">```{.julia}</span></span>
<span id="cb61-467"><a href="#cb61-467"></a><span class="st">unique(dat; keep=:first)  # default</span></span>
<span id="cb61-468"><a href="#cb61-468"></a><span class="st">unique!(dat; keep=:first) # in place</span></span>
<span id="cb61-469"><a href="#cb61-469"></a><span class="st">unique(dat; keep=:noduplicates) # :last also an option</span></span>
<span id="cb61-470"><a href="#cb61-470"></a><span class="st">unique(dat, [:month, :day, :carrier])</span></span>
<span id="cb61-471"><a href="#cb61-471"></a><span class="st">```</span></span>
<span id="cb61-472"><a href="#cb61-472"></a><span class="st">:::</span></span>
<span id="cb61-473"><a href="#cb61-473"></a></span>
<span id="cb61-474"><a href="#cb61-474"></a><span class="st">::: {.g-col-6}</span></span>
<span id="cb61-475"><a href="#cb61-475"></a><span class="st">```{.r}</span></span>
<span id="cb61-476"><a href="#cb61-476"></a><span class="st">unique(dat) </span></span>
<span id="cb61-477"><a href="#cb61-477"></a><span class="st">dat = unique(dat) </span></span>
<span id="cb61-478"><a href="#cb61-478"></a></span>
<span id="cb61-479"><a href="#cb61-479"></a><span class="st">unique(dat, by = c(</span><span class="ot">"</span>month<span class="ot">"</span><span class="st">, </span><span class="ot">"</span>day<span class="ot">"</span><span class="st">, </span><span class="ot">"</span>carrier<span class="ot">"</span><span class="st">))</span></span>
<span id="cb61-480"><a href="#cb61-480"></a><span class="st">```</span></span>
<span id="cb61-481"><a href="#cb61-481"></a><span class="st">:::</span></span>
<span id="cb61-482"><a href="#cb61-482"></a><span class="st">:::</span></span>
<span id="cb61-483"><a href="#cb61-483"></a></span>
<span id="cb61-484"><a href="#cb61-484"></a><span class="st">#### Drop missing values</span></span>
<span id="cb61-485"><a href="#cb61-485"></a><span class="st">::: {.grid}</span></span>
<span id="cb61-486"><a href="#cb61-486"></a><span class="st">::: {.g-col-6}</span></span>
<span id="cb61-487"><a href="#cb61-487"></a><span class="st">```{.julia}</span></span>
<span id="cb61-488"><a href="#cb61-488"></a><span class="st">dropmissing(dat_missing)</span></span>
<span id="cb61-489"><a href="#cb61-489"></a><span class="st">dropmissing!(dat_missing) # in place</span></span>
<span id="cb61-490"><a href="#cb61-490"></a><span class="st">dropmissing(dat_missing, :Population)</span></span>
<span id="cb61-491"><a href="#cb61-491"></a><span class="st">dropmissing(dat_missing, [:Population, :Density])</span></span>
<span id="cb61-492"><a href="#cb61-492"></a></span>
<span id="cb61-493"><a href="#cb61-493"></a><span class="st"># if the column type still include missing values convert the array to non missing types</span></span>
<span id="cb61-494"><a href="#cb61-494"></a><span class="st">disallowmissing(dat_missing)</span></span>
<span id="cb61-495"><a href="#cb61-495"></a><span class="st">disallowmissing(dat_missing, :Density)</span></span>
<span id="cb61-496"><a href="#cb61-496"></a><span class="st">```</span></span>
<span id="cb61-497"><a href="#cb61-497"></a><span class="st">:::</span></span>
<span id="cb61-498"><a href="#cb61-498"></a></span>
<span id="cb61-499"><a href="#cb61-499"></a><span class="st">::: {.g-col-6}</span></span>
<span id="cb61-500"><a href="#cb61-500"></a><span class="st">```{.r}</span></span>
<span id="cb61-501"><a href="#cb61-501"></a><span class="st">na.omit(dat_missing) </span></span>
<span id="cb61-502"><a href="#cb61-502"></a><span class="st">dat_missing = na.omit(dat_missing) </span></span>
<span id="cb61-503"><a href="#cb61-503"></a></span>
<span id="cb61-504"><a href="#cb61-504"></a><span class="st">dat_missing[!is.na(population)]</span></span>
<span id="cb61-505"><a href="#cb61-505"></a><span class="st">dat_missing[!is.na(population) &amp; !is.na(density)]</span></span>
<span id="cb61-506"><a href="#cb61-506"></a><span class="st">```</span></span>
<span id="cb61-507"><a href="#cb61-507"></a><span class="st">:::</span></span>
<span id="cb61-508"><a href="#cb61-508"></a><span class="st">:::</span></span>
<span id="cb61-509"><a href="#cb61-509"></a></span>
<span id="cb61-510"><a href="#cb61-510"></a><span class="st">## Selecting columns</span></span>
<span id="cb61-511"><a href="#cb61-511"></a></span>
<span id="cb61-512"><a href="#cb61-512"></a><span class="st">::: {.grid}</span></span>
<span id="cb61-513"><a href="#cb61-513"></a><span class="st">::: {.g-col-6}</span></span>
<span id="cb61-514"><a href="#cb61-514"></a><span class="st">```{.julia}</span></span>
<span id="cb61-515"><a href="#cb61-515"></a><span class="st"># select columns</span></span>
<span id="cb61-516"><a href="#cb61-516"></a><span class="st">select(dat, :month, :day, :carrier)</span></span>
<span id="cb61-517"><a href="#cb61-517"></a><span class="st">select!(dat, :month, :day, :carrier)   # in place</span></span>
<span id="cb61-518"><a href="#cb61-518"></a><span class="st">select(dat, </span><span class="ot">"</span>month<span class="ot">"</span><span class="st">, </span><span class="ot">"</span>day<span class="ot">"</span><span class="st">, </span><span class="ot">"</span>carrier<span class="ot">"</span><span class="st">) # also works</span></span>
<span id="cb61-519"><a href="#cb61-519"></a><span class="st">select(dat, r</span><span class="ot">"</span>_delay<span class="ot">"</span><span class="st">)</span></span>
<span id="cb61-520"><a href="#cb61-520"></a><span class="st">select(dat, .!(eltype.(eachcol(dat)) .&lt;: AbstractString) )</span></span>
<span id="cb61-521"><a href="#cb61-521"></a><span class="st">select(dat_missing, (eltype.(eachcol(dat_missing)) .&lt;: Union{Missing, Int}) ) # if some columns include missing</span></span>
<span id="cb61-522"><a href="#cb61-522"></a></span>
<span id="cb61-523"><a href="#cb61-523"></a><span class="st"># removing select columns</span></span>
<span id="cb61-524"><a href="#cb61-524"></a><span class="st">select(dat, Not([:origin, :dest]))</span></span>
<span id="cb61-525"><a href="#cb61-525"></a><span class="st">select!(dat, Not([:origin, :dest])) # in place</span></span>
<span id="cb61-526"><a href="#cb61-526"></a><span class="st">```</span></span>
<span id="cb61-527"><a href="#cb61-527"></a><span class="st">:::</span></span>
<span id="cb61-528"><a href="#cb61-528"></a></span>
<span id="cb61-529"><a href="#cb61-529"></a><span class="st">::: {.g-col-6}</span></span>
<span id="cb61-530"><a href="#cb61-530"></a><span class="st">```{.r}</span></span>
<span id="cb61-531"><a href="#cb61-531"></a><span class="st"># select columns</span></span>
<span id="cb61-532"><a href="#cb61-532"></a><span class="st">dat[, .(month, day, carrier)] </span></span>
<span id="cb61-533"><a href="#cb61-533"></a><span class="st">dat = dat[, .(month, day, carrier)] # </span><span class="ot">"</span>in place<span class="ot">"</span></span>
<span id="cb61-534"><a href="#cb61-534"></a><span class="st">dat[, c(</span><span class="ot">"</span>month<span class="ot">"</span><span class="st">, </span><span class="ot">"</span>day<span class="ot">"</span><span class="st">, </span><span class="ot">"</span>carrier<span class="ot">"</span><span class="st">)] # same but programmatic</span></span>
<span id="cb61-535"><a href="#cb61-535"></a><span class="st">dat[, .SD, .SDcols=patterns(</span><span class="ot">"</span><span class="dt">*_delay</span><span class="ot">"</span><span class="st">)] # keep columns by matching</span></span>
<span id="cb61-536"><a href="#cb61-536"></a><span class="st">dat[, .SD, .SDcols=!is.character]       # keep columns by type</span></span>
<span id="cb61-537"><a href="#cb61-537"></a></span>
<span id="cb61-538"><a href="#cb61-538"></a></span>
<span id="cb61-539"><a href="#cb61-539"></a><span class="st"># removing select columns</span></span>
<span id="cb61-540"><a href="#cb61-540"></a><span class="st">dat[, -c(</span><span class="ot">"</span>origin<span class="ot">"</span><span class="st">, </span><span class="ot">"</span>dest<span class="ot">"</span><span class="st">)]</span></span>
<span id="cb61-541"><a href="#cb61-541"></a><span class="st">dat[, c(</span><span class="ot">"</span>origin<span class="ot">"</span><span class="st">, </span><span class="ot">"</span>dest<span class="ot">"</span><span class="st">) := NULL] # same, but in-place </span></span>
<span id="cb61-542"><a href="#cb61-542"></a><span class="st">```</span></span>
<span id="cb61-543"><a href="#cb61-543"></a><span class="st">:::</span></span>
<span id="cb61-544"><a href="#cb61-544"></a><span class="st">:::</span></span>
<span id="cb61-545"><a href="#cb61-545"></a></span>
<span id="cb61-546"><a href="#cb61-546"></a><span class="st">## Rows and columns</span></span>
<span id="cb61-547"><a href="#cb61-547"></a></span>
<span id="cb61-548"><a href="#cb61-548"></a></span>
<span id="cb61-549"><a href="#cb61-549"></a><span class="st">::: {.grid}</span></span>
<span id="cb61-550"><a href="#cb61-550"></a><span class="st">::: {.g-col-6}</span></span>
<span id="cb61-551"><a href="#cb61-551"></a><span class="st">```{.julia}</span></span>
<span id="cb61-552"><a href="#cb61-552"></a><span class="dt">@select</span><span class="st">(</span><span class="dt">@rsubset</span><span class="st">(dat, :origin==</span><span class="ot">"</span>LGA<span class="ot">"</span><span class="st">), </span></span>
<span id="cb61-553"><a href="#cb61-553"></a><span class="st">    :month, :day, :carrier)</span></span>
<span id="cb61-554"><a href="#cb61-554"></a><span class="dt">@pipe</span><span class="st"> dat |&gt; </span><span class="dt">@rsubset</span><span class="st">(_, :origin==</span><span class="ot">"</span>LGA<span class="ot">"</span><span class="st">) |&gt; </span></span>
<span id="cb61-555"><a href="#cb61-555"></a><span class="st">    </span><span class="dt">@select</span><span class="st">(_, :month, :day, :carrier)</span></span>
<span id="cb61-556"><a href="#cb61-556"></a><span class="st">```</span></span>
<span id="cb61-557"><a href="#cb61-557"></a><span class="st">:::</span></span>
<span id="cb61-558"><a href="#cb61-558"></a></span>
<span id="cb61-559"><a href="#cb61-559"></a><span class="st">::: {.g-col-6}</span></span>
<span id="cb61-560"><a href="#cb61-560"></a><span class="st">```{.r}</span></span>
<span id="cb61-561"><a href="#cb61-561"></a><span class="st">dat[origin==</span><span class="ot">"</span>LGA<span class="ot">"</span><span class="st">, .(month, day, carrier)]</span></span>
<span id="cb61-562"><a href="#cb61-562"></a><span class="st">```</span></span>
<span id="cb61-563"><a href="#cb61-563"></a><span class="st">:::</span></span>
<span id="cb61-564"><a href="#cb61-564"></a><span class="st">:::</span></span>
<span id="cb61-565"><a href="#cb61-565"></a></span>
<span id="cb61-566"><a href="#cb61-566"></a></span>
<span id="cb61-567"><a href="#cb61-567"></a></span>
<span id="cb61-568"><a href="#cb61-568"></a><span class="st">&lt;!-- ----------------------------------------------------------------------------------- --&gt;</span></span>
<span id="cb61-569"><a href="#cb61-569"></a><span class="st"># Creating/modifying variables</span></span>
<span id="cb61-570"><a href="#cb61-570"></a></span>
<span id="cb61-571"><a href="#cb61-571"></a><span class="st">## Basic operations</span></span>
<span id="cb61-572"><a href="#cb61-572"></a></span>
<span id="cb61-573"><a href="#cb61-573"></a><span class="st">::: {.grid}</span></span>
<span id="cb61-574"><a href="#cb61-574"></a><span class="st">::: {.g-col-6}</span></span>
<span id="cb61-575"><a href="#cb61-575"></a><span class="st">```{.julia}</span></span>
<span id="cb61-576"><a href="#cb61-576"></a><span class="dt">@transform</span><span class="st">!(dat, :tot_delay = :dep_delay + :arr_delay)</span></span>
<span id="cb61-577"><a href="#cb61-577"></a><span class="dt">@rtransform</span><span class="st">!(dat, :segment = :origin * :dest) # rowwise operation</span></span>
<span id="cb61-578"><a href="#cb61-578"></a></span>
<span id="cb61-579"><a href="#cb61-579"></a><span class="st"># Programmatic version</span></span>
<span id="cb61-580"><a href="#cb61-580"></a><span class="st">x = </span><span class="ot">"</span>dep_delay<span class="ot">"</span><span class="st">; y = </span><span class="ot">"</span>arr_delay<span class="ot">"</span><span class="st">; z = </span><span class="ot">"</span>tot_delay<span class="ot">"</span><span class="st">;</span></span>
<span id="cb61-581"><a href="#cb61-581"></a><span class="dt">@transform</span><span class="st">!(dat, </span><span class="dt">$z</span><span class="st"> = </span><span class="dt">$x</span><span class="st"> + </span><span class="dt">$y</span><span class="st">)</span></span>
<span id="cb61-582"><a href="#cb61-582"></a></span>
<span id="cb61-583"><a href="#cb61-583"></a><span class="st"># Conditional modification </span></span>
<span id="cb61-584"><a href="#cb61-584"></a><span class="st">dat[dat.month.==9, :distance] = dat[dat.month.==9, :distance] .+ 1;</span></span>
<span id="cb61-585"><a href="#cb61-585"></a><span class="st">dat[1:2, :air_time] .= 0;</span></span>
<span id="cb61-586"><a href="#cb61-586"></a><span class="st"># Or with missing values</span></span>
<span id="cb61-587"><a href="#cb61-587"></a><span class="st">dat_missing[isequal.(dat_missing.Population, missing), :City] .= </span><span class="ot">"</span>NOPOP<span class="ot">"</span><span class="st">;</span></span>
<span id="cb61-588"><a href="#cb61-588"></a><span class="st">```</span></span>
<span id="cb61-589"><a href="#cb61-589"></a><span class="st">:::</span></span>
<span id="cb61-590"><a href="#cb61-590"></a></span>
<span id="cb61-591"><a href="#cb61-591"></a><span class="st">::: {.g-col-6}</span></span>
<span id="cb61-592"><a href="#cb61-592"></a><span class="st">```{.r}</span></span>
<span id="cb61-593"><a href="#cb61-593"></a><span class="st">dat[, tot_delay := dep_delay + arr_delay] </span></span>
<span id="cb61-594"><a href="#cb61-594"></a><span class="st">dat[, segment := paste0(origin, dest) ]</span></span>
<span id="cb61-595"><a href="#cb61-595"></a></span>
<span id="cb61-596"><a href="#cb61-596"></a><span class="st"># Programmatic version</span></span>
<span id="cb61-597"><a href="#cb61-597"></a><span class="st">x = </span><span class="ot">"</span>dep_delay<span class="ot">"</span><span class="st">; y = </span><span class="ot">"</span>arr_delay<span class="ot">"</span><span class="st">; z = </span><span class="ot">"</span>tot_delay<span class="ot">"</span></span>
<span id="cb61-598"><a href="#cb61-598"></a><span class="st">dat[, c(z) := get(x) + get(y) ]</span></span>
<span id="cb61-599"><a href="#cb61-599"></a></span>
<span id="cb61-600"><a href="#cb61-600"></a><span class="st"># Conditional modification </span></span>
<span id="cb61-601"><a href="#cb61-601"></a><span class="st">dat[month==9, distance := distance + 1]</span></span>
<span id="cb61-602"><a href="#cb61-602"></a><span class="st">dat[1:2, origin := </span><span class="ot">"</span>OBS<span class="ot">"</span><span class="st">]</span></span>
<span id="cb61-603"><a href="#cb61-603"></a><span class="st"># Or with missing values</span></span>
<span id="cb61-604"><a href="#cb61-604"></a><span class="st">dat_missing[is.na(population), City := </span><span class="ot">"</span>NOPOP<span class="ot">"</span><span class="st">]</span></span>
<span id="cb61-605"><a href="#cb61-605"></a><span class="st">```</span></span>
<span id="cb61-606"><a href="#cb61-606"></a><span class="st">:::</span></span>
<span id="cb61-607"><a href="#cb61-607"></a><span class="st">:::</span></span>
<span id="cb61-608"><a href="#cb61-608"></a></span>
<span id="cb61-609"><a href="#cb61-609"></a></span>
<span id="cb61-610"><a href="#cb61-610"></a></span>
<span id="cb61-611"><a href="#cb61-611"></a></span>
<span id="cb61-612"><a href="#cb61-612"></a><span class="st">## Grouped operations</span></span>
<span id="cb61-613"><a href="#cb61-613"></a></span>
<span id="cb61-614"><a href="#cb61-614"></a><span class="st">::: {.grid}</span></span>
<span id="cb61-615"><a href="#cb61-615"></a><span class="st">::: {.g-col-6}</span></span>
<span id="cb61-616"><a href="#cb61-616"></a><span class="st">```{.julia}</span></span>
<span id="cb61-617"><a href="#cb61-617"></a><span class="dt">@pipe</span><span class="st"> dat |&gt; groupby(_, :carrier) |&gt; </span></span>
<span id="cb61-618"><a href="#cb61-618"></a><span class="st">    </span><span class="dt">@transform</span><span class="st">!(_, :avg_arr_delay = mean(:arr_delay)) # in place</span></span>
<span id="cb61-619"><a href="#cb61-619"></a><span class="dt">@pipe</span><span class="st"> dat |&gt; groupby(_, :carrier) |&gt; </span></span>
<span id="cb61-620"><a href="#cb61-620"></a><span class="st">    </span><span class="dt">@combine</span><span class="st">(_, :avg_arr_delay = mean(:arr_delay))</span></span>
<span id="cb61-621"><a href="#cb61-621"></a><span class="st">```</span></span>
<span id="cb61-622"><a href="#cb61-622"></a></span>
<span id="cb61-623"><a href="#cb61-623"></a><span class="st">:::</span></span>
<span id="cb61-624"><a href="#cb61-624"></a></span>
<span id="cb61-625"><a href="#cb61-625"></a><span class="st">::: {.g-col-6}</span></span>
<span id="cb61-626"><a href="#cb61-626"></a><span class="st">```{.r}</span></span>
<span id="cb61-627"><a href="#cb61-627"></a><span class="st">dat[, avg_arr_delay := mean(arr_delay), by=carrier] </span></span>
<span id="cb61-628"><a href="#cb61-628"></a></span>
<span id="cb61-629"><a href="#cb61-629"></a><span class="st">dat[, .(avg_arr_delay = mean(arr_delay, na.rm=T)), by=carrier]  # collapse see aggregation section below</span></span>
<span id="cb61-630"><a href="#cb61-630"></a></span>
<span id="cb61-631"><a href="#cb61-631"></a></span>
<span id="cb61-632"><a href="#cb61-632"></a><span class="st">```</span></span>
<span id="cb61-633"><a href="#cb61-633"></a><span class="st">:::</span></span>
<span id="cb61-634"><a href="#cb61-634"></a><span class="st">:::</span></span>
<span id="cb61-635"><a href="#cb61-635"></a></span>
<span id="cb61-636"><a href="#cb61-636"></a></span>
<span id="cb61-637"><a href="#cb61-637"></a><span class="st">## Leads and lags</span></span>
<span id="cb61-638"><a href="#cb61-638"></a></span>
<span id="cb61-639"><a href="#cb61-639"></a><span class="st">#### Standard leads and lags</span></span>
<span id="cb61-640"><a href="#cb61-640"></a></span>
<span id="cb61-641"><a href="#cb61-641"></a><span class="st">I work with shifts on dates here but the dataset is a full panel with consecutive dates so there is nothing special about the dates variable per-se.</span></span>
<span id="cb61-642"><a href="#cb61-642"></a><span class="st">*It is easier to see this on a smaller dataset. So I aggregate the data to get the total monthly flights out of each origin airport (see last section).*</span></span>
<span id="cb61-643"><a href="#cb61-643"></a></span>
<span id="cb61-644"><a href="#cb61-644"></a><span class="st">::: {.grid}</span></span>
<span id="cb61-645"><a href="#cb61-645"></a></span>
<span id="cb61-646"><a href="#cb61-646"></a><span class="st">::: {.g-col-6}</span></span>
<span id="cb61-647"><a href="#cb61-647"></a><span class="st">For leads and lags on arrays, I use the `ShiftedArrays` package which works fine for standard operations (read: as long as you are not dealing with dates). </span></span>
<span id="cb61-648"><a href="#cb61-648"></a><span class="st">:::</span></span>
<span id="cb61-649"><a href="#cb61-649"></a></span>
<span id="cb61-650"><a href="#cb61-650"></a><span class="st">::: {.g-col-6}</span></span>
<span id="cb61-651"><a href="#cb61-651"></a><span class="st">For standard leads and lags, it is faster to use the built-in `shift` function from data.table. </span></span>
<span id="cb61-652"><a href="#cb61-652"></a><span class="st">:::</span></span>
<span id="cb61-653"><a href="#cb61-653"></a></span>
<span id="cb61-654"><a href="#cb61-654"></a><span class="st">:::</span></span>
<span id="cb61-655"><a href="#cb61-655"></a></span>
<span id="cb61-656"><a href="#cb61-656"></a><span class="st">::: {.grid}</span></span>
<span id="cb61-657"><a href="#cb61-657"></a><span class="st">::: {.g-col-6}</span></span>
<span id="cb61-658"><a href="#cb61-658"></a><span class="st">```{.julia}</span></span>
<span id="cb61-659"><a href="#cb61-659"></a><span class="st">dat_shift = combine(</span></span>
<span id="cb61-660"><a href="#cb61-660"></a><span class="st">    groupby(dat, [:origin, :month]), </span></span>
<span id="cb61-661"><a href="#cb61-661"></a><span class="st">    nrow =&gt; :N)</span></span>
<span id="cb61-662"><a href="#cb61-662"></a><span class="st">sort!(dat_shift, [:origin, :month])    </span></span>
<span id="cb61-663"><a href="#cb61-663"></a></span>
<span id="cb61-664"><a href="#cb61-664"></a><span class="dt">@transform</span><span class="st">!(groupby(dat_shift, :origin), </span></span>
<span id="cb61-665"><a href="#cb61-665"></a><span class="st">    :growth = :N ./ ShiftedArrays.lag(:N, 1))</span></span>
<span id="cb61-666"><a href="#cb61-666"></a><span class="dt">@transform</span><span class="st">!(groupby(dat_shift, :origin), </span></span>
<span id="cb61-667"><a href="#cb61-667"></a><span class="st">    :growth_since_first = :N ./ :N[1] )</span></span>
<span id="cb61-668"><a href="#cb61-668"></a></span>
<span id="cb61-669"><a href="#cb61-669"></a><span class="st"># The following is probably not optimal; here are two versions</span></span>
<span id="cb61-670"><a href="#cb61-670"></a><span class="dt">@pipe</span><span class="st"> dat_shift |&gt; </span></span>
<span id="cb61-671"><a href="#cb61-671"></a><span class="st">    groupby(_, :origin) |&gt; </span><span class="dt">@subset</span><span class="st">(_, 5 ∈ :month) |&gt;  # this errors if month 5 is missing in a group</span></span>
<span id="cb61-672"><a href="#cb61-672"></a><span class="st">    groupby(_, :origin) |&gt; </span><span class="dt">@transform</span><span class="st">(_, :growth_since_may = :N ./ :N[:month.==5])</span></span>
<span id="cb61-673"><a href="#cb61-673"></a><span class="st">for subdf in groupby(dat_shift, :origin)    </span></span>
<span id="cb61-674"><a href="#cb61-674"></a><span class="st">    if 5 ∈ subdf.month</span></span>
<span id="cb61-675"><a href="#cb61-675"></a><span class="st">        </span><span class="dt">@transform</span><span class="st">!(subdf, :growth_since_may = :N ./ :N[:month.==5])</span></span>
<span id="cb61-676"><a href="#cb61-676"></a><span class="st">    end</span></span>
<span id="cb61-677"><a href="#cb61-677"></a><span class="st">end</span></span>
<span id="cb61-678"><a href="#cb61-678"></a><span class="st">```</span></span>
<span id="cb61-679"><a href="#cb61-679"></a><span class="st">:::</span></span>
<span id="cb61-680"><a href="#cb61-680"></a></span>
<span id="cb61-681"><a href="#cb61-681"></a><span class="st">::: {.g-col-6}</span></span>
<span id="cb61-682"><a href="#cb61-682"></a><span class="st">```{.r}</span></span>
<span id="cb61-683"><a href="#cb61-683"></a><span class="st">dat_shift = dat[, .N, by = .(origin, month)]</span></span>
<span id="cb61-684"><a href="#cb61-684"></a><span class="st">setorder(dat_shift, origin, month)</span></span>
<span id="cb61-685"><a href="#cb61-685"></a></span>
<span id="cb61-686"><a href="#cb61-686"></a></span>
<span id="cb61-687"><a href="#cb61-687"></a></span>
<span id="cb61-688"><a href="#cb61-688"></a><span class="st">dat_shift[, growth := N/shift(N, 1), by = origin]</span></span>
<span id="cb61-689"><a href="#cb61-689"></a></span>
<span id="cb61-690"><a href="#cb61-690"></a><span class="st">dat_shift[, growth_since_first := N/N[1], by = origin] </span></span>
<span id="cb61-691"><a href="#cb61-691"></a></span>
<span id="cb61-692"><a href="#cb61-692"></a><span class="st">dat_shift[, growth_since_may := N/N[month==5], by = origin]</span></span>
<span id="cb61-693"><a href="#cb61-693"></a><span class="st">dat_shift[, growth_since_may := .SD[[</span><span class="ot">"</span>N<span class="ot">"</span><span class="st">]]/.SD[month==5][[</span><span class="ot">"</span>N<span class="ot">"</span><span class="st">]], </span></span>
<span id="cb61-694"><a href="#cb61-694"></a><span class="st">    .SDcols = c(</span><span class="ot">"</span>N<span class="ot">"</span><span class="st">, </span><span class="ot">"</span>month<span class="ot">"</span><span class="st">), by = origin]</span></span>
<span id="cb61-695"><a href="#cb61-695"></a><span class="st">```</span></span>
<span id="cb61-696"><a href="#cb61-696"></a></span>
<span id="cb61-697"><a href="#cb61-697"></a><span class="st">:::</span></span>
<span id="cb61-698"><a href="#cb61-698"></a><span class="st">:::</span></span>
<span id="cb61-699"><a href="#cb61-699"></a></span>
<span id="cb61-700"><a href="#cb61-700"></a><span class="st">#### The case of dates</span></span>
<span id="cb61-701"><a href="#cb61-701"></a></span>
<span id="cb61-702"><a href="#cb61-702"></a><span class="st">Dates are messy (imho). </span></span>
<span id="cb61-703"><a href="#cb61-703"></a><span class="st">Lagging a variable by three months in a monthly panel does not necessarily translate into shifting the data by 3 indices (if the panel is unbalanced for example). </span></span>
<span id="cb61-704"><a href="#cb61-704"></a><span class="st">The correct date function should check that </span><span class="ot">"</span>shifting<span class="ot">"</span><span class="st"> by three months in April corresponds to January and not December (if January is missing). </span></span>
<span id="cb61-705"><a href="#cb61-705"></a></span>
<span id="cb61-706"><a href="#cb61-706"></a><span class="st">::: {.grid}</span></span>
<span id="cb61-707"><a href="#cb61-707"></a></span>
<span id="cb61-708"><a href="#cb61-708"></a><span class="st">::: {.g-col-6}</span></span>
<span id="cb61-709"><a href="#cb61-709"></a><span class="st">```{.julia}</span></span>
<span id="cb61-710"><a href="#cb61-710"></a><span class="dt">@rtransform</span><span class="st">!(dat, :date = Date(:year, :month, :day) )</span></span>
<span id="cb61-711"><a href="#cb61-711"></a></span>
<span id="cb61-712"><a href="#cb61-712"></a></span>
<span id="cb61-713"><a href="#cb61-713"></a><span class="st"># Including time</span></span>
<span id="cb61-714"><a href="#cb61-714"></a><span class="dt">@rtransform</span><span class="st">!(dat, :date_time = DateTime(:year, :month, :day, :hour) )</span></span>
<span id="cb61-715"><a href="#cb61-715"></a></span>
<span id="cb61-716"><a href="#cb61-716"></a><span class="dt">@rtransform</span><span class="st">!(dat, :date_y = year(:date))</span></span>
<span id="cb61-717"><a href="#cb61-717"></a><span class="dt">@rtransform</span><span class="st">!(dat, :f7d_date = :date + Dates.Day(7))</span></span>
<span id="cb61-718"><a href="#cb61-718"></a><span class="dt">@rtransform</span><span class="st">!(dat, :l3m_date = :date - Dates.Month(3))</span></span>
<span id="cb61-719"><a href="#cb61-719"></a></span>
<span id="cb61-720"><a href="#cb61-720"></a><span class="st">```</span></span>
<span id="cb61-721"><a href="#cb61-721"></a><span class="st">:::</span></span>
<span id="cb61-722"><a href="#cb61-722"></a></span>
<span id="cb61-723"><a href="#cb61-723"></a><span class="st">::: {.g-col-6}</span></span>
<span id="cb61-724"><a href="#cb61-724"></a><span class="st">```{.r}</span></span>
<span id="cb61-725"><a href="#cb61-725"></a><span class="st"># Make a date variable using data.table built-in IDate</span></span>
<span id="cb61-726"><a href="#cb61-726"></a><span class="st">dat[, date := as.IDate(paste(year, month, day, sep='-'))] </span></span>
<span id="cb61-727"><a href="#cb61-727"></a><span class="st"># It is usually faster to use lubridate parser </span></span>
<span id="cb61-728"><a href="#cb61-728"></a><span class="st">dat[, date := parse_date_time2(paste(year, month, day, sep='-'), </span><span class="ot">"</span>Y-<span class="ot">m-d"</span><span class="ch">)</span><span class="ot">]</span></span>
<span id="cb61-729"><a href="#cb61-729"></a><span class="ot">dat</span><span class="ch">[</span><span class="bn">, date_time := parse_date_time2(paste(year, month, day, hour, sep='-'), "Y-m-d-H")</span><span class="ch">]</span></span>
<span id="cb61-730"><a href="#cb61-730"></a></span>
<span id="cb61-731"><a href="#cb61-731"></a><span class="ot">dat</span><span class="ch">[</span><span class="bn">, date_y := year(date)</span><span class="ch">]</span><span class="ot"> # extract year</span></span>
<span id="cb61-732"><a href="#cb61-732"></a><span class="ot">dat</span><span class="ch">[</span><span class="bn">, f7d_date := date + days(7) </span><span class="ch">]</span><span class="co">   # date in 7 days</span></span>
<span id="cb61-733"><a href="#cb61-733"></a><span class="ot">dat</span><span class="ch">[</span><span class="bn">, l3m_date := date - months(3) </span><span class="ch">]</span><span class="ot"> # date three months ago</span></span>
<span id="cb61-734"><a href="#cb61-734"></a></span>
<span id="cb61-735"><a href="#cb61-735"></a><span class="ot">```</span></span>
<span id="cb61-736"><a href="#cb61-736"></a><span class="ot">:::</span></span>
<span id="cb61-737"><a href="#cb61-737"></a></span>
<span id="cb61-738"><a href="#cb61-738"></a><span class="ot">:::</span></span>
<span id="cb61-739"><a href="#cb61-739"></a></span>
<span id="cb61-740"><a href="#cb61-740"></a><span class="ot">Once we know how to lag dates, we would like to answer questions such as: </span></span>
<span id="cb61-741"><a href="#cb61-741"></a><span class="ch">*</span><span class="ot">what was the average flight delay for each origin airport three months ago compared to today</span><span class="ch">?*</span></span>
<span id="cb61-742"><a href="#cb61-742"></a><span class="ot">We will work with the aggregate delays by origins.</span></span>
<span id="cb61-743"><a href="#cb61-743"></a></span>
<span id="cb61-744"><a href="#cb61-744"></a></span>
<span id="cb61-745"><a href="#cb61-745"></a><span class="ot">::: {.grid}</span></span>
<span id="cb61-746"><a href="#cb61-746"></a></span>
<span id="cb61-747"><a href="#cb61-747"></a><span class="ot">::: {.g-co</span>l<span class="dv">-6</span>}</span>
<span id="cb61-748"><a href="#cb61-748"></a></span>
<span id="cb61-749"><a href="#cb61-749"></a>In julia, the <span class="ot">`</span><span class="st">ShiftedArrays</span><span class="ot">`</span> <span class="kw">package</span> does <span class="ot">not</span> support dates (See this post on [discourse](https://discourse.julialang.org/t/ann<span class="ot">-s</span>hiftedarrays-<span class="ot">and-s</span>upport<span class="ot">-f</span>or<span class="ot">-s</span>hiftedarrays-in<span class="ot">-g</span>roupederrors/<span class="dv">9162</span>/<span class="dv">2</span>?u=piever) <span class="ot">and</span> this [issue](https://github.com/JuliaArrays/ShiftedArrays.jl/pull/<span class="dv">37</span><span class="co">#issuecomment-623647440))</span></span>
<span id="cb61-750"><a href="#cb61-750"></a></span>
<span id="cb61-751"><a href="#cb61-751"></a>This is one of the most <span class="dt">*annoying</span><span class="ot">*</span> thing <span class="kw">when</span> working with dates <span class="ot">and</span> panel data in julia.</span>
<span id="cb61-752"><a href="#cb61-752"></a>I have found that <span class="ot">`</span><span class="st">PanelShift.jl</span><span class="ot">`</span> solves the problem but it is still in version <span class="ot">`</span><span class="st">0.1.1</span><span class="ot">`</span> <span class="ot">and</span> it is unclear how many updates it is receiving.</span>
<span id="cb61-753"><a href="#cb61-753"></a>What is nice with julia is that you can simply loop over the data <span class="ot">and</span> <span class="kw">do</span> exactly what you want to <span class="kw">do</span>.</span>
<span id="cb61-754"><a href="#cb61-754"></a></span>
<span id="cb61-755"><a href="#cb61-755"></a>:::</span>
<span id="cb61-756"><a href="#cb61-756"></a></span>
<span id="cb61-757"><a href="#cb61-757"></a>::: {.g<span class="ot">-c</span>ol<span class="dv">-6</span>}</span>
<span id="cb61-758"><a href="#cb61-758"></a></span>
<span id="cb61-759"><a href="#cb61-759"></a>In R, I <span class="fu">use</span> the utility <span class="ot">`</span><span class="st">tlag</span><span class="ot">`</span> <span class="ot">and</span> <span class="ot">`</span><span class="st">tlead</span><span class="ot">`</span> from <span class="ot">`</span><span class="st">statar</span><span class="ot">`</span> which lags based on date intervals. </span>
<span id="cb61-760"><a href="#cb61-760"></a></span>
<span id="cb61-761"><a href="#cb61-761"></a>:::</span>
<span id="cb61-762"><a href="#cb61-762"></a></span>
<span id="cb61-763"><a href="#cb61-763"></a>:::</span>
<span id="cb61-764"><a href="#cb61-764"></a></span>
<span id="cb61-765"><a href="#cb61-765"></a>::: {.grid}</span>
<span id="cb61-766"><a href="#cb61-766"></a></span>
<span id="cb61-767"><a href="#cb61-767"></a>::: {.g<span class="ot">-c</span>ol<span class="dv">-6</span>}</span>
<span id="cb61-768"><a href="#cb61-768"></a><span class="ot">```</span><span class="st">{.julia}</span></span>
<span id="cb61-769"><a href="#cb61-769"></a><span class="dt">@rtransform</span><span class="st">!(dat, :date = Date(:year, :month, :day) )</span></span>
<span id="cb61-770"><a href="#cb61-770"></a><span class="st">dat_shift = </span><span class="dt">@combine</span><span class="st">(groupby(dat, [:origin, :date]), :arr_delay = mean(:arr_delay) )</span></span>
<span id="cb61-771"><a href="#cb61-771"></a></span>
<span id="cb61-772"><a href="#cb61-772"></a><span class="st"># I could not find a built-in function, but julia is amenable to loops</span></span>
<span id="cb61-773"><a href="#cb61-773"></a><span class="st">dat_shift.l3m_arr_delay = Array{Union{Missing,Float64}}(undef, nrow(dat_shift));</span></span>
<span id="cb61-774"><a href="#cb61-774"></a><span class="st">for subdf in groupby(dat_shift, :origin)    </span></span>
<span id="cb61-775"><a href="#cb61-775"></a><span class="st">    for date_iter in subdf.date</span></span>
<span id="cb61-776"><a href="#cb61-776"></a><span class="st">           idx = isequal.(subdf.date, date_iter - Dates.Month(3))</span></span>
<span id="cb61-777"><a href="#cb61-777"></a><span class="st">        if (sum(idx)==1)</span></span>
<span id="cb61-778"><a href="#cb61-778"></a><span class="st">            subdf[ subdf.date .== date_iter, :l3m_arr_delay] .= subdf[idx, :arr_delay]</span></span>
<span id="cb61-779"><a href="#cb61-779"></a><span class="st">        end</span></span>
<span id="cb61-780"><a href="#cb61-780"></a><span class="st">    end</span></span>
<span id="cb61-781"><a href="#cb61-781"></a><span class="st">end</span></span>
<span id="cb61-782"><a href="#cb61-782"></a><span class="st"># sort(dat_shift, [:origin, :date])</span></span>
<span id="cb61-783"><a href="#cb61-783"></a></span>
<span id="cb61-784"><a href="#cb61-784"></a><span class="st"># using PanelShift</span></span>
<span id="cb61-785"><a href="#cb61-785"></a><span class="dt">@transform</span><span class="st">!(groupby(dat_shift, :origin),</span></span>
<span id="cb61-786"><a href="#cb61-786"></a><span class="st">    :l3m_arr_delay = tlag(:date, :arr_delay, Month(3) ) )</span></span>
<span id="cb61-787"><a href="#cb61-787"></a><span class="st">panellag!(dat_shift, :origin, :date, </span></span>
<span id="cb61-788"><a href="#cb61-788"></a><span class="st">    :arr_delay, :l3m_arr_delay, Month(3))</span></span>
<span id="cb61-789"><a href="#cb61-789"></a><span class="ot">```</span></span>
<span id="cb61-790"><a href="#cb61-790"></a>:::</span>
<span id="cb61-791"><a href="#cb61-791"></a></span>
<span id="cb61-792"><a href="#cb61-792"></a>::: {.g<span class="ot">-c</span>ol<span class="dv">-6</span>}</span>
<span id="cb61-793"><a href="#cb61-793"></a><span class="ot">```</span><span class="st">{.r}</span></span>
<span id="cb61-794"><a href="#cb61-794"></a><span class="st">dat_shift = dat[, .(arr_delay = mean(arr_delay, na.rm=T)), </span></span>
<span id="cb61-795"><a href="#cb61-795"></a><span class="st">    by = .(origin, date=parse_date_time2(paste(year, month, day, sep="-""), "Y-m-d"))]</span></span>
<span id="cb61-796"><a href="#cb61-796"></a></span>
<span id="cb61-797"><a href="#cb61-797"></a><span class="st">dat_shift[, l3m_arr_delay := tlag(arr_delay, n=months(3), time=date), by = .(origin) ]</span></span>
<span id="cb61-798"><a href="#cb61-798"></a><span class="st"># setorder(dat_shift, origin, date)</span></span>
<span id="cb61-799"><a href="#cb61-799"></a><span class="ot">```</span></span>
<span id="cb61-800"><a href="#cb61-800"></a>:::</span>
<span id="cb61-801"><a href="#cb61-801"></a></span>
<span id="cb61-802"><a href="#cb61-802"></a>:::</span>
<span id="cb61-803"><a href="#cb61-803"></a></span>
<span id="cb61-804"><a href="#cb61-804"></a></span>
<span id="cb61-805"><a href="#cb61-805"></a></span>
<span id="cb61-806"><a href="#cb61-806"></a><span class="co">## Advanced examples</span></span>
<span id="cb61-807"><a href="#cb61-807"></a></span>
<span id="cb61-808"><a href="#cb61-808"></a><span class="co">#### Applying functions to multiple variables</span></span>
<span id="cb61-809"><a href="#cb61-809"></a></span>
<span id="cb61-810"><a href="#cb61-810"></a>::: {.grid}</span>
<span id="cb61-811"><a href="#cb61-811"></a>::: {.g<span class="ot">-c</span>ol<span class="dv">-6</span>}</span>
<span id="cb61-812"><a href="#cb61-812"></a>:::</span>
<span id="cb61-813"><a href="#cb61-813"></a></span>
<span id="cb61-814"><a href="#cb61-814"></a>::: {.g<span class="ot">-c</span>ol<span class="dv">-6</span>}</span>
<span id="cb61-815"><a href="#cb61-815"></a>- Loops: <span class="kw">if</span> you have to <span class="fu">use</span> loops <span class="kw">for</span> convenience, data.table provides <span class="ot">`</span><span class="st">set</span><span class="ot">`</span> which allows to change <span class="fu">values</span> withouth the overhead of data.table. The syntax is of the form <span class="ot">`</span><span class="st">set(dat, i, j,value)</span><span class="ot">`</span>, where <span class="ot">`</span><span class="st">i</span><span class="ot">`</span> is the row <span class="fu">index</span>, <span class="ot">and</span> <span class="ot">`</span><span class="st">j</span><span class="ot">`</span> the column <span class="fu">index</span> (<span class="ot">or</span> name).</span>
<span id="cb61-816"><a href="#cb61-816"></a>:::</span>
<span id="cb61-817"><a href="#cb61-817"></a>:::</span>
<span id="cb61-818"><a href="#cb61-818"></a></span>
<span id="cb61-819"><a href="#cb61-819"></a></span>
<span id="cb61-820"><a href="#cb61-820"></a>::: {.grid}</span>
<span id="cb61-821"><a href="#cb61-821"></a>::: {.g<span class="ot">-c</span>ol<span class="dv">-6</span>}</span>
<span id="cb61-822"><a href="#cb61-822"></a><span class="ot">```</span><span class="st">{.julia}</span></span>
<span id="cb61-823"><a href="#cb61-823"></a><span class="st"># Loops</span></span>
<span id="cb61-824"><a href="#cb61-824"></a><span class="st">for col in (:tot_delay, :dep_delay) </span></span>
<span id="cb61-825"><a href="#cb61-825"></a><span class="st">    dat[1:10, col] = - dat[1:10, col]</span></span>
<span id="cb61-826"><a href="#cb61-826"></a><span class="st">end</span></span>
<span id="cb61-827"><a href="#cb61-827"></a></span>
<span id="cb61-828"><a href="#cb61-828"></a><span class="st"># Control flows </span></span>
<span id="cb61-829"><a href="#cb61-829"></a><span class="dt">@rtransform</span><span class="st">!(dat, :arr_delay_penaly = ifelse(:arr_delay&gt;12, 1, -1) )</span></span>
<span id="cb61-830"><a href="#cb61-830"></a><span class="dt">@rtransform</span><span class="st">!(dat, :arr_delay_penaly = ifelse( # no case function in julia</span></span>
<span id="cb61-831"><a href="#cb61-831"></a><span class="st">    :arr_delay&gt;=15, 3, </span></span>
<span id="cb61-832"><a href="#cb61-832"></a><span class="st">    ifelse(:arr_delay&gt;=6, 2, </span></span>
<span id="cb61-833"><a href="#cb61-833"></a><span class="st">    ifelse(:arr_delay&gt;=0, 1, 0) ) ) )     </span></span>
<span id="cb61-834"><a href="#cb61-834"></a></span>
<span id="cb61-835"><a href="#cb61-835"></a><span class="st"># Modify multiple variables at the same time (same function)</span></span>
<span id="cb61-836"><a href="#cb61-836"></a><span class="st">cols = [:origin, :dest]</span></span>
<span id="cb61-837"><a href="#cb61-837"></a><span class="st">transform!(dat, cols .=&gt; (x -&gt; x .* "Airport") .=&gt; cols)</span></span>
<span id="cb61-838"><a href="#cb61-838"></a></span>
<span id="cb61-839"><a href="#cb61-839"></a></span>
<span id="cb61-840"><a href="#cb61-840"></a><span class="st"># Function of multiple variables (by rows)</span></span>
<span id="cb61-841"><a href="#cb61-841"></a><span class="st">ratio_airtime(x::NamedTuple) = (x[1] /(x[1]+x[2]))</span></span>
<span id="cb61-842"><a href="#cb61-842"></a><span class="dt">@rtransform</span><span class="st">! dat :frac_air = ratio_airtime(AsTable([:air_time, :tot_delay]))</span></span>
<span id="cb61-843"><a href="#cb61-843"></a><span class="st">ratio_airtime(x, y) = (x /(x+y))</span></span>
<span id="cb61-844"><a href="#cb61-844"></a><span class="st">transform(dat, [:air_time, :tot_delay] =&gt; ByRow((ratio_airtime)) =&gt; :frac_air)</span></span>
<span id="cb61-845"><a href="#cb61-845"></a><span class="ot">```</span></span>
<span id="cb61-846"><a href="#cb61-846"></a>::: </span>
<span id="cb61-847"><a href="#cb61-847"></a></span>
<span id="cb61-848"><a href="#cb61-848"></a>::: {.g<span class="ot">-c</span>ol<span class="dv">-6</span>}</span>
<span id="cb61-849"><a href="#cb61-849"></a><span class="ot">```</span><span class="st">{.r}</span></span>
<span id="cb61-850"><a href="#cb61-850"></a><span class="st"># Loops</span></span>
<span id="cb61-851"><a href="#cb61-851"></a><span class="st">for (j in c("tot_delay", "dep_delay")){ # (faster) loops </span></span>
<span id="cb61-852"><a href="#cb61-852"></a><span class="st">    set(dat, 1:10, j=j, value=-dat[1:10][[j]])</span></span>
<span id="cb61-853"><a href="#cb61-853"></a><span class="st">}</span></span>
<span id="cb61-854"><a href="#cb61-854"></a></span>
<span id="cb61-855"><a href="#cb61-855"></a><span class="st"># Control flows </span></span>
<span id="cb61-856"><a href="#cb61-856"></a><span class="st">dat[, arr_delay_penaly := fifelse(arr_delay&gt;12, 1, -1) ]</span></span>
<span id="cb61-857"><a href="#cb61-857"></a><span class="st">dat[, arr_delay_penaly := fcase(arr_delay&gt;=15, 3, </span></span>
<span id="cb61-858"><a href="#cb61-858"></a><span class="st">                                arr_delay&gt;=6,  2,</span></span>
<span id="cb61-859"><a href="#cb61-859"></a><span class="st">                                arr_delay&gt;=0,  1,</span></span>
<span id="cb61-860"><a href="#cb61-860"></a><span class="st">                                default = 0) ]</span></span>
<span id="cb61-861"><a href="#cb61-861"></a></span>
<span id="cb61-862"><a href="#cb61-862"></a><span class="st"># Modify multiple variables at the same time</span></span>
<span id="cb61-863"><a href="#cb61-863"></a><span class="st">cols = c("origin", "dest")</span></span>
<span id="cb61-864"><a href="#cb61-864"></a><span class="st">dat[, (cols) := lapply(.SD, \(x) paste(x,"Airport")), </span></span>
<span id="cb61-865"><a href="#cb61-865"></a><span class="st">    .SDcols = cols]   </span></span>
<span id="cb61-866"><a href="#cb61-866"></a></span>
<span id="cb61-867"><a href="#cb61-867"></a><span class="st"># Function of multiple variables </span></span>
<span id="cb61-868"><a href="#cb61-868"></a><span class="st">dat[, tot_delay := rowSums(.SD), .SDcols=patterns('*_delay')]</span></span>
<span id="cb61-869"><a href="#cb61-869"></a><span class="st">ratio_airtime = function(air, tot)  (air /(air+tot))</span></span>
<span id="cb61-870"><a href="#cb61-870"></a><span class="st"># dat[, frac_air := ratio_airtime(air_time, tot_delay) ]</span></span>
<span id="cb61-871"><a href="#cb61-871"></a><span class="st">dat[, frac_air := ratio_airtime(air_time, tot_delay), by=.I] # row-wise operation</span></span>
<span id="cb61-872"><a href="#cb61-872"></a></span>
<span id="cb61-873"><a href="#cb61-873"></a><span class="ot">```</span></span>
<span id="cb61-874"><a href="#cb61-874"></a>:::</span>
<span id="cb61-875"><a href="#cb61-875"></a>:::</span>
<span id="cb61-876"><a href="#cb61-876"></a></span>
<span id="cb61-877"><a href="#cb61-877"></a></span>
<span id="cb61-878"><a href="#cb61-878"></a></span>
<span id="cb61-879"><a href="#cb61-879"></a></span>
<span id="cb61-880"><a href="#cb61-880"></a><span class="co">#### Applying complex functions</span></span>
<span id="cb61-881"><a href="#cb61-881"></a></span>
<span id="cb61-882"><a href="#cb61-882"></a></span>
<span id="cb61-883"><a href="#cb61-883"></a>::: {.grid}</span>
<span id="cb61-884"><a href="#cb61-884"></a>::: {.g<span class="ot">-c</span>ol<span class="dv">-6</span>}</span>
<span id="cb61-885"><a href="#cb61-885"></a><span class="ot">```</span><span class="st">{.julia}</span></span>
<span id="cb61-886"><a href="#cb61-886"></a><span class="st"># Regressions by groups</span></span>
<span id="cb61-887"><a href="#cb61-887"></a><span class="st"># using FixedEffectModels</span></span>
<span id="cb61-888"><a href="#cb61-888"></a><span class="st">for subdf in groupby(dat, [:year, :month])</span></span>
<span id="cb61-889"><a href="#cb61-889"></a><span class="st">    reg_res = reg(subdf, </span><span class="dt">@formula</span><span class="st">(tot_delay ~ air_time))</span></span>
<span id="cb61-890"><a href="#cb61-890"></a><span class="st">    subdf[:, :β] .= coef(reg_res)[2]</span></span>
<span id="cb61-891"><a href="#cb61-891"></a><span class="st">    subdf[: , :σ] .= sqrt.(vcov(reg_res)[2,2])</span></span>
<span id="cb61-892"><a href="#cb61-892"></a><span class="st">end</span></span>
<span id="cb61-893"><a href="#cb61-893"></a><span class="st">select(dat, [:year, :month, :β, :σ]) |&gt; unique</span></span>
<span id="cb61-894"><a href="#cb61-894"></a></span>
<span id="cb61-895"><a href="#cb61-895"></a></span>
<span id="cb61-896"><a href="#cb61-896"></a></span>
<span id="cb61-897"><a href="#cb61-897"></a></span>
<span id="cb61-898"><a href="#cb61-898"></a></span>
<span id="cb61-899"><a href="#cb61-899"></a></span>
<span id="cb61-900"><a href="#cb61-900"></a><span class="ot">```</span></span>
<span id="cb61-901"><a href="#cb61-901"></a>:::</span>
<span id="cb61-902"><a href="#cb61-902"></a></span>
<span id="cb61-903"><a href="#cb61-903"></a>::: {.g<span class="ot">-c</span>ol<span class="dv">-6</span>}</span>
<span id="cb61-904"><a href="#cb61-904"></a><span class="ot">```</span><span class="st">{.r}</span></span>
<span id="cb61-905"><a href="#cb61-905"></a><span class="st"># Regressions by groups</span></span>
<span id="cb61-906"><a href="#cb61-906"></a><span class="st">dat_reg = dat[, .(</span></span>
<span id="cb61-907"><a href="#cb61-907"></a><span class="st">    {</span></span>
<span id="cb61-908"><a href="#cb61-908"></a><span class="st">        y = as.matrix(.SD[["tot_delay"]]) </span></span>
<span id="cb61-909"><a href="#cb61-909"></a><span class="st">        x = as.matrix(cbind(1, .SD[["air_time"]]) )</span></span>
<span id="cb61-910"><a href="#cb61-910"></a><span class="st">        reg_res = lm.fit(x, y)</span></span>
<span id="cb61-911"><a href="#cb61-911"></a><span class="st">        b = coefficients(reg_res)[2]</span></span>
<span id="cb61-912"><a href="#cb61-912"></a><span class="st">        se = sqrt(sum(reg_res[["residuals"]]^2) / var(.SD[["air_time"]]) ) / .N</span></span>
<span id="cb61-913"><a href="#cb61-913"></a><span class="st">        c(b,se)</span></span>
<span id="cb61-914"><a href="#cb61-914"></a><span class="st">    }, </span></span>
<span id="cb61-915"><a href="#cb61-915"></a><span class="st">    seq(1,2) ),</span></span>
<span id="cb61-916"><a href="#cb61-916"></a><span class="st">    by = .(year, month) ]</span></span>
<span id="cb61-917"><a href="#cb61-917"></a><span class="st">dcast(dat_reg, year + month ~ V2, value.var="V1") # anticipating on reshape section</span></span>
<span id="cb61-918"><a href="#cb61-918"></a><span class="ot">```</span></span>
<span id="cb61-919"><a href="#cb61-919"></a>:::</span>
<span id="cb61-920"><a href="#cb61-920"></a>:::</span>
<span id="cb61-921"><a href="#cb61-921"></a></span>
<span id="cb61-922"><a href="#cb61-922"></a></span>
<span id="cb61-923"><a href="#cb61-923"></a>&lt;!-- ----------------------------------------------------------------------------------- --&gt;</span>
<span id="cb61-924"><a href="#cb61-924"></a></span>
<span id="cb61-925"><a href="#cb61-925"></a></span>
<span id="cb61-926"><a href="#cb61-926"></a>&lt;!-- ----------------------------------------------------------------------------------- --&gt;</span>
<span id="cb61-927"><a href="#cb61-927"></a><span class="co"># Aggregating</span></span>
<span id="cb61-928"><a href="#cb61-928"></a></span>
<span id="cb61-929"><a href="#cb61-929"></a></span>
<span id="cb61-930"><a href="#cb61-930"></a>::: {.grid}</span>
<span id="cb61-931"><a href="#cb61-931"></a>::: {.g<span class="ot">-c</span>ol<span class="dv">-6</span>}</span>
<span id="cb61-932"><a href="#cb61-932"></a><span class="ot">```</span><span class="st">{.julia}</span></span>
<span id="cb61-933"><a href="#cb61-933"></a><span class="dt">@combine</span><span class="st">(dat, :mean_dep_delay = mean(:dep_delay))</span></span>
<span id="cb61-934"><a href="#cb61-934"></a></span>
<span id="cb61-935"><a href="#cb61-935"></a><span class="dt">@combine</span><span class="st">(dat, :mean_dep_delay = mean(:dep_delay), :mean_arr_delay = mean(:arr_delay))</span></span>
<span id="cb61-936"><a href="#cb61-936"></a><span class="st">combine(dat, [:dep_delay, :arr_delay] .=&gt; mean .=&gt; [:mean_dep_delay, :mean_arr_elay])</span></span>
<span id="cb61-937"><a href="#cb61-937"></a><span class="dt">@combine</span><span class="st">(dat, </span><span class="dt">$AsTable</span><span class="st"> = mean.([:dep_delay, :arr_delay]))</span></span>
<span id="cb61-938"><a href="#cb61-938"></a><span class="dt">@combine</span><span class="st">(dat, </span><span class="wa">$(</span><span class="st">[:dep_delay, :arr_delay] .=&gt; mean) )</span></span>
<span id="cb61-939"><a href="#cb61-939"></a><span class="ot">```</span></span>
<span id="cb61-940"><a href="#cb61-940"></a>:::</span>
<span id="cb61-941"><a href="#cb61-941"></a></span>
<span id="cb61-942"><a href="#cb61-942"></a>::: {.g<span class="ot">-c</span>ol<span class="dv">-6</span>}</span>
<span id="cb61-943"><a href="#cb61-943"></a><span class="ot">```</span><span class="st">{.r}</span></span>
<span id="cb61-944"><a href="#cb61-944"></a><span class="st">dat[, mean(dep_delay)] # returns a scalar</span></span>
<span id="cb61-945"><a href="#cb61-945"></a><span class="st">dat[, .(mean_ddel = mean(dep_delay))] # returns a data.table</span></span>
<span id="cb61-946"><a href="#cb61-946"></a><span class="st">dat[, .(mean_ddel=mean(dep_delay), mean_adel=mean(arr_delay))]</span></span>
<span id="cb61-947"><a href="#cb61-947"></a><span class="st">dat[, lapply(.SD, mean), .SDcols=c('arr_delay','dep_delay')] </span></span>
<span id="cb61-948"><a href="#cb61-948"></a><span class="ot">```</span></span>
<span id="cb61-949"><a href="#cb61-949"></a>:::</span>
<span id="cb61-950"><a href="#cb61-950"></a>:::</span>
<span id="cb61-951"><a href="#cb61-951"></a></span>
<span id="cb61-952"><a href="#cb61-952"></a></span>
<span id="cb61-953"><a href="#cb61-953"></a></span>
<span id="cb61-954"><a href="#cb61-954"></a>&lt;!-- ----------------------------------------------------------------------------------- --&gt;</span>
<span id="cb61-955"><a href="#cb61-955"></a></span>
<span id="cb61-956"><a href="#cb61-956"></a></span>
<span id="cb61-957"><a href="#cb61-957"></a>&lt;!-- ----------------------------------------------------------------------------------- --&gt;</span>
<span id="cb61-958"><a href="#cb61-958"></a><span class="co"># Reshape</span></span>
<span id="cb61-959"><a href="#cb61-959"></a></span>
<span id="cb61-960"><a href="#cb61-960"></a><span class="co">#### Wide to long</span></span>
<span id="cb61-961"><a href="#cb61-961"></a></span>
<span id="cb61-962"><a href="#cb61-962"></a>::: {.grid}</span>
<span id="cb61-963"><a href="#cb61-963"></a></span>
<span id="cb61-964"><a href="#cb61-964"></a>::: {.g<span class="ot">-c</span>ol<span class="dv">-6</span>}</span>
<span id="cb61-965"><a href="#cb61-965"></a>Julia uses <span class="ot">`</span><span class="st">stack</span><span class="ot">`</span> <span class="kw">for</span> going from wide to long.</span>
<span id="cb61-966"><a href="#cb61-966"></a></span>
<span id="cb61-967"><a href="#cb61-967"></a><span class="ot">```</span><span class="st">{.julia}</span></span>
<span id="cb61-968"><a href="#cb61-968"></a><span class="st"># It is easier if we give all the flights a unique identifier </span></span>
<span id="cb61-969"><a href="#cb61-969"></a><span class="dt">@transform</span><span class="st">!(dat, :uid = 1:nrow(dat))</span></span>
<span id="cb61-970"><a href="#cb61-970"></a><span class="st">stack(dat, [:dep_delay, :arr_delay] )</span></span>
<span id="cb61-971"><a href="#cb61-971"></a><span class="st">stack(dat, r"_delay")</span></span>
<span id="cb61-972"><a href="#cb61-972"></a><span class="st">dat_long = stack(dat, </span></span>
<span id="cb61-973"><a href="#cb61-973"></a><span class="st">    [:dep_delay, :arr_delay], </span></span>
<span id="cb61-974"><a href="#cb61-974"></a><span class="st">    [:uid, :carrier, :origin, :dest])</span></span>
<span id="cb61-975"><a href="#cb61-975"></a><span class="ot">```</span></span>
<span id="cb61-976"><a href="#cb61-976"></a></span>
<span id="cb61-977"><a href="#cb61-977"></a>:::</span>
<span id="cb61-978"><a href="#cb61-978"></a></span>
<span id="cb61-979"><a href="#cb61-979"></a>::: {.g<span class="ot">-c</span>ol<span class="dv">-6</span>}</span>
<span id="cb61-980"><a href="#cb61-980"></a>In data.table, we <span class="fu">use</span> the built-in tool <span class="ot">`</span><span class="st">melt</span><span class="ot">`</span> <span class="kw">for</span> going from wide to long.</span>
<span id="cb61-981"><a href="#cb61-981"></a></span>
<span id="cb61-982"><a href="#cb61-982"></a><span class="ot">```</span><span class="st">{.r}</span></span>
<span id="cb61-983"><a href="#cb61-983"></a><span class="st"># It is easier if we give all the flights a unique identifier </span></span>
<span id="cb61-984"><a href="#cb61-984"></a><span class="st">dat[, uid := seq(1, .N) ]</span></span>
<span id="cb61-985"><a href="#cb61-985"></a><span class="st">melt(dat, measure=c("dep_delay", "arr_delay"))</span></span>
<span id="cb61-986"><a href="#cb61-986"></a><span class="st">melt(dat, measure=patterns('_delay'))</span></span>
<span id="cb61-987"><a href="#cb61-987"></a><span class="st">dat_long = melt(dat, </span></span>
<span id="cb61-988"><a href="#cb61-988"></a><span class="st">    measure=c("dep_delay", "arr_delay"),</span></span>
<span id="cb61-989"><a href="#cb61-989"></a><span class="st">    id.vars=c("uid", "carrier", "origin", "dest"))</span></span>
<span id="cb61-990"><a href="#cb61-990"></a><span class="ot">```</span></span>
<span id="cb61-991"><a href="#cb61-991"></a>:::</span>
<span id="cb61-992"><a href="#cb61-992"></a></span>
<span id="cb61-993"><a href="#cb61-993"></a>:::</span>
<span id="cb61-994"><a href="#cb61-994"></a></span>
<span id="cb61-995"><a href="#cb61-995"></a><span class="co">#### Long to wide</span></span>
<span id="cb61-996"><a href="#cb61-996"></a></span>
<span id="cb61-997"><a href="#cb61-997"></a>::: {.grid}</span>
<span id="cb61-998"><a href="#cb61-998"></a>::: {.g<span class="ot">-c</span>ol<span class="dv">-6</span>}</span>
<span id="cb61-999"><a href="#cb61-999"></a>Julia uses <span class="ot">`</span><span class="st">unstack</span><span class="ot">`</span> <span class="kw">for</span> going from long to wide.</span>
<span id="cb61-1000"><a href="#cb61-1000"></a></span>
<span id="cb61-1001"><a href="#cb61-1001"></a><span class="ot">```</span><span class="st">{.julia}</span></span>
<span id="cb61-1002"><a href="#cb61-1002"></a><span class="st"># We start with the long data from above</span></span>
<span id="cb61-1003"><a href="#cb61-1003"></a><span class="st">dat_wide = unstack(dat_long)</span></span>
<span id="cb61-1004"><a href="#cb61-1004"></a><span class="st"># If you only want to keep the id &amp; *_delay cols</span></span>
<span id="cb61-1005"><a href="#cb61-1005"></a><span class="st">unstack(dat_long, :uid, :variable, :value)</span></span>
<span id="cb61-1006"><a href="#cb61-1006"></a><span class="ot">```</span></span>
<span id="cb61-1007"><a href="#cb61-1007"></a>:::</span>
<span id="cb61-1008"><a href="#cb61-1008"></a></span>
<span id="cb61-1009"><a href="#cb61-1009"></a>::: {.g<span class="ot">-c</span>ol<span class="dv">-6</span>}</span>
<span id="cb61-1010"><a href="#cb61-1010"></a>In data.table, we <span class="fu">use</span> the built-in tool <span class="ot">`</span><span class="st">dcast</span><span class="ot">`</span> <span class="kw">for</span> going from long to wide.</span>
<span id="cb61-1011"><a href="#cb61-1011"></a></span>
<span id="cb61-1012"><a href="#cb61-1012"></a><span class="ot">```</span><span class="st">{.r}</span></span>
<span id="cb61-1013"><a href="#cb61-1013"></a><span class="st"># We start with the long data from above</span></span>
<span id="cb61-1014"><a href="#cb61-1014"></a><span class="st">dat_wide = dcast(dat_long, ... ~ variable)</span></span>
<span id="cb61-1015"><a href="#cb61-1015"></a><span class="st"># If you only want to keep the id &amp; *_delay cols</span></span>
<span id="cb61-1016"><a href="#cb61-1016"></a><span class="st">dcast(dat_long, uid ~ variable)</span></span>
<span id="cb61-1017"><a href="#cb61-1017"></a><span class="ot">```</span></span>
<span id="cb61-1018"><a href="#cb61-1018"></a>:::</span>
<span id="cb61-1019"><a href="#cb61-1019"></a>:::</span>
<span id="cb61-1020"><a href="#cb61-1020"></a></span>
<span id="cb61-1021"><a href="#cb61-1021"></a></span>
<span id="cb61-1022"><a href="#cb61-1022"></a></span>
<span id="cb61-1023"><a href="#cb61-1023"></a></span>
<span id="cb61-1024"><a href="#cb61-1024"></a>&lt;!-- ----------------------------------------------------------------------------------- --&gt;</span>
<span id="cb61-1025"><a href="#cb61-1025"></a></span>
<span id="cb61-1026"><a href="#cb61-1026"></a></span>
<span id="cb61-1027"><a href="#cb61-1027"></a>&lt;!-- ----------------------------------------------------------------------------------- --&gt;</span>
<span id="cb61-1028"><a href="#cb61-1028"></a><span class="co"># Merge</span></span>
<span id="cb61-1029"><a href="#cb61-1029"></a></span>
<span id="cb61-1030"><a href="#cb61-1030"></a><span class="co">## Basic merge</span></span>
<span id="cb61-1031"><a href="#cb61-1031"></a></span>
<span id="cb61-1032"><a href="#cb61-1032"></a>::: {.grid}</span>
<span id="cb61-1033"><a href="#cb61-1033"></a>::: {.g<span class="ot">-c</span>ol<span class="dv">-6</span>}</span>
<span id="cb61-1034"><a href="#cb61-1034"></a><span class="ot">```</span><span class="st">{.julia}</span></span>
<span id="cb61-1035"><a href="#cb61-1035"></a><span class="st"># Load second dataset</span></span>
<span id="cb61-1036"><a href="#cb61-1036"></a><span class="st">dat_airports = CSV.read(</span></span>
<span id="cb61-1037"><a href="#cb61-1037"></a><span class="st">    HTTP.get("https://vincentarelbundock.github.io/Rdatasets/csv/nycflights13/airports.csv").body,</span></span>
<span id="cb61-1038"><a href="#cb61-1038"></a><span class="st">    DataFrame) </span></span>
<span id="cb61-1039"><a href="#cb61-1039"></a></span>
<span id="cb61-1040"><a href="#cb61-1040"></a><span class="st"># Inner join</span></span>
<span id="cb61-1041"><a href="#cb61-1041"></a><span class="st">innerjoin(dat, dat_airports, on = :dest =&gt; :faa)</span></span>
<span id="cb61-1042"><a href="#cb61-1042"></a><span class="st"># if the datasets share a common name for the merge variable</span></span>
<span id="cb61-1043"><a href="#cb61-1043"></a><span class="dt">@rename</span><span class="st">!(dat_airports, :dest = :faa)</span></span>
<span id="cb61-1044"><a href="#cb61-1044"></a><span class="st">innerjoin(dat, dat_airports, on = :dest)</span></span>
<span id="cb61-1045"><a href="#cb61-1045"></a></span>
<span id="cb61-1046"><a href="#cb61-1046"></a><span class="st"># with missing values</span></span>
<span id="cb61-1047"><a href="#cb61-1047"></a><span class="st">innerjoin(dat, dat_airports, on = :dest; matchmissing=:equal)</span></span>
<span id="cb61-1048"><a href="#cb61-1048"></a></span>
<span id="cb61-1049"><a href="#cb61-1049"></a><span class="st"># Other types of merge</span></span>
<span id="cb61-1050"><a href="#cb61-1050"></a><span class="st"># Left join</span></span>
<span id="cb61-1051"><a href="#cb61-1051"></a><span class="st">leftjoin(dat, dat_airports, on = :dest)</span></span>
<span id="cb61-1052"><a href="#cb61-1052"></a><span class="st">leftjoin(dat, dat_airports, on = :dest, source="_merge") # stata style merge info</span></span>
<span id="cb61-1053"><a href="#cb61-1053"></a><span class="st"># Right join</span></span>
<span id="cb61-1054"><a href="#cb61-1054"></a><span class="st">rightjoin(dat, dat_airports, on = :dest)</span></span>
<span id="cb61-1055"><a href="#cb61-1055"></a><span class="st"># Outer join</span></span>
<span id="cb61-1056"><a href="#cb61-1056"></a><span class="st">outerjoin(dat, dat_airports, on = :dest)</span></span>
<span id="cb61-1057"><a href="#cb61-1057"></a><span class="st"># Semi join (filtering)</span></span>
<span id="cb61-1058"><a href="#cb61-1058"></a><span class="st">semijoin(dat, dat_airports, on = :dest)</span></span>
<span id="cb61-1059"><a href="#cb61-1059"></a><span class="st"># Anti join</span></span>
<span id="cb61-1060"><a href="#cb61-1060"></a><span class="st">antijoin(dat, dat_airports, on = :dest)</span></span>
<span id="cb61-1061"><a href="#cb61-1061"></a><span class="st"># Cross join</span></span>
<span id="cb61-1062"><a href="#cb61-1062"></a><span class="st">crossjoin(unique(select(dat, :origin)), unique(select(dat, :dest)) )</span></span>
<span id="cb61-1063"><a href="#cb61-1063"></a><span class="ot">```</span></span>
<span id="cb61-1064"><a href="#cb61-1064"></a>:::</span>
<span id="cb61-1065"><a href="#cb61-1065"></a></span>
<span id="cb61-1066"><a href="#cb61-1066"></a>::: {.g<span class="ot">-c</span>ol<span class="dv">-6</span>}</span>
<span id="cb61-1067"><a href="#cb61-1067"></a><span class="ot">```</span><span class="st">{.r}</span></span>
<span id="cb61-1068"><a href="#cb61-1068"></a><span class="st"># Load second dataset</span></span>
<span id="cb61-1069"><a href="#cb61-1069"></a><span class="st">dat_airports = fread(</span></span>
<span id="cb61-1070"><a href="#cb61-1070"></a><span class="st">    "https://vincentarelbundock.github.io/Rdatasets/csv/nycflights13/airports.csv") </span></span>
<span id="cb61-1071"><a href="#cb61-1071"></a></span>
<span id="cb61-1072"><a href="#cb61-1072"></a></span>
<span id="cb61-1073"><a href="#cb61-1073"></a><span class="st"># Inner join (default)</span></span>
<span id="cb61-1074"><a href="#cb61-1074"></a><span class="st">merge(dat, dat_airports, by.x = c("dest"), by.y = c("faa"))</span></span>
<span id="cb61-1075"><a href="#cb61-1075"></a><span class="st"># if the datasets share a common name for the merge variable</span></span>
<span id="cb61-1076"><a href="#cb61-1076"></a><span class="st">setnames(dat_airports, c("faa"), c("dest"))</span></span>
<span id="cb61-1077"><a href="#cb61-1077"></a><span class="st">merge(dat, dat_airports, by = c("dest"))</span></span>
<span id="cb61-1078"><a href="#cb61-1078"></a></span>
<span id="cb61-1079"><a href="#cb61-1079"></a><span class="st"># with missing values</span></span>
<span id="cb61-1080"><a href="#cb61-1080"></a><span class="st">merge(dat, dat_airports, by = c("dest"))</span></span>
<span id="cb61-1081"><a href="#cb61-1081"></a></span>
<span id="cb61-1082"><a href="#cb61-1082"></a><span class="st"># Other types of merge</span></span>
<span id="cb61-1083"><a href="#cb61-1083"></a><span class="st"># Left join</span></span>
<span id="cb61-1084"><a href="#cb61-1084"></a><span class="st">merge(dat, dat_airports, by = c("dest"), all.x = TRUE)</span></span>
<span id="cb61-1085"><a href="#cb61-1085"></a></span>
<span id="cb61-1086"><a href="#cb61-1086"></a><span class="st"># Right join</span></span>
<span id="cb61-1087"><a href="#cb61-1087"></a><span class="st">merge(dat, dat_airports, by = c("dest"), all.y = TRUE)</span></span>
<span id="cb61-1088"><a href="#cb61-1088"></a><span class="st"># Outer join</span></span>
<span id="cb61-1089"><a href="#cb61-1089"></a><span class="st">merge(dat, dat_airports, by = c("dest"), all.x = TRUE, all.y = TRUE)</span></span>
<span id="cb61-1090"><a href="#cb61-1090"></a><span class="st"># Semi join (filtering)</span></span>
<span id="cb61-1091"><a href="#cb61-1091"></a><span class="st">merge(dat, dat_airports[, .(dest)], by = c("dest"))</span></span>
<span id="cb61-1092"><a href="#cb61-1092"></a><span class="st"># Anti join</span></span>
<span id="cb61-1093"><a href="#cb61-1093"></a><span class="st">dat[fsetdiff(dat[, .(dest)], dat_airports[, .(dest)]), on = "dest"]</span></span>
<span id="cb61-1094"><a href="#cb61-1094"></a><span class="st"># Cross join</span></span>
<span id="cb61-1095"><a href="#cb61-1095"></a><span class="st">CJ(unique(dat[["origin"]]), unique(dat[["dest"]])) # all combination of origin and destinations</span></span>
<span id="cb61-1096"><a href="#cb61-1096"></a></span>
<span id="cb61-1097"><a href="#cb61-1097"></a><span class="ot">```</span></span>
<span id="cb61-1098"><a href="#cb61-1098"></a>:::</span>
<span id="cb61-1099"><a href="#cb61-1099"></a>:::</span>
<span id="cb61-1100"><a href="#cb61-1100"></a></span>
<span id="cb61-1101"><a href="#cb61-1101"></a><span class="co">## Advanced merging</span></span>
<span id="cb61-1102"><a href="#cb61-1102"></a></span>
<span id="cb61-1103"><a href="#cb61-1103"></a><span class="co">#### Non-equi joins</span></span>
<span id="cb61-1104"><a href="#cb61-1104"></a></span>
<span id="cb61-1105"><a href="#cb61-1105"></a>::: {.grid}</span>
<span id="cb61-1106"><a href="#cb61-1106"></a>::: {.g<span class="ot">-c</span>ol<span class="dv">-6</span>}</span>
<span id="cb61-1107"><a href="#cb61-1107"></a><span class="ot">```</span><span class="st">{.julia}</span></span>
<span id="cb61-1108"><a href="#cb61-1108"></a><span class="ot">```</span></span>
<span id="cb61-1109"><a href="#cb61-1109"></a>:::</span>
<span id="cb61-1110"><a href="#cb61-1110"></a></span>
<span id="cb61-1111"><a href="#cb61-1111"></a>::: {.g<span class="ot">-c</span>ol<span class="dv">-6</span>}</span>
<span id="cb61-1112"><a href="#cb61-1112"></a><span class="ot">```</span><span class="st">{.r}</span></span>
<span id="cb61-1113"><a href="#cb61-1113"></a><span class="st">dat3 = data.table(carrier     = c('AA', 'UA'),</span></span>
<span id="cb61-1114"><a href="#cb61-1114"></a><span class="st">                  start_month = c(1, 4),</span></span>
<span id="cb61-1115"><a href="#cb61-1115"></a><span class="st">                  end_month   = c(3, 6)) </span></span>
<span id="cb61-1116"><a href="#cb61-1116"></a></span>
<span id="cb61-1117"><a href="#cb61-1117"></a><span class="st"># Rolling join that catches everything between the distinct</span></span>
<span id="cb61-1118"><a href="#cb61-1118"></a><span class="st"># start and end dates for each carrier.</span></span>
<span id="cb61-1119"><a href="#cb61-1119"></a><span class="st">dat[dat3, on = .(carrier,</span></span>
<span id="cb61-1120"><a href="#cb61-1120"></a><span class="st">                 month &gt;= start_month,</span></span>
<span id="cb61-1121"><a href="#cb61-1121"></a><span class="st">                 month &lt;= end_month)] </span></span>
<span id="cb61-1122"><a href="#cb61-1122"></a><span class="ot">```</span></span>
<span id="cb61-1123"><a href="#cb61-1123"></a>:::</span>
<span id="cb61-1124"><a href="#cb61-1124"></a>:::</span>
<span id="cb61-1125"><a href="#cb61-1125"></a></span>
<span id="cb61-1126"><a href="#cb61-1126"></a><span class="co">#### Rolling joins</span></span>
<span id="cb61-1127"><a href="#cb61-1127"></a></span>
<span id="cb61-1128"><a href="#cb61-1128"></a>::: {.grid}</span>
<span id="cb61-1129"><a href="#cb61-1129"></a>::: {.g<span class="ot">-c</span>ol<span class="dv">-6</span>}</span>
<span id="cb61-1130"><a href="#cb61-1130"></a><span class="ot">```</span><span class="st">{.julia}</span></span>
<span id="cb61-1131"><a href="#cb61-1131"></a><span class="ot">```</span></span>
<span id="cb61-1132"><a href="#cb61-1132"></a>:::</span>
<span id="cb61-1133"><a href="#cb61-1133"></a></span>
<span id="cb61-1134"><a href="#cb61-1134"></a>::: {.g<span class="ot">-c</span>ol<span class="dv">-6</span>}</span>
<span id="cb61-1135"><a href="#cb61-1135"></a><span class="ot">```</span><span class="st">{.r}</span></span>
<span id="cb61-1136"><a href="#cb61-1136"></a></span>
<span id="cb61-1137"><a href="#cb61-1137"></a><span class="st"># Make sure we have a date variable</span></span>
<span id="cb61-1138"><a href="#cb61-1138"></a><span class="st">dat[, date := as.IDate(paste(year, month, day, sep='-'))] </span></span>
<span id="cb61-1139"><a href="#cb61-1139"></a></span>
<span id="cb61-1140"><a href="#cb61-1140"></a><span class="st"># New DT with the (random) target dates</span></span>
<span id="cb61-1141"><a href="#cb61-1141"></a><span class="st">dat4 = data.table(carrier  = c('AA', 'UA'),</span></span>
<span id="cb61-1142"><a href="#cb61-1142"></a><span class="st">                  new_date = as.IDate(c('2014-11-01', '2014-11-15'))) </span></span>
<span id="cb61-1143"><a href="#cb61-1143"></a></span>
<span id="cb61-1144"><a href="#cb61-1144"></a><span class="st"># Join on these target dates, so they take the last known value </span></span>
<span id="cb61-1145"><a href="#cb61-1145"></a><span class="st">dat[dat4, on = .(carrier, date=new_date), roll='nearest']</span></span>
<span id="cb61-1146"><a href="#cb61-1146"></a></span>
<span id="cb61-1147"><a href="#cb61-1147"></a><span class="ot">```</span></span>
<span id="cb61-1148"><a href="#cb61-1148"></a>:::</span>
<span id="cb61-1149"><a href="#cb61-1149"></a>:::</span>
<span id="cb61-1150"><a href="#cb61-1150"></a></span>
<span id="cb61-1151"><a href="#cb61-1151"></a><span class="co">#### Appending data</span></span>
<span id="cb61-1152"><a href="#cb61-1152"></a></span>
<span id="cb61-1153"><a href="#cb61-1153"></a>::: {.grid}</span>
<span id="cb61-1154"><a href="#cb61-1154"></a>::: {.g<span class="ot">-c</span>ol<span class="dv">-6</span>}</span>
<span id="cb61-1155"><a href="#cb61-1155"></a><span class="ot">```</span><span class="st">{.julia}</span></span>
<span id="cb61-1156"><a href="#cb61-1156"></a><span class="st">vcat(dat, dat)</span></span>
<span id="cb61-1157"><a href="#cb61-1157"></a><span class="st">vcat(dat, dat, cols=:union)</span></span>
<span id="cb61-1158"><a href="#cb61-1158"></a></span>
<span id="cb61-1159"><a href="#cb61-1159"></a></span>
<span id="cb61-1160"><a href="#cb61-1160"></a><span class="ot">```</span></span>
<span id="cb61-1161"><a href="#cb61-1161"></a>:::</span>
<span id="cb61-1162"><a href="#cb61-1162"></a></span>
<span id="cb61-1163"><a href="#cb61-1163"></a>::: {.g<span class="ot">-c</span>ol<span class="dv">-6</span>}</span>
<span id="cb61-1164"><a href="#cb61-1164"></a><span class="ot">```</span><span class="st">{.r}</span></span>
<span id="cb61-1165"><a href="#cb61-1165"></a><span class="st">rbindlist(list(dat, dat)) # useful if working with list (purrr)</span></span>
<span id="cb61-1166"><a href="#cb61-1166"></a><span class="st">rbindlist(list(dat, dat), fill = TRUE)</span></span>
<span id="cb61-1167"><a href="#cb61-1167"></a><span class="st">rbind(dat, dat, fill = TRUE)</span></span>
<span id="cb61-1168"><a href="#cb61-1168"></a><span class="ot">```</span></span>
<span id="cb61-1169"><a href="#cb61-1169"></a>:::</span>
<span id="cb61-1170"><a href="#cb61-1170"></a>:::</span>
<span id="cb61-1171"><a href="#cb61-1171"></a></span>
<span id="cb61-1172"><a href="#cb61-1172"></a></span>
<span id="cb61-1173"><a href="#cb61-1173"></a>&lt;!-- ----------------------------------------------------------------------------------- --&gt;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



</body></html>